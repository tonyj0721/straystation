<!doctype html>
<html lang="zh-Hant" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>浪浪轉運站｜貓狗送養平台</title>
  <meta name="description" content="浪浪轉運站：友善的貓狗送養平台。快速篩選、查看細節，手機與電腦版皆可用。" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png" sizes="16x16 32x32 64x64">
  <link rel="apple-touch-icon" href="favicon.png">
  <meta name="theme-color" content="#fcd34d">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#FFFBEB',
              100: '#FEF3C7',
              200: '#FDE68A',
              300: '#FCD34D',
              400: '#FBBF24',
              500: '#F59E0B',
              600: '#D97706',
              700: '#B45309',
              800: '#92400E',
              900: '#78350F'
            }
          }
        }
      }
    };
  </script>
  <style>
    html, body {
      overscroll-behavior: none;
    }
    body.modal-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
    /* Hide number input arrows */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    dialog::backdrop{ background: rgba(0,0,0,.5)}

    /* 🔥 Modal 主圖（admin 風格） */
    .modal-main-photo {
      width: 100%;
      max-height: 300px;
      border-radius: 10px;
      object-fit: contain;
      background-color: #f9f9f9;
      display: block;
      margin: 0 auto 8px auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    /* 🔥 Modal 縮圖（admin 風格） */
    .modal-photos {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(18%, 1fr));
      gap: 6px;
      margin-bottom: 12px;
      justify-items: center;
      align-items: center;
    }

    .dlg-thumb {
      width: 100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s;
    }
    .dlg-thumb.active {
      border-color: #f97316;
      transform: scale(1.02);
    }

    /* Modal info tag row（採用後台色系） */
    .modal-info {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 10px;
    }

    .modal-info span {
      background: #fff7ed;
      padding: 5px 12px;
      border-radius: 16px;
      color: #92400e;
      font-weight: 500;
      font-size: 0.95rem;
      white-space: nowrap;
    }

    /* 描述內容（admin 風格） */
    #dlgDesc {
      background: #fffaf4;
      padding: 10px 14px;
      border-radius: 8px;
      color: #444;
      font-size: 0.95rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      margin-top: 4px;
      margin-bottom: 16px;
    }

    /* Modal容器（套用 admin 的 padding/圓角） */
    .modal-content {
      background: #fff;
      padding: 20px 24px 16px;
      border-radius: 12px;
      width: 100%;
      max-width: 540px;
      margin: 16px auto;
      max-height: 88vh;
      overflow-y: auto;
      position: relative;
    }

    .close {
      position: absolute;
      right: 16px;
      top: 12px;
      font-size: 24px;
      color: #666;
      cursor: pointer;
      border: none;
      background: transparent;
      line-height: 1;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 8px;
    }

    .modal-actions button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
      font-size: 0.95rem;
    }

    .modal-actions button:hover {
      opacity: 0.9;
    }

    button.success {
      background-color: #16a34a;
    }

    button.edit {
      background-color: #f97316;
    }

    #lightbox {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      -webkit-backdrop-filter: none;
    }

    .tag-pill {
      border-radius: 999px;
      border: 1px solid #fed7aa;
      background: #fffbeb;
      font-size: 0.8rem;
      padding: 4px 9px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #92400e;
      white-space: nowrap;
    }
    .tag-pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #f97316;
    }
    .tag-pill-icon {
      font-size: 0.95em;
    }
    .tag-pill span {
      display: inline-block;
    }

    .lb-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      opacity: 0.6;
      border: 2px solid transparent;
      transition: 0.2s;
    }
    .lb-thumb.active {
      opacity: 1;
      border-color: white;
    }
    /* 讓圖片容器用同張圖做模糊延伸背景 */
    .blur-fit { position: relative; overflow: hidden; }
    .blur-fit::before{
      content:""; position:absolute; inset:0;
      background: var(--bg) center/cover no-repeat; /* 這裡吃 inline style 的 --bg */
      filter: blur(24px);
      transform: scale(1.1); /* 放大避免邊緣露白 */
    }
    .blur-fit > img{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit: contain; z-index:1; /* 上層放原圖，保持比例 */
    }
  
  </style>
</head>
<body class="bg-white text-gray-800">
  <!-- Navbar -->
  <header class="bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <a href="#" class="flex items-center gap-2 font-semibold text-lg">
          <img src="浪浪轉運站Logo.png" alt="浪浪轉運站 Logo"
               class="h-8 w-8 object-contain" />
          <span>浪浪轉運站 X 台中簡媽媽狗園</span>
        </a>
        <nav class="hidden md:flex items-center gap-6">
          <a href="cats.html" class="hover:text-brand-600">我想養貓咪</a>
          <a href="dogs.html" class="hover:text-brand-600">我想養狗狗</a>
          <a href="#faq" class="hover:text-brand-600">常見問題</a>
          <a href="#contact" class="hover:text-brand-600">聯絡我們</a>
          <a href="admin.html"
             class="inline-flex items-center gap-1 rounded-full border border-gray-300 px-3 py-1 text-xs text-gray-600 hover:bg-gray-50">
            <span class="material-symbols-outlined text-base">admin_panel_settings</span>
            <span>送養方入口</span>
          </a>
        </nav>
        <button id="navToggle" class="md:hidden p-2 rounded-md hover:bg-gray-100">
          <span class="material-symbols-outlined">menu</span>
        </button>
      </div>
    </div>
    <!-- Mobile nav -->
    <div id="mobileNav" class="md:hidden hidden border-t border-gray-100 bg-white">
      <nav class="px-4 py-3 space-y-2">
        <a href="cats.html" class="block py-1 hover:text-brand-600">我想養貓咪</a>
        <a href="dogs.html" class="block py-1 hover:text-brand-600">我想養狗狗</a>
        <a href="#faq" class="block py-1 hover:text-brand-600">常見問題</a>
        <a href="#contact" class="block py-1 hover:text-brand-600">聯絡我們</a>
        <a href="admin.html"
           class="mt-2 inline-flex items-center gap-1 rounded-full border border-gray-300 px-3 py-1 text-xs text-gray-600 hover:bg-gray-50">
          <span class="material-symbols-outlined text-base">admin_panel_settings</span>
          <span>送養方入口</span>
        </a>
      </nav>
    </div>
  </header>

  <!-- Hero -->
  <main class="min-h-screen">
    <section class="bg-gradient-to-b from-brand-50/80 to-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-14">
        <div class="grid md:grid-cols-[3fr,2fr] gap-8 items-center">
          <!-- Left text -->
          <div>
            <div class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 border border-brand-100 text-xs text-brand-700 mb-3 shadow-sm">
              <span class="w-1.5 h-1.5 rounded-full bg-brand-500"></span>
              <span>與台中簡媽媽狗園合作的送養平台</span>
            </div>
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold tracking-tight text-gray-900 mb-4 leading-tight">
              幫浪浪找到<br class="hidden sm:block" />
              下一站的幸福
            </h1>
            <p class="text-base md:text-lg text-gray-700 mb-6 max-w-xl leading-relaxed">
              這裡是<span class="font-semibold">「浪浪轉運站」</span>，協助台中簡媽媽狗園的貓貓狗狗送養。
              你可以依照<span class="font-semibold text-brand-700">類別、年齡、所在地</span>快速篩選，
              了解每一位孩子的故事，再決定是否送出申請。
            </p>
            <div class="flex flex-wrap gap-3 mb-6">
              <a href="#pets"
                 class="inline-flex items-center gap-2 rounded-full bg-brand-600 px-4 py-2 text-white text-sm shadow hover:bg-brand-700">
                <span class="material-symbols-outlined text-base">search</span>
                <span>開始尋找浪浪</span>
              </a>
              <a href="#faq" class="inline-flex items-center gap-2 rounded-full border border-gray-300 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                <span class="material-symbols-outlined text-base">help</span>
                <span>了解領養流程</span>
              </a>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-3 gap-4 text-sm text-gray-700">
              <div>
                <div class="text-xl font-bold text-brand-700" id="statTotal">—</div>
                <div class="text-xs text-gray-500">平台上待領養的浪浪</div>
              </div>
              <div>
                <div class="text-xl font-bold text-brand-700" id="statCats">—</div>
                <div class="text-xs text-gray-500">貓咪數量</div>
              </div>
              <div>
                <div class="text-xl font-bold text-brand-700" id="statDogs">—</div>
                <div class="text-xs text-gray-500">狗狗數量</div>
              </div>
            </div>
          </div>

          <!-- Right illustration / cards -->
          <div class="relative">
            <div class="absolute -top-6 -left-4 w-16 h-16 rounded-full bg-brand-100/70 blur-2xl"></div>
            <div class="absolute -bottom-6 -right-2 w-20 h-20 rounded-full bg-orange-100/60 blur-2xl"></div>
            <div class="relative bg-white/80 backdrop-blur rounded-3xl shadow-lg border border-orange-100/80 p-3 sm:p-4 flex flex-col gap-3">
              <!-- Cat card -->
              <div class="flex gap-3">
                <div class="w-24 h-24 rounded-2xl bg-orange-50 overflow-hidden blur-fit"
                     style="--bg:url('https://images.pexels.com/photos/45201/kitty-cat-kitten-pet-45201.jpeg?auto=compress&cs=tinysrgb&w=800');">
                  <img src="https://images.pexels.com/photos/45201/kitty-cat-kitten-pet-45201.jpeg?auto=compress&cs=tinysrgb&w=800"
                       alt="貓咪" loading="lazy" />
                </div>
                <div class="flex-1">
                  <div class="flex items-center justify-between mb-1.5">
                    <h3 class="font-semibold text-sm">三花小妞</h3>
                    <span class="text-[11px] px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700">貓咪</span>
                  </div>
                  <p class="text-xs text-gray-600 line-clamp-2">
                    乖巧親人，適合當室內陪伴貓。
                  </p>
                  <div class="mt-1 flex flex-wrap gap-1.5">
                    <span class="tag-pill">
                      <span class="tag-pill-dot"></span>
                      <span>1 歲內</span>
                    </span>
                    <span class="tag-pill">
                      <span class="tag-pill-dot"></span>
                      <span>已結紮</span>
                    </span>
                  </div>
                </div>
              </div>
              <!-- Dog card -->
              <div class="flex gap-3">
                <div class="w-24 h-24 rounded-2xl bg-orange-50 overflow-hidden blur-fit"
                     style="--bg:url('https://images.pexels.com/photos/4587995/pexels-photo-4587995.jpeg?auto=compress&cs=tinysrgb&w=800');">
                  <img src="https://images.pexels.com/photos/4587995/pexels-photo-4587995.jpeg?auto=compress&cs=tinysrgb&w=800"
                       alt="狗狗" loading="lazy" />
                </div>
                <div class="flex-1">
                  <div class="flex items-center justify-between mb-1.5">
                    <h3 class="font-semibold text-sm">奶油小短腿</h3>
                    <span class="text-[11px] px-2 py-0.5 rounded-full bg-sky-50 text-sky-700">狗狗</span>
                  </div>
                  <p class="text-xs text-gray-600 line-clamp-2">
                    親人活潑，適合喜歡戶外散步的家庭。
                  </p>
                  <div class="mt-1 flex flex-wrap gap-1.5">
                    <span class="tag-pill">
                      <span class="tag-pill-dot"></span>
                      <span>2～5 歲</span>
                    </span>
                    <span class="tag-pill">
                      <span class="tag-pill-dot"></span>
                      <span>已打疫苗</span>
                    </span>
                  </div>
                </div>
              </div>
              <!-- Note -->
              <p class="mt-1 text-[11px] text-gray-500 text-right">
                實際浪浪資料以園區公告為準
              </p>
            </div>
          </div>
        </div>

        <!-- Quick links -->
        <div class="mt-10 flex flex-wrap gap-3 text-xs text-gray-600">
          <a href="#pets" class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-white shadow-sm border border-gray-100">
            <span class="material-symbols-outlined text-sm">filter_alt</span>
            <span>篩選貓狗、年齡、所在地</span>
          </a>
          <a href="#faq" class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-white shadow-sm border border-gray-100">
            <span class="material-symbols-outlined text-sm">info</span>
            <span>了解送養流程與注意事項</span>
          </a>
          <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-white shadow-sm border border-gray-100">
            <span class="material-symbols-outlined text-sm text-amber-500">volunteer_activism</span>
            <span>感謝你願意給浪浪一個家</span>
          </span>
        </div>
      </div>
    </section>

    <!-- Pets Section -->
    <section id="pets" class="bg-white border-t border-gray-100">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-14">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
          <div>
            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-1">目前待領養的浪浪</h2>
            <p class="text-sm text-gray-600">可依「種類、年齡、所在地」快速篩選，點擊卡片查看更多照片與故事。</p>
          </div>
          <!-- Filters -->
          <div class="flex flex-wrap gap-3 text-xs">
            <select id="filterSpecies" class="border border-gray-300 rounded-full px-3 py-1 bg-white">
              <option value="">全部類別</option>
              <option value="貓">只看貓咪</option>
              <option value="狗">只看狗狗</option>
            </select>
            <select id="filterAge" class="border border-gray-300 rounded-full px-3 py-1 bg-white">
              <option value="">全部年齡</option>
              <option value="幼年">幼年（約 1 歲內）</option>
              <option value="成年">成年（約 1～7 歲）</option>
              <option value="熟齡">熟齡（7 歲以上）</option>
            </select>
            <select id="filterArea" class="border border-gray-300 rounded-full px-3 py-1 bg-white">
              <option value="">不限所在地</option>
              <option value="台中">台中</option>
              <option value="外縣市">外縣市可送養</option>
            </select>
          </div>
        </div>

        <!-- Grid -->
        <div id="petGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-5">
          <!-- JS inject cards -->
        </div>

        <!-- 空狀態 -->
        <div id="emptyState" class="hidden mt-10 text-center text-gray-500 text-sm">
          目前沒有符合條件的浪浪，試試看放寬篩選條件或稍後再回來看看 🐾
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section id="faq" class="bg-gray-50 border-t border-gray-200">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-14">
        <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-4">常見問題 Q&amp;A</h2>
        <div class="space-y-4 text-sm text-gray-700">
          <details class="bg-white rounded-xl border border-gray-200 p-4">
            <summary class="font-semibold cursor-pointer select-none">Q：我要如何申請領養？</summary>
            <div class="mt-2 text-gray-600 leading-relaxed">
              A：在本頁選擇想了解的浪浪，點開卡片查看詳細資訊後，按下「我要認養」即可跳轉至台中簡媽媽狗園的官方聯繫方式，後續由園方與你對接。
            </div>
          </details>
          <details class="bg-white rounded-xl border border-gray-200 p-4">
            <summary class="font-semibold cursor-pointer select-none">Q：可以直接到園區看浪浪嗎？</summary>
            <div class="mt-2 text-gray-600 leading-relaxed">
              A：建議先透過簡媽媽狗園粉專聯繫，確認想看的浪浪是否仍在、身體狀況是否適合接觸，再安排時間前往，以免撲空。
            </div>
          </details>
          <details class="bg-white rounded-xl border border-gray-200 p-4">
            <summary class="font-semibold cursor-pointer select-none">Q：如果我在外縣市，可以領養嗎？</summary>
            <div class="mt-2 text-gray-600 leading-relaxed">
              A：視浪浪狀況與園方評估而定，有些孩子可以由志工護送或車隊協助，但仍以浪浪安全、適應情形為優先考量。
            </div>
          </details>
          <details class="bg-white rounded-xl border border-gray-200 p-4">
            <summary class="font-semibold cursor-pointer select-none">Q：領養前需要準備什麼？</summary>
            <div class="mt-2 text-gray-600 leading-relaxed">
              A：建議先準備好基本用品（餐具、睡墊、運輸籠、貓砂或牽繩等），並與家人充分溝通，確認「一輩子的照顧承諾」再下決定。
            </div>
          </details>
        </div>
      </div>
    </section>

    <!-- Contact -->
    <section id="contact" class="bg-white border-t border-gray-200">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-14">
        <h2 class="text-xl md:text-2xl font-bold">聯絡我們</h2>
        <p class="mt-2 text-gray-600">合作或媒體聯繫：<a href="https://m.m...1620" style="color:#0084FF; font-weight:600;">FB 台中簡媽媽狗園</a></p>
        <div class="mt-4 text-sm text-gray-500">© <span id="year"></span> 浪浪轉運站 StrayStation. 保留所有權利。</div>
      </div>
    </section>
  </main>

  <!-- Pet Detail Modal -->
  <dialog id="petDialog" class="w-full max-w-2xl max-h-[90vh] rounded-2xl p-0 overflow-y-auto">
    <div class="modal-content">
      <button id="dlgClose" class="close" aria-label="關閉">✕</button>

      <!-- 標題與物種 + Tag 列（保留前台結構，改成後台風格） -->
      <div class="flex items-start justify-between gap-3 mb-2">
        <div class="flex-1">
          <div class="flex items-start justify-between gap-2">
            <h3 id="dlgName" class="text-lg font-semibold leading-snug">—</h3>
            <span id="dlgSpeciesPill"
                  class="shrink-0 rounded-full text-xs px-2 py-1 bg-emerald-50 text-emerald-700">貓咪</span>
          </div>
          <!-- 三個圓角標籤：品種 / 年齡 / 性別 -->
          <div id="dlgTags" class="modal-info">
            <span id="dlgTagBreed"></span>
            <span id="dlgTagAge"></span>
            <span id="dlgTagGender"></span>
          </div>
        </div>
      </div>

      <!-- 主圖（套用 admin modal-main-photo） -->
      <img id="dlgImg" alt="毛孩照片" class="modal-main-photo cursor-pointer"/>

      <!-- 縮圖列（套用 admin grid 排版） -->
      <div id="dlgThumbs" class="modal-photos"></div>

      <!-- 描述（套用 admin 風格） -->
      <p id="dlgDesc">—</p>

      <!-- 按鈕列（右下角） -->
      <div class="modal-actions">
        <button id="dlgAdopt" class="success">我要認養</button>
        <button id="dlgShare" class="edit">分享</button>
      </div>
    </div>
  </dialog>

  <!-- 🔥 Lightbox 全螢幕顯示 -->
  <div id="lightbox"
    class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[999999]">
  
    <!-- 左箭頭 -->
    <button id="lbPrev"
      class="absolute left-3 md:left-10 text-white text-4xl select-none">❮</button>

    <!-- 主圖片 -->
    <img id="lbImg" class="max-h-[90vh] max-w-[90vw] object-contain rounded-lg"/>

    <!-- 🔥 Lightbox 縮圖列 -->
    <div id="lbThumbs"
      class="absolute bottom-20 left-0 w-full flex justify-center px-4 py-2 pb-[env(safe-area-inset-bottom)]">
      <div id="lbThumbsInner" class="flex gap-3"></div>
    </div>

    <!-- 右箭頭 -->
    <button id="lbNext"
      class="absolute right-3 md:right-10 text-white text-4xl select-none">❯</button>

  </div>
  
  <script type="module">
    history.scrollRestoration = "manual";  // 強制不還原位置
    window.scrollTo(0, 0);                 // 每次載入回到最頂端
    // ======= Firebase Import =======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC4NT2KOm_Cw2OEdaaOimxI0ruoNv_u_9g",
      authDomain: "straystation.firebaseapp.com",
      projectId: "straystation",
      storageBucket: "straystation.firebasestorage.app",
      messagingSenderId: "611366379195",
      appId: "1:611366379195:web:ef5a632e88d8bba1d6139e"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $  = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>document.querySelectorAll(sel);

    const petGrid     = $('#petGrid');
    const emptyState  = $('#emptyState');
    const dlg         = $('#petDialog');
    const dlgClose    = $('#dlgClose');
    const lb          = $('#lightbox');
    const lbImg       = $('#lbImg');
    const lbPrev      = $('#lbPrev');
    const lbNext      = $('#lbNext');
    const lbThumbs    = $('#lbThumbsInner');

    let allPets = [];
    let filteredPets = [];
    let currentPetId = null;
    let currentImages = [];
    let currentImageIndex = 0;
    let scrollPos = 0;

    function lockScroll() {
      scrollPos = window.scrollY;
      document.body.classList.add('modal-open');
      document.body.style.top = `-${scrollPos}px`;
    }
    function unlockScroll() {
      document.body.classList.remove('modal-open');
      document.body.style.top = '';
      window.scrollTo(0, scrollPos);
    }

    function formatAge(p){
      if (!p.age) return '';
      return p.age;
    }
    function formatBreed(p){
      if (!p.breedType && !p.breed) return '';
      if (p.breedType === '米克斯') {
        return `米克斯 / ${p.breed || '毛色不詳'}`;
      }
      return p.breed || '';
    }

    function applyFilters() {
      const speciesVal = $('#filterSpecies').value;
      const ageVal     = $('#filterAge').value;
      const areaVal    = $('#filterArea').value;

      filteredPets = allPets.filter(p => {
        if (speciesVal && p.species !== speciesVal) return false;
        if (ageVal) {
          const ageText = (p.age || '').toString();
          if (ageVal === '幼年' && !/幼|月|1 歲內|1歲內/.test(ageText)) return false;
          if (ageVal === '成年' && !/成年|歲/.test(ageText)) return false;
          if (ageVal === '熟齡' && !/7/.test(ageText))        return false;
        }
        if (areaVal) {
          if (areaVal === '台中' && !/台中|臺中/.test(p.area || '')) return false;
          if (areaVal === '外縣市' && !/外縣市|全台|跨縣市/.test(p.area || '')) return false;
        }
        return true;
      });

      renderPets(filteredPets);
    }

    function renderPets(list) {
      petGrid.innerHTML = '';
      if (!list.length) {
        emptyState.classList.remove('hidden');
        return;
      }
      emptyState.classList.add('hidden');

      list.forEach(p => {
        const card = document.createElement('button');
        card.type  = 'button';
        card.className =
          'group text-left bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition flex flex-col';
        const cover = (p.images && p.images.length) ? p.images[0] : 'https://placekitten.com/400/300';

        card.innerHTML = `
          <div class="relative w-full aspect-[4/3] bg-gray-100 overflow-hidden">
            <div class="blur-fit w-full h-full" style="--bg:url('${cover}')">
              <img src="${cover}" alt="${p.name || '浪浪'}" loading="lazy" />
            </div>
            <div class="absolute left-2 top-2 flex flex-col gap-1 text-[11px]">
              <span class="tag-pill">
                <span class="tag-pill-dot"></span>
                <span>${p.species === '狗' ? '狗狗' : '貓咪'}</span>
              </span>
              <span class="tag-pill">
                <span class="tag-pill-dot"></span>
                <span>${formatBreed(p) || '品種/毛色不詳'}</span>
              </span>
            </div>
            <div class="absolute right-2 bottom-2 text-[10px] px-2 py-1 rounded-full bg-black/60 text-white">
              ${p.area || '台中簡媽媽狗園'}
            </div>
          </div>
          <div class="p-2.5 flex-1 flex flex-col">
            <div class="flex items-center justify-between gap-2 mb-0.5">
              <h3 class="font-semibold text-sm line-clamp-1">${p.name || '未命名浪浪'}</h3>
              <span class="text-[11px] text-gray-500">${formatAge(p) || '年齡不詳'}</span>
            </div>
            <p class="text-[11px] text-gray-600 line-clamp-2 mb-1">${(p.desc || '').replace(/\n/g,' ')}</p>
            <div class="mt-auto flex items-center justify-between text-[11px] text-brand-700">
              <span class="inline-flex items-center gap-1">
                <span class="material-symbols-outlined text-xs">favorite</span>
                <span>想認養這隻</span>
              </span>
              <span class="inline-flex items-center gap-1 text-gray-500 group-hover:text-brand-600">
                <span class="material-symbols-outlined text-xs">open_in_new</span>
                <span>看更多</span>
              </span>
            </div>
          </div>
        `;
        card.addEventListener('click', ()=>openDialog(p.id));
        petGrid.appendChild(card);
      });
    }

    async function loadPets() {
      const qRef = query(collection(db, "pets"), orderBy("createdAt", "desc"));
      const snap = await getDocs(qRef);
      allPets = [];
      snap.forEach(docSnap=>{
        allPets.push({ id: docSnap.id, ...docSnap.data() });
      });

      const total = allPets.length;
      const cats  = allPets.filter(p=>p.species==='貓').length;
      const dogs  = allPets.filter(p=>p.species==='狗').length;
      $('#statTotal').textContent = total || '—';
      $('#statCats').textContent  = cats  || '—';
      $('#statDogs').textContent  = dogs  || '—';

      const params = new URLSearchParams(location.search);
      const petId  = params.get('pet');

      applyFilters();

      if (petId) {
        const target = allPets.find(p=>p.id === petId);
        if (target) {
          setTimeout(()=>openDialog(petId), 300);
        }
      }
    }

    async function openDialog(id) {
      const p = allPets.find(x=>x.id===id);
      if (!p) return;

      $('#dlgName').textContent = p.name || '未命名浪浪';
      const desc = p.desc || '';
      document.getElementById('dlgDesc').textContent = desc || '';

      currentPetId = id;
      history.replaceState(null, '', `?pet=${encodeURIComponent(id)}`);

      // 右上角物種圓角標籤（貓咪/狗狗 + 顏色）
      const speciesPill = document.getElementById('dlgSpeciesPill');
      const isDog = /(狗|犬)/.test(String(p.species||''));
      speciesPill.textContent = isDog ? '狗狗' : '貓咪';
      speciesPill.className = `shrink-0 rounded-full text-xs px-2 py-1 ${
        isDog ? 'bg-sky-50 text-sky-700' : 'bg-emerald-50 text-emerald-700'
      }`;

      // 三個圓角標籤（品種 / 年齡 / 性別）
      document.getElementById('dlgTagBreed').textContent  = formatBreed(p) || '—';
      document.getElementById('dlgTagAge').textContent    = formatAge(p)   || '—';
      document.getElementById('dlgTagGender').textContent = p.gender       || '—';

      // 主圖 & 縮圖
      const imgs = p.images && p.images.length ? p.images : [];
      const mainImg = document.getElementById('dlgImg');
      const thumbs  = document.getElementById('dlgThumbs');

      thumbs.innerHTML = '';
      currentImages = imgs;
      currentImageIndex = 0;

      if (imgs.length) {
        mainImg.src = imgs[0];
        imgs.forEach((url, i)=>{
          const thumb = document.createElement('img');
          thumb.src = url;
          thumb.className = 'dlg-thumb' + (i===0 ? ' active' : '');
          thumb.addEventListener('click', ()=>{
            mainImg.src = url;
            currentImageIndex = i;
            thumbs.querySelectorAll('.dlg-thumb').forEach(el=>el.classList.remove('active'));
            thumb.classList.add('active');
          });
          thumbs.appendChild(thumb);
        });
      } else {
        mainImg.src = 'https://placekitten.com/600/400';
      }

      mainImg.onclick = ()=>openLightbox();

      lockScroll();
      dlg.showModal();
    }

    function openLightbox() {
      if (!currentImages.length) return;
      lb.classList.remove('hidden');
      lb.classList.add('flex');
      renderLightbox();
      document.addEventListener('keydown', handleLbKey);
    }

    function closeLightbox() {
      lb.classList.add('hidden');
      lb.classList.remove('flex');
      document.removeEventListener('keydown', handleLbKey);
    }

    function renderLightbox() {
      if (!currentImages.length) return;
      lbImg.src = currentImages[currentImageIndex];
      lbThumbs.innerHTML = '';
      currentImages.forEach((url, i)=>{
        const t = document.createElement('img');
        t.src = url;
        t.className = 'lb-thumb' + (i===currentImageIndex ? ' active' : '');
        t.addEventListener('click', ()=>{
          currentImageIndex = i;
          renderLightbox();
        });
        lbThumbs.appendChild(t);
      });
    }

    function handleLbKey(e) {
      if (e.key === 'Escape') {
        closeLightbox();
      } else if (e.key === 'ArrowLeft') {
        currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
        renderLightbox();
      } else if (e.key === 'ArrowRight') {
        currentImageIndex = (currentImageIndex + 1) % currentImages.length;
        renderLightbox();
      }
    }

    lb.addEventListener('click', (e)=>{
      if (e.target === lb) closeLightbox();
    });
    lbPrev.addEventListener('click', ()=>{
      currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
      renderLightbox();
    });
    lbNext.addEventListener('click', ()=>{
      currentImageIndex = (currentImageIndex + 1) % currentImages.length;
      renderLightbox();
    });

    dlgClose.addEventListener('click', ()=>{
      dlg.close();
      unlockScroll();
      history.replaceState(null, '', location.pathname);
    });

    dlg.addEventListener('close', ()=>{
      unlockScroll();
      history.replaceState(null, '', location.pathname);
    });

    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && !lb.classList.contains('hidden')) {
        e.stopPropagation();
        closeLightbox();
      }
    });

    $('#filterSpecies').addEventListener('change', applyFilters);
    $('#filterAge').addEventListener('change', applyFilters);
    $('#filterArea').addEventListener('change', applyFilters);

    $('#navToggle').addEventListener('click', ()=>{
      const el = $('#mobileNav');
      el.classList.toggle('hidden');
    });

    document.getElementById('dlgAdopt').addEventListener('click', ()=>{
      window.open('https://m.m...1620', '_blank');
    });

    document.getElementById('dlgShare').addEventListener('click', async ()=>{
      if (!currentPetId) return;
      const url = `${location.origin}${location.pathname}?pet=${encodeURIComponent(currentPetId)}`;
      if (navigator.share) {
        await navigator.share({
          title: '浪浪轉運站｜待領養浪浪',
          text: '一起幫浪浪找到家',
          url
        });
      } else {
        await navigator.clipboard.writeText(url);
        alert('已複製連結，可以貼給朋友囉！');
      }
    });

    document.addEventListener('DOMContentLoaded', ()=>{
      const y = new Date().getFullYear();
      const yEl = document.getElementById('year');
      if (yEl) yEl.textContent = y;
    });

    loadPets();
  </script>
</body>
</html>
