<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>台中簡媽媽狗園｜後台管理</title>

  <!-- Firebase & Tailwind -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* 防止搜尋結果重繪跳動 */
    #cards { min-height: 40vh; }
  </style>
</head>

<body class="bg-[#fdf6f7] min-h-screen text-gray-800">

  <!-- 未登入 -->
  <div id="login-section" class="flex flex-col items-center justify-center min-h-screen">
    <h1 class="text-3xl font-bold mb-6 text-rose-600">台中簡媽媽狗園｜後台管理</h1>
    <button id="login-btn" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-3 rounded-xl">使用 Google 登入</button>
  </div>

  <!-- 已登入 -->
  <div id="admin-section" class="hidden p-4 md:p-8 space-y-6">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <h2 class="text-2xl font-bold text-rose-600">送養資料管理</h2>
      <div class="flex items-center gap-3">
        <span id="user-email" class="text-gray-600 text-sm"></span>
        <button id="logout-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg">登出</button>
      </div>
    </div>

    <!-- 表單 -->
    <form id="pet-form" class="bg-white p-6 rounded-2xl shadow space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <input id="name" type="text" placeholder="名字" class="border p-2 rounded" required>
        <select id="type" class="border p-2 rounded" required>
          <option value="">選擇類別</option>
          <option value="cat">貓</option>
          <option value="dog">狗</option>
        </select>

        <!-- 品種類型 -->
        <select id="category" class="border p-2 rounded" required>
          <option value="">請先選擇類別</option>
        </select>

        <!-- 品種 / 毛色 -->
        <select id="breed" class="border p-2 rounded" required>
          <option value="">請先選擇類別與品種類型</option>
        </select>

        <!-- 年齡改為「非必填」 -->
        <input id="age" type="text" placeholder="年齡（例如 6個月、2歲）" class="border p-2 rounded">
        <select id="gender" class="border p-2 rounded" required>
          <option value="">選擇性別</option>
          <option value="男生">男生</option>
          <option value="女生">女生</option>
        </select>
      </div>

      <textarea id="desc" placeholder="簡介（個性、習慣、故事等）" class="border p-2 rounded w-full" rows="3"></textarea>

      <div>
        <label class="font-semibold">上傳圖片（最多 5 張，可分次追加）：</label>
        <input id="images" type="file" accept="image/*" multiple class="block mt-2">
        <div id="preview" class="flex flex-wrap gap-2 mt-2"></div>
      </div>

      <button id="submit-btn" type="submit" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-2 rounded-lg w-full sm:w-auto">
        登錄
      </button>
    </form>

    <!-- 已登錄動物 -->
    <div class="bg-white p-4 md:p-6 rounded-2xl shadow">
      <div class="flex flex-col md:flex-row items-center justify-between gap-3">
        <h3 class="text-xl font-semibold text-rose-600">已登錄動物</h3>
        <input id="search" type="text" placeholder="搜尋名字…" class="w-full md:w-80 border rounded px-3 py-2">
      </div>
      <div id="cards" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mt-4"></div>
      <p id="empty-tip" class="text-gray-500 text-sm mt-3">輸入名字以搜尋並顯示卡片</p>
    </div>
  </div>

  <!-- Firebase 腳本 -->
  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // 登入 / 登出
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginSection = document.getElementById('login-section');
    const adminSection = document.getElementById('admin-section');

    loginBtn.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    logoutBtn.onclick = () => auth.signOut().then(() => location.href = 'index.html');

    auth.onAuthStateChanged(user => {
      if (user) {
        loginSection.classList.add('hidden');
        adminSection.classList.remove('hidden');
        document.getElementById('user-email').textContent = user.email;
      } else {
        adminSection.classList.add('hidden');
        loginSection.classList.remove('hidden');
      }
    });

    // 品種選單邏輯
    const typeSel = document.getElementById('type');
    const catSel = document.getElementById('category');
    const breedSel = document.getElementById('breed');
    const OPTIONS = {
      cat: {
        category: [{ v: 'breed', t: '品種貓' }, { v: 'mix', t: '米克斯' }],
        breed: {
          breed: ['美短', '英短', '藍貓', '暹羅貓', '波斯貓', '布偶貓', '曼赤肯'],
          mix: ['橘貓', '黑貓', '虎斑貓', '白底虎斑貓', '三花貓', '玳瑁貓', '白貓']
        }
      },
      dog: {
        category: [{ v: 'breed', t: '品種犬' }, { v: 'mix', t: '米克斯' }],
        breed: {
          breed: ['博美', '貴賓', '吉娃娃', '馬爾濟斯', '柯基', '柴犬', '哈士奇', '高山犬', '黃金獵犬'],
          mix: ['黑色', '白色', '黃色', '棕色', '虎斑', '花花']
        }
      }
    };

    function renderCategory() {
      const t = typeSel.value;
      catSel.innerHTML = '<option value="">選擇品種類型</option>';
      breedSel.innerHTML = '<option value="">請先選擇品種類型</option>';
      if (!t) return;
      OPTIONS[t].category.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.v; opt.textContent = o.t;
        catSel.appendChild(opt);
      });
      setTimeout(() => catSel.focus(), 100);
    }

    function renderBreed() {
      const t = typeSel.value, c = catSel.value;
      breedSel.innerHTML = '<option value="">請選擇</option>';
      if (!t || !c) return;
      OPTIONS[t].breed[c].forEach(b => {
        const opt = document.createElement('option');
        opt.value = b; opt.textContent = b;
        breedSel.appendChild(opt);
      });
      setTimeout(() => breedSel.focus(), 100);
    }

    typeSel.addEventListener('change', renderCategory);
    catSel.addEventListener('change', renderBreed);
  </script>

  <!-- 搜尋區防抖與顯示 -->
  <script>
    const searchInput = document.getElementById('search');
    const cards = document.getElementById('cards');
    const emptyTip = document.getElementById('empty-tip');
    let debounceTimer = null;

    searchInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(searchPets, 300);
    });

    async function searchPets() {
      const q = searchInput.value.trim();
      cards.innerHTML = '';
      if (!q) { emptyTip.textContent = '輸入名字以搜尋並顯示卡片'; return; }
      const snap = await db.collection('pets').orderBy('name').startAt(q).endAt(q + '\uf8ff').get();
      if (snap.empty) { emptyTip.textContent = '找不到符合的動物'; return; }
      emptyTip.textContent = '';
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement('div');
        el.className = 'rounded-xl border bg-white overflow-hidden shadow-sm hover:shadow-md cursor-pointer';
        el.innerHTML = `
          <img src="${d.images?.[0] || ''}" class="w-full aspect-square object-cover">
          <div class="p-3"><div class="font-semibold">${d.name}</div>
          <div class="text-sm text-gray-500">${d.type === 'cat' ? '貓' : '狗'}・${d.gender || '-'}・${d.age || '-'}</div></div>`;
        cards.appendChild(el);
      });
    }
  </script>
</body>
</html>
