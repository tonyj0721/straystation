<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°ä¸­ç°¡åª½åª½ç‹—åœ’ï½œå¾Œå°ç®¡ç†</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body.modal-open { overflow: hidden; }
    html.modal-open,
    body.modal-open {
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }
    #cards { min-height: 40vh; }
    #thumbs img { width: 60px; height: 60px; object-fit: contain; background: #f3f3f3; border-radius: .5rem; cursor: pointer; }
    /* ğŸ§© é¿å… Safari/iOS é¡¯ç¤ºé»‘æ¡†é è¨­æŒ‰éˆ• */
    input[type="file"]::-webkit-file-upload-button {
      visibility: hidden;
    }
    input[type="file"]::file-selector-button {
      visibility: hidden;
    }
    input[type="file"] {
      color: transparent;
    }

    /* é è¦½åœ–ç‰‡å¤–å±¤ */
    .preview-item {
      position: relative;
      display: inline-block;
    }

    /* é è¦½åœ–ç‰‡ */
    .preview-item img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    /* å–®å¼µåˆªé™¤æŒ‰éˆ• */
    .preview-item button {
      position: absolute;
      top: -6px;
      right: -6px;
      background: rgba(255, 255, 255, 0.9);
      color: #dc2626;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      line-height: 1;
    }
  </style>
</head>
<body class="bg-[#fdf6f7] text-gray-800 min-h-screen">

<!-- ç™»å…¥ç•«é¢ -->
<div id="login-section" class="flex flex-col items-center justify-center min-h-screen">
  <h1 class="text-3xl font-bold mb-6 text-rose-600">å°ä¸­ç°¡åª½åª½ç‹—åœ’ï½œå¾Œå°ç®¡ç†</h1>
  <button id="login-btn" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-3 rounded-xl">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<!-- ç®¡ç†ç•«é¢ -->
<div id="admin-section" class="hidden p-4 md:p-8 space-y-6">
  <div class="flex flex-col md:flex-row justify-between items-center gap-4">
    <h2 class="text-2xl font-bold text-rose-600">é€é¤Šè³‡æ–™ç®¡ç†</h2>
    <div class="flex items-center gap-3">
      <span id="user-email" class="text-gray-600 text-sm"></span>
      <button id="logout-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg">ç™»å‡º</button>
    </div>
  </div>

  <!-- è¡¨å–® -->
  <form id="pet-form" class="bg-white p-6 rounded-2xl shadow space-y-4">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <input id="name" type="text" placeholder="åå­—" class="border p-2 rounded" required />
      <select id="type" class="border p-2 rounded" required>
        <option value="">é¸æ“‡é¡åˆ¥</option>
        <option value="cat">è²“</option>
        <option value="dog">ç‹—</option>
      </select>
      <select id="category" class="border p-2 rounded" required>
        <option value="">è«‹å…ˆé¸æ“‡é¡åˆ¥</option>
      </select>
      <select id="breed" class="border p-2 rounded" required>
        <option value="">è«‹å…ˆé¸æ“‡å“ç¨®é¡å‹</option>
      </select>
      <input id="age" type="text" placeholder="å¹´é½¡ï¼ˆå¯ç•¥ï¼‰" class="border p-2 rounded" />
      <select id="gender" class="border p-2 rounded" required>
        <option value="">é¸æ“‡æ€§åˆ¥</option>
        <option value="ç”·ç”Ÿ">ç”·ç”Ÿ</option>
        <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
      </select>
    </div>
    <textarea id="desc" placeholder="ç°¡ä»‹ï¼ˆå€‹æ€§ã€ç¿’æ…£ã€æ•…äº‹ç­‰ï¼‰" class="border p-2 rounded w-full" rows="3"></textarea>
    <div>
      <label class="font-semibold block mb-2">ä¸Šå‚³åœ–ç‰‡ï¼ˆæœ€å¤š 5 å¼µï¼Œå¯åˆ†æ¬¡è¿½åŠ ï¼‰ï¼š</label>

      <!-- è‡ªè¨‚ä¸Šå‚³æŒ‰éˆ• -->
      <label for="images" class="inline-block bg-gray-200 text-gray-700 px-3 py-2 rounded-lg cursor-pointer hover:bg-gray-300 transition">
        é¸æ“‡ç…§ç‰‡
      </label>

      <!-- ç‹€æ…‹æç¤º -->
      <span id="upload-status" class="ml-1 text-sm text-gray-500">å°šæœªé¸æ“‡ç…§ç‰‡</span>

      <!-- é è¦½å€ -->
      <div id="preview" class="flex flex-wrap gap-2 mt-3"></div>

      <!-- éš±è—åŸç”Ÿ input -->
      <input id="images" type="file" accept="image/*" multiple class="hidden" />
    </div>
    <button id="submit-btn" type="submit" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-2 rounded-lg w-full sm:w-auto">ç™»éŒ„</button>
  </form>

  <!-- æœå°‹ -->
  <div class="bg-white p-4 md:p-6 rounded-2xl shadow">
    <div class="flex flex-col md:flex-row items-center justify-between gap-3">
      <h3 class="text-xl font-semibold text-rose-600">å·²ç™»éŒ„å‹•ç‰©</h3>
      <input id="search" type="text" placeholder="æœå°‹åå­—â€¦" class="w-full md:w-80 border rounded px-3 py-2" />
    </div>
    <div id="cards" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mt-4"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-[#fdf6f7]/90 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl relative flex flex-col md:flex-row overflow-hidden">
    <button id="close-modal" class="absolute top-3 left-3 text-gray-600 text-2xl">âœ–</button>
    <div class="absolute top-3 right-4 flex gap-3 text-xl">
      <button id="edit-btn">âœï¸</button>
      <button id="delete-btn">ğŸ—‘ï¸</button>
    </div>
    <div class="md:w-1/2 bg-gray-100 flex flex-col items-center p-4">
      <img id="main-img" src="" class="w-full rounded-lg mb-3 object-contain bg-gray-100 aspect-square" />
      <div id="thumbs" class="flex gap-2 overflow-x-auto"></div>
    </div>
    <div class="md:w-1/2 p-4 flex flex-col">
      <h3 id="modal-name" class="text-2xl font-bold text-rose-600 mb-2"></h3>
      <p id="modal-info" class="text-gray-600 text-sm mb-4"></p>
      <div id="modal-desc" class="text-gray-700 text-sm flex-1 overflow-y-auto max-h-[70vh] mb-4"></div>
      <button id="adopt-btn" class="bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-lg w-full">å·²é ˜é¤Š</button>
      <div id="adopt-upload" class="hidden mt-4 p-4 bg-gray-50 rounded-xl shadow-inner">
        <label class="font-semibold block mb-2">ä¸Šå‚³åˆç…§ï¼ˆæœ€å¤š 5 å¼µï¼Œå¯ç•¥éï¼‰</label>
        <input id="adopt-photos" type="file" accept="image/*" multiple />
        <button id="save-adopt" class="mt-3 bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-lg w-full">è¦å¹¸ç¦å–” ğŸ’•</button>
      </div>
    </div>
  </div>
</div>

<script>
const auth=firebase.auth(),db=firebase.firestore(),storage=firebase.storage();
const loginBtn=document.getElementById('login-btn'),logoutBtn=document.getElementById('logout-btn');
const loginSection=document.getElementById('login-section'),adminSection=document.getElementById('admin-section');
loginBtn.onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
logoutBtn.onclick=()=>auth.signOut().then(()=>location.href='index.html');
auth.onAuthStateChanged(user=>{
 if(user){loginSection.classList.add('hidden');adminSection.classList.remove('hidden');document.getElementById('user-email').textContent=user.email;}
 else{adminSection.classList.add('hidden');loginSection.classList.remove('hidden');}
});

// --- åˆ†é¡é¸å–® ---
const OPTIONS={cat:{category:[{v:'breed',t:'å“ç¨®è²“'},{v:'mix',t:'ç±³å…‹æ–¯'}],breed:{breed:['ç¾çŸ­','è‹±çŸ­','è—è²“','æš¹ç¾…è²“','æ³¢æ–¯è²“','å¸ƒå¶è²“','æ›¼èµ¤è‚¯'],mix:['æ©˜è²“','é»‘è²“','è™æ–‘è²“','ç™½åº•è™æ–‘è²“','ä¸‰èŠ±è²“','ç³ç‘è²“','ç™½è²“']}},dog:{category:[{v:'breed',t:'å“ç¨®çŠ¬'},{v:'mix',t:'ç±³å…‹æ–¯'}],breed:{breed:['åšç¾','è²´è³“','å‰å¨ƒå¨ƒ','é¦¬çˆ¾æ¿Ÿæ–¯','æŸ¯åŸº','æŸ´çŠ¬','å“ˆå£«å¥‡','é«˜å±±çŠ¬','é»ƒé‡‘çµçŠ¬'],mix:['é»‘è‰²','ç™½è‰²','é»ƒè‰²','æ£•è‰²','è™æ–‘','èŠ±èŠ±']}}};
const typeSel=document.getElementById('type'),catSel=document.getElementById('category'),breedSel=document.getElementById('breed');
typeSel.addEventListener('change',()=>{
  catSel.innerHTML='<option value="">é¸æ“‡å“ç¨®é¡å‹</option>';
  breedSel.innerHTML='<option value="">è«‹å…ˆé¸æ“‡å“ç¨®é¡å‹</option>';
  const t=typeSel.value;if(!t)return;
  OPTIONS[t].category.forEach(o=>{const opt=document.createElement('option');opt.value=o.v;opt.textContent=o.t;catSel.appendChild(opt);});
});
catSel.addEventListener('change',()=>{
  const t=typeSel.value,c=catSel.value;
  breedSel.innerHTML='<option value="">è«‹é¸æ“‡</option>';
  if(!t||!c)return;

  // â­ å»¶é² 100ms å†æ’å…¥æ–°é¸é …ï¼ˆé¿å…ç«‹å³é—œé–‰ï¼‰
  setTimeout(()=>{
    OPTIONS[t].breed[c].forEach(b=>{
      const opt=document.createElement('option');
      opt.value=b;
      opt.textContent=b;
      breedSel.appendChild(opt);
    });
  },100);
});

// --- åœ–ç‰‡å£“ç¸® ---
async function compressImage(file, quality = 0.7, maxSize = 800) {
  return new Promise(resolve => {
    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => {
        resolve(new File([blob], file.name, { type: file.type }));
      }, file.type, quality);
    };
  });
}

// --- ä¸Šå‚³é è¦½ + æ¸…ç©ºåŠŸèƒ½ ---
let imagesArr = [];
const imgInput = document.getElementById('images');
const preview = document.getElementById('preview');
const uploadStatus = document.getElementById('upload-status');
const clearBtn = document.getElementById('clear-images');

imgInput.addEventListener('change', e => {
  const files = [...e.target.files];
  imagesArr = [...imagesArr, ...files].slice(0, 5);

  // æ›´æ–°æç¤º
  uploadStatus.textContent = imagesArr.length > 0
    ? `å·²é¸æ“‡ ${imagesArr.length} å¼µç…§ç‰‡`
    : 'å°šæœªé¸æ“‡ç…§ç‰‡';

  // æ›´æ–°é è¦½
  preview.innerHTML = '';
  imagesArr.forEach(f => {
    const img = document.createElement('img');
    img.src = URL.createObjectURL(f);
    img.className = 'w-20 h-20 object-cover rounded-lg';
    preview.appendChild(img);
  });
});

// --- æ¸…ç©ºç…§ç‰‡ ---
clearBtn.addEventListener('click', () => {
  imagesArr = [];
  imgInput.value = '';
  preview.innerHTML = '';
  uploadStatus.textContent = 'å°šæœªé¸æ“‡ç…§ç‰‡';
});

// --- ç™»éŒ„ï¼ˆå£“ç¸® + åŒæ­¥ä¸Šå‚³ + æç¤ºï¼‰ ---
const form = document.getElementById('pet-form');
form.addEventListener('submit', async e => {
  e.preventDefault();
  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.textContent = 'ä¸Šå‚³ä¸­ï¼Œè«‹ç¨å€™...';
  let dots = 0;
  const loadingAnim = setInterval(() => {
    dots = (dots + 1) % 4;
    btn.textContent = 'ä¸Šå‚³ä¸­ï¼Œè«‹ç¨å€™' + '.'.repeat(dots);
  }, 400);

  const name = document.getElementById('name').value.trim();
  // ğŸ§  é˜²é‡è¤‡æª¢æŸ¥
  const dupCheck = await db.collection('pets')
    .where('name', '==', name)
    .get();

  if (!dupCheck.empty) {
    const confirmContinue = confirm(`ã€Œ${name}ã€å·²å­˜åœ¨æ–¼é€é¤Šåå–®ä¸­ã€‚\næ˜¯å¦ä»è¦ç¹¼çºŒç™»éŒ„ï¼Ÿ`);
    if (!confirmContinue) {
      btn.textContent = 'ç™»éŒ„';
      btn.disabled = false;
      return; // âŒ ä½¿ç”¨è€…é¸æ“‡å–æ¶ˆ â†’ ä¸­æ­¢ç™»éŒ„
    }
  }
  const type = document.getElementById('type').value;
  const category = document.getElementById('category').value;
  const breed = document.getElementById('breed').value;
  const age = document.getElementById('age').value.trim();
  const gender = document.getElementById('gender').value;
  const desc = document.getElementById('desc').value.trim();

  const docRef = db.collection('pets').doc();
  const folder = `pets_images/${docRef.id}`;
  const urls = [];

  // å£“ç¸®åœ–ç‰‡ï¼ˆæœ€å¤š 5 å¼µï¼‰
  const compressedFiles = await Promise.all(
    imagesArr.map(f => compressImage(f, 0.7, 900))
  );

  // åŒæ­¥ä¸Šå‚³å…¨éƒ¨åœ–ç‰‡
  const uploadPromises = compressedFiles.map(async (file, i) => {
    const ref = storage.ref(`${folder}/${file.name}`);
    await ref.put(file);
    return await ref.getDownloadURL();
  });

  const results = await Promise.all(uploadPromises);
  urls.push(...results);

  // å¯«å…¥ Firestore
  await docRef.set({ name, type, category, breed, age, gender, desc, images: urls });

  alert('ç™»éŒ„å®Œæˆï¼');
  form.reset();
  imagesArr = [];
  document.getElementById('preview').innerHTML = '';
  btn.textContent = 'ç™»éŒ„';
  clearInterval(loadingAnim);
  btn.disabled = false;
});

// --- æœå°‹èˆ‡é¡¯ç¤º ---
const search=document.getElementById('search'),cards=document.getElementById('cards');
let timeout=null;
search.addEventListener('input',()=>{
  clearTimeout(timeout);
  timeout=setTimeout(async()=>{
    const q=search.value.trim();
    cards.innerHTML='';
    if(!q)return;
    const snap=await db.collection('pets').where('name','>=',q).where('name','<=',q+'\uf8ff').get();
    if(snap.empty){cards.innerHTML='<p class="text-gray-500 text-sm col-span-full">ç„¡çµæœ</p>';return;}
    snap.forEach(doc=>{
      const d=doc.data();
      const card=document.createElement('div');
      card.className='bg-white rounded-xl shadow cursor-pointer hover:shadow-lg transition p-2';
      card.innerHTML=`<img src="${d.images?.[0]||''}" class="w-full aspect-square object-contain bg-gray-100 rounded-lg mb-2"/>`
      card.onclick=()=>openModal(doc.id,d);
      cards.appendChild(card);
    });
  },400);
});

// --- Modal æ§åˆ¶ ---
const modal=document.getElementById('modal');
const mainImg=document.getElementById('main-img'),thumbs=document.getElementById('thumbs');
const modalName=document.getElementById('modal-name'),modalInfo=document.getElementById('modal-info'),modalDesc=document.getElementById('modal-desc');
let currentId=null,currentData=null;
function openModal(id,data){
  document.body.classList.add('modal-open');
  document.documentElement.classList.add('modal-open');
  modal.classList.remove('hidden');
  currentId=id;currentData=data;
  mainImg.src=data.images?.[0]||'';
  thumbs.innerHTML='';
  data.images.forEach(u=>{
    const img=document.createElement('img');img.src=u;
    img.onclick=()=>mainImg.src=u;thumbs.appendChild(img);
  });
  modalName.textContent=data.name;
  modalInfo.textContent=`${data.type==='cat'?'è²“':'ç‹—'}ï½œ${data.breed}ï½œ${data.gender}${data.age?`ï½œ${data.age}`:''}`;
  modalDesc.textContent=data.desc||'';
}
document.getElementById('close-modal').onclick=()=>{modal.classList.add('hidden');document.body.classList.remove('modal-open');document.documentElement.classList.remove('modal-open');};

// --- ç·¨è¼¯ ---
document.getElementById('edit-btn').onclick=()=>{
  const newName=prompt('ä¿®æ”¹åå­—ï¼š',currentData.name);
  if(newName!==null){
    db.collection('pets').doc(currentId).update({name:newName}).then(()=>{
      alert('å·²æ›´æ–°ï¼');
      modal.classList.add('hidden');
      search.dispatchEvent(new Event('input'));
    });
  }
};

// --- åˆªé™¤ ---
document.getElementById('delete-btn').onclick=async()=>{
  if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è³‡æ–™å—ï¼Ÿ')){
    await db.collection('pets').doc(currentId).delete();
    alert('å·²åˆªé™¤');modal.classList.add('hidden');search.dispatchEvent(new Event('input'));
  }
};

// --- å·²é ˜é¤Š ---
document.getElementById('adopt-btn').onclick=()=>{
  document.getElementById('adopt-btn').classList.add('hidden');
  document.getElementById('adopt-upload').classList.remove('hidden');
};
document.getElementById('save-adopt').onclick=async()=>{
  const files=[...document.getElementById('adopt-photos').files];
  const urls=[];
  for(let f of files){
    const ref=storage.ref(`adopted_photos/${currentId}/${f.name}`);
    await ref.put(f);
    urls.push(await ref.getDownloadURL());
  }
  await db.collection('adopted').doc(currentId).set({...currentData,adoptPhotos:urls});
  await db.collection('pets').doc(currentId).delete();
  alert('è¦å¹¸ç¦å–” ğŸ’•');
  modal.classList.add('hidden');
  document.body.classList.remove('modal-open');
  search.dispatchEvent(new Event('input'));
};
</script>
</body>
</html>
