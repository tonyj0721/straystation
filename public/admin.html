<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å°ä¸­ç°¡åª½åª½ç‹—åœ’ï½œå¾Œå°ç®¡ç†</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#fdf6f7] min-h-screen text-gray-800">

  <!-- æœªç™»å…¥ -->
  <div id="login-section" class="flex flex-col items-center justify-center min-h-screen">
    <h1 class="text-3xl font-bold mb-6 text-rose-600">å°ä¸­ç°¡åª½åª½ç‹—åœ’ï½œå¾Œå°ç®¡ç†</h1>
    <button id="login-btn" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-3 rounded-xl">ä½¿ç”¨ Google ç™»å…¥</button>
  </div>

  <!-- å·²ç™»å…¥ -->
  <div id="admin-section" class="hidden p-4 md:p-8 space-y-6">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <h2 class="text-2xl font-bold text-rose-600">é€é¤Šè³‡æ–™ç®¡ç†</h2>
      <div class="flex items-center gap-3">
        <span id="user-email" class="text-gray-600 text-sm"></span>
        <button id="logout-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg">ç™»å‡º</button>
      </div>
    </div>

    <!-- è¡¨å–® -->
    <form id="pet-form" class="bg-white p-6 rounded-2xl shadow space-y-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <input id="name" type="text" placeholder="åå­—" class="border p-2 rounded" required>
        <select id="type" class="border p-2 rounded" required>
          <option value="">é¸æ“‡é¡åˆ¥</option>
          <option value="cat">è²“</option>
          <option value="dog">ç‹—</option>
        </select>

        <!-- å“ç¨®é¡å‹ï¼šä¾é¡åˆ¥é¡¯ç¤ºæ–‡æ¡ˆ -->
        <select id="category" class="border p-2 rounded" required>
          <option value="">è«‹å…ˆé¸æ“‡é¡åˆ¥</option>
        </select>

        <!-- å“ç¨® / æ¯›è‰² -->
        <select id="breed" class="border p-2 rounded" required>
          <option value="">è«‹å…ˆé¸æ“‡é¡åˆ¥èˆ‡å“ç¨®é¡å‹</option>
        </select>

        <!-- å¹´é½¡æ”¹ç‚ºã€Œéå¿…å¡«ã€ -->
        <input id="age" type="text" placeholder="å¹´é½¡ï¼ˆä¾‹å¦‚ 6å€‹æœˆã€2æ­²ï¼‰" class="border p-2 rounded">
        <select id="gender" class="border p-2 rounded" required>
          <option value="">é¸æ“‡æ€§åˆ¥</option>
          <option value="ç”·ç”Ÿ">ç”·ç”Ÿ</option>
          <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
        </select>
      </div>

      <textarea id="desc" placeholder="ç°¡ä»‹ï¼ˆå€‹æ€§ã€ç¿’æ…£ã€æ•…äº‹ç­‰ï¼‰" class="border p-2 rounded w-full" rows="3"></textarea>

      <div>
        <label class="font-semibold">ä¸Šå‚³åœ–ç‰‡ï¼ˆæœ€å¤š 5 å¼µï¼Œå¯åˆ†æ¬¡è¿½åŠ ï¼‰ï¼š</label>
        <input id="images" type="file" accept="image/*" multiple class="block mt-2">
        <div id="preview" class="flex flex-wrap gap-2 mt-2"></div>
      </div>

      <button id="submit-btn" type="submit" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-2 rounded-lg w-full sm:w-auto">
        ç™»éŒ„
      </button>
    </form>

    <!-- å·²ç™»éŒ„å‹•ç‰©ï¼šå¡ç‰‡ + æœå°‹ -->
    <div class="bg-white p-4 md:p-6 rounded-2xl shadow">
      <div class="flex flex-col md:flex-row items-center justify-between gap-3">
        <h3 class="text-xl font-semibold text-rose-600">å·²ç™»éŒ„å‹•ç‰©</h3>
        <input id="search" type="text" placeholder="æœå°‹åå­—â€¦" class="w-full md:w-80 border rounded px-3 py-2">
      </div>
      <div id="cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-4"></div>
      <p id="empty-tip" class="text-gray-500 text-sm mt-3">è¼¸å…¥åå­—ä»¥æœå°‹ä¸¦é¡¯ç¤ºå¡ç‰‡</p>
    </div>
  </div>

  <!-- è©³ç´°è¦–çª— Modal -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white w-[95vw] max-w-5xl rounded-2xl shadow-lg overflow-hidden">
      <div class="relative">
        <button id="modal-close" class="absolute left-3 top-3 text-gray-600 hover:text-black text-2xl">âœ–</button>
        <div class="absolute right-3 top-3 flex gap-2">
          <button id="modal-edit" class="px-3 py-1 rounded bg-amber-500 text-white">ç·¨è¼¯</button>
          <button id="modal-del" class="px-3 py-1 rounded bg-red-500 text-white">åˆªé™¤</button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-0 md:gap-6 p-4 md:p-6">
        <!-- å·¦ï¼šä¸€å¼µå¤§åœ– + ç¸®åœ–åˆ— -->
        <div>
          <img id="modal-hero" class="w-full aspect-[4/3] object-cover rounded-xl border" src="" alt="">
          <div id="modal-thumbs" class="flex gap-2 mt-2 overflow-x-auto"></div>
        </div>
        <!-- å³ï¼šæ–‡å­—å…§å®¹ï¼ˆå¯ç¨ç«‹æ²å‹•ï¼‰ -->
        <div class="flex flex-col h-[60vh] md:h-[70vh]">
          <h4 id="modal-name" class="text-2xl font-bold mb-2"></h4>
          <div class="space-y-1 overflow-y-auto pr-2 flex-1">
            <p><span class="text-gray-500">é¡åˆ¥ï¼š</span><span id="modal-type"></span></p>
            <p><span class="text-gray-500">å“ç¨®/æ¯›è‰²ï¼š</span><span id="modal-breed"></span></p>
            <p><span class="text-gray-500">å¹´é½¡ï¼š</span><span id="modal-age"></span></p>
            <p><span class="text-gray-500">æ€§åˆ¥ï¼š</span><span id="modal-gender"></span></p>
            <p class="pt-2 whitespace-pre-line"><span class="text-gray-500">ç°¡ä»‹ï¼š</span><span id="modal-desc"></span></p>
          </div>

          <!-- å·²é ˜é¤Šæµç¨‹ -->
          <div id="adopt-wrap" class="pt-3 border-t mt-3">
            <details id="adopt-details" class="rounded">
              <summary class="cursor-pointer select-none text-emerald-700">å·²é ˜é¤Šï¼ˆå¯ä¸Šå‚³èˆ‡é ˜é¤Šäººåˆç…§ï¼Œæœ€å¤š 5 å¼µï¼›å¯ç•¥éï¼‰</summary>
              <div class="mt-2">
                <input id="adopt-files" type="file" accept="image/*" multiple class="block">
                <div id="adopt-preview" class="flex flex-wrap gap-2 mt-2"></div>
              </div>
            </details>
            <div class="flex justify-between mt-3">
              <button id="adopt-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg">è¦å¹¸ç¦å–” ğŸ’•</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ---- Firebase è¨­å®šï¼ˆå¯æ”¹ç‚ºå¤–éƒ¨ firebase-config.jsï¼‰ ----
    const firebaseConfig = {
      apiKey: "AIzaSyBw9GBw5-LZkKD34qTiwBtZXdwONHLqG_s",
      authDomain: "straystation.firebaseapp.com",
      projectId: "straystation",
      storageBucket: "straystation.firebasestorage.app",
      messagingSenderId: "",
      appId: ""
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ---- ç™»å…¥/ç™»å‡º ----
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginSection = document.getElementById('login-section');
    const adminSection = document.getElementById('admin-section');
    loginBtn.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    logoutBtn.onclick = () => auth.signOut().then(()=> location.href='index.html');
    auth.onAuthStateChanged(u=>{
      if(u){ loginSection.classList.add('hidden'); adminSection.classList.remove('hidden'); document.getElementById('user-email').textContent=u.email; }
      else { adminSection.classList.add('hidden'); loginSection.classList.remove('hidden'); }
    });

    // ---- è¡¨å–®ï¼šå“ç¨®/æ¯›è‰²é‚è¼¯ ----
    const typeSel = document.getElementById('type');
    const catSel  = document.getElementById('category');
    const breedSel= document.getElementById('breed');

    const OPTIONS = {
      cat: {
        category: [{v:'breed', t:'å“ç¨®è²“'}, {v:'mix', t:'ç±³å…‹æ–¯'}],
        breed: {
          breed: ['ç¾çŸ­','è‹±çŸ­','è—è²“','æš¹ç¾…è²“','æ³¢æ–¯è²“','å¸ƒå¶è²“','æ›¼èµ¤è‚¯'],
          mix:   ['æ©˜è²“','é»‘è²“','è™æ–‘è²“','ç™½åº•è™æ–‘è²“','ä¸‰èŠ±è²“','ç³ç‘è²“','ç™½è²“']
        }
      },
      dog: {
        category: [{v:'breed', t:'å“ç¨®çŠ¬'}, {v:'mix', t:'ç±³å…‹æ–¯'}],
        breed: {
          breed: ['åšç¾','è²´è³“','å‰å¨ƒå¨ƒ','é¦¬çˆ¾æ¿Ÿæ–¯','æŸ¯åŸº','æŸ´çŠ¬','å“ˆå£«å¥‡','é«˜å±±çŠ¬','é»ƒé‡‘çµçŠ¬'],
          mix:   ['é»‘è‰²','ç™½è‰²','é»ƒè‰²','æ£•è‰²','è™æ–‘','èŠ±èŠ±']
        }
      }
    };

    function renderCategory(){
      const t = typeSel.value;
      catSel.innerHTML = '<option value="">é¸æ“‡å“ç¨®é¡å‹</option>';
      breedSel.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å“ç¨®é¡å‹</option>';
      if(!t) return;
      OPTIONS[t].category.forEach(o=>{
        const opt = document.createElement('option');
        opt.value=o.v; opt.textContent=o.t;
        catSel.appendChild(opt);
      });
    }
    function renderBreed(){
      const t = typeSel.value, c = catSel.value;
      breedSel.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
      if(!t || !c) return;
      OPTIONS[t].breed[c].forEach(b=>{
        const opt=document.createElement('option'); opt.value=b; opt.textContent=b; breedSel.appendChild(opt);
      });
    }
    typeSel.addEventListener('change', renderCategory);
    catSel.addEventListener('change', renderBreed);

    // ---- åœ–ç‰‡ä¸Šå‚³ï¼ˆå¯è¿½åŠ ã€ä¸æ¸…ç©ºå‰æ¬¡ï¼‰ ----
    const imgInput = document.getElementById('images');
    const preview  = document.getElementById('preview');
    let imageFiles = []; // è¿½åŠ ç´¯ç©
    imgInput.addEventListener('change', e=>{
      const files = Array.from(e.target.files);
      // è¿½åŠ ä¸Šé™ 5
      for(const f of files){
        if(imageFiles.length>=5) break;
        imageFiles.push(f);
      }
      renderPreviews();
      imgInput.value = ''; // å…è¨±å†æ¬¡é¸åŒåæª”
    });
    function renderPreviews(){
      preview.innerHTML='';
      imageFiles.forEach((file, idx)=>{
        const url = URL.createObjectURL(file);
        const wrap = document.createElement('div');
        wrap.className='relative';
        wrap.innerHTML = `
          <img src="${url}" class="w-24 h-24 object-cover rounded border">
          <button data-i="${idx}" class="absolute -top-2 -right-2 bg-black/70 text-white rounded-full w-6 h-6 leading-6 text-center">Ã—</button>
        `;
        wrap.querySelector('button').onclick = (ev)=>{
          const i = +ev.currentTarget.dataset.i;
          imageFiles.splice(i,1);
          renderPreviews();
        };
        preview.appendChild(wrap);
      });
    }

    // ---- ç™»éŒ„ï¼ˆä¸Šå‚³é€²åº¦ï¼šåœ–ç‰‡ X/5ï¼‰ ----
    const form = document.getElementById('pet-form');
    const submitBtn = document.getElementById('submit-btn');
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      submitBtn.disabled=true;
      const total = imageFiles.length, petRef = db.collection('pets').doc();
      let uploaded = 0, urls=[];
      submitBtn.textContent = `ç™»éŒ„ä¸­... åœ–ç‰‡ 0/${total||0}`;

      const payload = {
        name: document.getElementById('name').value.trim(),
        type: typeSel.value,
        category: catSel.value,
        breed: breedSel.value,
        age: document.getElementById('age').value.trim(),
        gender: document.getElementById('gender').value,
        desc: document.getElementById('desc').value.trim(),
        images: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try{
        // å…ˆä¸Šå‚³åœ–ç‰‡
        for(const f of imageFiles){
          const ref = storage.ref(`pets_images/${petRef.id}/${f.name}`);
          await ref.put(f);
          uploaded++; submitBtn.textContent = `ç™»éŒ„ä¸­... åœ–ç‰‡ ${uploaded}/${total}`;
          urls.push(await ref.getDownloadURL());
        }
        payload.images = urls;

        await petRef.set(payload);

        // reset
        form.reset(); imageFiles=[]; renderPreviews();
        submitBtn.textContent='ç™»éŒ„å®Œæˆï¼';
        setTimeout(()=>{ submitBtn.disabled=false; submitBtn.textContent='ç™»éŒ„'; }, 2000);
      }catch(err){
        console.error(err);
        alert('ç™»éŒ„å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
        submitBtn.disabled=false; submitBtn.textContent='ç™»éŒ„';
      }
    });

    // ---- å·²ç™»éŒ„å‹•ç‰©ï¼šæœå°‹â†’é¡¯ç¤ºå¡ç‰‡ ----
    const search = document.getElementById('search');
    const cards  = document.getElementById('cards');
    const emptyTip = document.getElementById('empty-tip');
    let currentDocs = [];

    search.addEventListener('input', async ()=>{
      const q = search.value.trim();
      cards.innerHTML=''; currentDocs=[];
      if(!q){ emptyTip.textContent='è¼¸å…¥åå­—ä»¥æœå°‹ä¸¦é¡¯ç¤ºå¡ç‰‡'; return; }
      emptyTip.textContent='';

      // name å‰ç¶´æœå°‹ï¼ˆç°¡å–®ç‰ˆï¼‰
      const snap = await db.collection('pets').orderBy('name').startAt(q).endAt(q+'\uf8ff').get();
      if(snap.empty){ emptyTip.textContent='æ‰¾ä¸åˆ°ç¬¦åˆçš„å‹•ç‰©'; return; }

      snap.forEach(doc=>{
        const d=doc.data(); currentDocs.push({id:doc.id, ...d});
        const img=d.images?.[0]||'';
        const el=document.createElement('div');
        el.className='rounded-xl border shadow-sm bg-white overflow-hidden hover:shadow-md transition cursor-pointer';
        el.innerHTML = `
          <img src="${img}" class="w-full aspect-[4/3] object-cover">
          <div class="p-3">
            <div class="font-semibold">${d.name}</div>
            <div class="text-sm text-gray-500">${d.type==='cat'?'è²“':'ç‹—'}ãƒ»${d.gender||'-'}ãƒ»${d.age||'-'}</div>
          </div>
        `;
        el.onclick=()=>openModal(doc.id, d);
        cards.appendChild(el);
      });
    });

    // ---- è©³ç´°è¦–çª— ----
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modal-close');
    const modalHero = document.getElementById('modal-hero');
    const modalThumbs = document.getElementById('modal-thumbs');
    const modalName = document.getElementById('modal-name');
    const modalType = document.getElementById('modal-type');
    const modalBreed= document.getElementById('modal-breed');
    const modalAge  = document.getElementById('modal-age');
    const modalGender=document.getElementById('modal-gender');
    const modalDesc = document.getElementById('modal-desc');
    const modalEdit = document.getElementById('modal-edit');
    const modalDel  = document.getElementById('modal-del');
    const adoptBtn  = document.getElementById('adopt-btn');
    const adoptFiles= document.getElementById('adopt-files');
    const adoptPreview=document.getElementById('adopt-preview');
    let currentId=null, currentData=null, adoptFileList=[];

    function openModal(id, data){
      currentId=id; currentData=data;
      modalName.textContent=data.name;
      modalType.textContent=data.type==='cat'?'è²“':'ç‹—';
      modalBreed.textContent=data.breed||'-';
      modalAge.textContent=data.age||'-';
      modalGender.textContent=data.gender||'-';
      modalDesc.textContent=data.desc||'';
      const imgs = data.images||[];
      modalHero.src = imgs[0]||'';
      modalThumbs.innerHTML='';
      imgs.forEach((u,i)=>{
        const b=document.createElement('button');
        b.type='button'; b.className='border rounded overflow-hidden';
        b.innerHTML=`<img src="${u}" class="w-20 h-16 object-cover">`;
        b.onclick=()=>{ modalHero.src=u; };
        modalThumbs.appendChild(b);
      });
      adoptFileList=[]; adoptPreview.innerHTML=''; adoptFiles.value='';
      modal.classList.remove('hidden'); modal.classList.add('flex');
    }
    modalClose.onclick=()=>{ modal.classList.add('hidden'); modal.classList.remove('flex'); };

    // ç·¨è¼¯ï¼ˆæŠŠå…§å®¹å¸¶å›è¡¨å–®ï¼‰
    modalEdit.onclick=()=>{
      typeSel.value=currentData.type; renderCategory(); catSel.value=currentData.category; renderBreed(); breedSel.value=currentData.breed;
      document.getElementById('name').value=currentData.name||'';
      document.getElementById('age').value=currentData.age||'';
      document.getElementById('gender').value=currentData.gender||'';
      document.getElementById('desc').value=currentData.desc||'';
      window.scrollTo({top:0, behavior:'smooth'});
      modalClose.click();
    };

    // åˆªé™¤
    modalDel.onclick=async()=>{
      if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™ï¼Ÿ')) return;
      await db.collection('pets').doc(currentId).delete();
      alert('å·²åˆªé™¤');
      modalClose.click();
      search.dispatchEvent(new Event('input'));
    };

    // å·²é ˜é¤Šï¼šé¸æª”é è¦½ï¼ˆå¯ç•¥éï¼‰
    adoptFiles.addEventListener('change', e=>{
      const more = Array.from(e.target.files);
      for(const f of more){ if(adoptFileList.length>=5) break; adoptFileList.push(f); }
      adoptPreview.innerHTML='';
      adoptFileList.forEach((f,i)=>{
        const u=URL.createObjectURL(f);
        const w=document.createElement('div'); w.className='relative';
        w.innerHTML=`<img src="${u}" class="w-20 h-20 object-cover rounded border">
        <button data-i="${i}" class="absolute -top-2 -right-2 bg-black/70 text-white rounded-full w-6 h-6 leading-6 text-center">Ã—</button>`;
        w.querySelector('button').onclick=(ev)=>{ const idx=+ev.currentTarget.dataset.i; adoptFileList.splice(idx,1); adoptFiles.value=''; adoptPreview.removeChild(w); };
        adoptPreview.appendChild(w);
      });
      adoptFiles.value='';
    });

    // å·²é ˜é¤Šï¼šæ¬ç§»è‡³ adoptedï¼ˆç…§ç‰‡å¯ç•¥éï¼‰
    adoptBtn.onclick = async ()=>{
      try{
        adoptBtn.disabled=true; adoptBtn.textContent='è™•ç†ä¸­â€¦';
        const adoptedRef = db.collection('adopted').doc();
        const urls=[];
        for(const f of adoptFileList){
          const ref = storage.ref(`adopted_images/${adoptedRef.id}/${f.name}`);
          await ref.put(f);
          urls.push(await ref.getDownloadURL());
        }
        const data = {...currentData, images: (urls.length?urls:currentData.images), adoptedAt: firebase.firestore.FieldValue.serverTimestamp()};
        await adoptedRef.set(data);
        await db.collection('pets').doc(currentId).delete();
        adoptBtn.textContent='è¦å¹¸ç¦å–” ğŸ’•';
        setTimeout(()=>{ adoptBtn.disabled=false; }, 1000);
        modalClose.click();
        search.dispatchEvent(new Event('input'));
        alert('å·²ç§»è‡³ã€Œå·²é ˜é¤Šã€æ¸…å–®');
      }catch(e){ console.error(e); alert('è™•ç†å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡'); adoptBtn.disabled=false; adoptBtn.textContent='è¦å¹¸ç¦å–” ğŸ’•'; }
    };
  </script>
</body>
</html>
