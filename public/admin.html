<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å°ä¸­ç°¡åª½åª½ç‹—åœ’ï½œå¾Œå°ç®¡ç†</title>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body.modal-open { overflow: hidden; }
#cards { min-height: 40vh; }
#thumbs img { width: 60px; height: 60px; object-fit: cover; border-radius: .5rem; cursor: pointer; }
#edit-form input, #edit-form textarea, #edit-form select { width:100%; border:1px solid #ddd; border-radius:8px; padding:.4rem .5rem; }
</style>
</head>
<body class="bg-[#fdf6f7] text-gray-800 min-h-screen">

<!-- ç™»å…¥ç•«é¢ -->
<div id="login-section" class="flex flex-col items-center justify-center min-h-screen">
  <h1 class="text-3xl font-bold mb-6 text-rose-600">å°ä¸­ç°¡åª½åª½ç‹—åœ’ï½œå¾Œå°ç®¡ç†</h1>
  <button id="login-btn" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-3 rounded-xl">ä½¿ç”¨ Google ç™»å…¥</button>
</div>

<!-- ç®¡ç†ç•«é¢ -->
<div id="admin-section" class="hidden p-4 md:p-8 space-y-6">
  <div class="flex flex-col md:flex-row justify-between items-center gap-4">
    <h2 class="text-2xl font-bold text-rose-600">é€é¤Šè³‡æ–™ç®¡ç†</h2>
    <div class="flex items-center gap-3">
      <span id="user-email" class="text-gray-600 text-sm"></span>
      <button id="logout-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg">ç™»å‡º</button>
    </div>
  </div>

  <!-- è¡¨å–® -->
  <form id="pet-form" class="bg-white p-6 rounded-2xl shadow space-y-4">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <input id="name" type="text" placeholder="åå­—" class="border p-2 rounded" required />
      <select id="type" class="border p-2 rounded" required>
        <option value="">é¸æ“‡é¡åˆ¥</option>
        <option value="cat">è²“</option>
        <option value="dog">ç‹—</option>
      </select>
      <select id="category" class="border p-2 rounded" required>
        <option value="">è«‹å…ˆé¸æ“‡é¡åˆ¥</option>
      </select>
      <select id="breed" class="border p-2 rounded" required>
        <option value="">è«‹å…ˆé¸æ“‡å“ç¨®é¡å‹</option>
      </select>
      <input id="age" type="text" placeholder="å¹´é½¡ï¼ˆå¯ç•¥ï¼‰" class="border p-2 rounded" />
      <select id="gender" class="border p-2 rounded" required>
        <option value="">é¸æ“‡æ€§åˆ¥</option>
        <option value="ç”·ç”Ÿ">ç”·ç”Ÿ</option>
        <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
      </select>
    </div>
    <textarea id="desc" placeholder="ç°¡ä»‹ï¼ˆå€‹æ€§ã€ç¿’æ…£ã€æ•…äº‹ç­‰ï¼‰" class="border p-2 rounded w-full" rows="3"></textarea>
    <div>
      <label class="font-semibold">ä¸Šå‚³åœ–ç‰‡ï¼ˆæœ€å¤š 5 å¼µï¼Œå¯åˆ†æ¬¡è¿½åŠ ï¼‰ï¼š</label>
      <input id="images" type="file" accept="image/*" multiple class="block mt-2" />
      <div id="preview" class="flex flex-wrap gap-2 mt-2"></div>
    </div>
    <button id="submit-btn" type="submit" class="bg-rose-500 hover:bg-rose-600 text-white px-6 py-2 rounded-lg w-full sm:w-auto">ç™»éŒ„</button>
  </form>

  <!-- æœå°‹ -->
  <div class="bg-white p-4 md:p-6 rounded-2xl shadow">
    <div class="flex flex-col md:flex-row items-center justify-between gap-3">
      <h3 class="text-xl font-semibold text-rose-600">å·²ç™»éŒ„å‹•ç‰©</h3>
      <input id="search" type="text" placeholder="æœå°‹åå­—â€¦" class="w-full md:w-80 border rounded px-3 py-2" />
    </div>
    <div id="cards" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mt-4"></div>
  </div>
</div>

<!-- è©³ç´°è¦–çª— -->
<div id="modal" class="hidden fixed inset-0 bg-[#fdf6f7]/90 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl relative flex flex-col md:flex-row overflow-hidden">
    <button id="close-modal" class="absolute top-3 left-3 text-gray-600 text-2xl">âœ–</button>
    <div class="absolute top-3 right-4 flex gap-3 text-xl">
      <button id="edit-btn">âœï¸</button>
      <button id="delete-btn">ğŸ—‘ï¸</button>
    </div>

    <div class="md:w-1/2 bg-gray-100 flex flex-col items-center p-4">
      <img id="main-img" src="" class="w-full rounded-lg mb-3 object-cover aspect-square" />
      <div id="thumbs" class="flex gap-2 overflow-x-auto"></div>
    </div>

    <div class="md:w-1/2 p-4 flex flex-col">
      <h3 id="modal-name" class="text-2xl font-bold text-rose-600 mb-2"></h3>
      <p id="modal-info" class="text-gray-600 text-sm mb-4"></p>
      <div id="modal-desc" class="text-gray-700 text-sm flex-1 overflow-y-auto max-h-[70vh] mb-4"></div>

      <form id="edit-form" class="hidden flex-col space-y-2 mb-4"></form>

      <button id="adopt-btn" class="bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-lg w-full">å·²é ˜é¤Š</button>
      <div id="adopt-upload" class="hidden mt-4 p-4 bg-gray-50 rounded-xl shadow-inner">
        <label class="font-semibold block mb-2">ä¸Šå‚³åˆç…§ï¼ˆæœ€å¤š 5 å¼µï¼Œå¯ç•¥éï¼‰</label>
        <input id="adopt-photos" type="file" accept="image/*" multiple />
        <button id="save-adopt" class="mt-3 bg-rose-500 hover:bg-rose-600 text-white px-4 py-2 rounded-lg w-full">è¦å¹¸ç¦å–” ğŸ’•</button>
      </div>
    </div>
  </div>
</div>

<script>
const auth=firebase.auth(),db=firebase.firestore(),storage=firebase.storage();
const loginBtn=document.getElementById('login-btn'),logoutBtn=document.getElementById('logout-btn');
const loginSection=document.getElementById('login-section'),adminSection=document.getElementById('admin-section');
loginBtn.onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
logoutBtn.onclick=()=>auth.signOut().then(()=>location.href='index.html');
auth.onAuthStateChanged(u=>{
  if(u){loginSection.classList.add('hidden');adminSection.classList.remove('hidden');userEmail.textContent=u.email;}
  else{adminSection.classList.add('hidden');loginSection.classList.remove('hidden');}
});

const OPTIONS={cat:{category:[{v:'breed',t:'å“ç¨®è²“'},{v:'mix',t:'ç±³å…‹æ–¯'}],breed:{breed:['ç¾çŸ­','è‹±çŸ­','è—è²“','æš¹ç¾…è²“','æ³¢æ–¯è²“','å¸ƒå¶è²“','æ›¼èµ¤è‚¯'],mix:['æ©˜è²“','é»‘è²“','è™æ–‘è²“','ç™½åº•è™æ–‘è²“','ä¸‰èŠ±è²“','ç³ç‘è²“','ç™½è²“']}},dog:{category:[{v:'breed',t:'å“ç¨®çŠ¬'},{v:'mix',t:'ç±³å…‹æ–¯'}],breed:{breed:['åšç¾','è²´è³“','å‰å¨ƒå¨ƒ','é¦¬çˆ¾æ¿Ÿæ–¯','æŸ¯åŸº','æŸ´çŠ¬','å“ˆå£«å¥‡','é«˜å±±çŠ¬','é»ƒé‡‘çµçŠ¬'],mix:['é»‘è‰²','ç™½è‰²','é»ƒè‰²','æ£•è‰²','è™æ–‘','èŠ±èŠ±']}}};
const typeSel=type,catSel=category,breedSel=breed;
typeSel.addEventListener('change',()=>{catSel.innerHTML='<option value="">é¸æ“‡å“ç¨®é¡å‹</option>';breedSel.innerHTML='<option value="">è«‹å…ˆé¸æ“‡å“ç¨®é¡å‹</option>';if(!typeSel.value)return;OPTIONS[typeSel.value].category.forEach(o=>{const opt=document.createElement('option');opt.value=o.v;opt.textContent=o.t;catSel.appendChild(opt);});});
catSel.addEventListener('change',()=>{const t=typeSel.value,c=catSel.value;breedSel.innerHTML='<option value="">è«‹é¸æ“‡</option>';if(!t||!c)return;OPTIONS[t].breed[c].forEach(b=>{const opt=document.createElement('option');opt.value=b;opt.textContent=b;breedSel.appendChild(opt);});});

let imagesArr=[];
images.addEventListener('change',e=>{const files=[...e.target.files];imagesArr=[...imagesArr,...files].slice(0,5);preview.innerHTML='';imagesArr.forEach(f=>{const img=document.createElement('img');img.src=URL.createObjectURL(f);img.className='w-20 h-20 object-cover rounded-lg';preview.appendChild(img);});});

pet-form.addEventListener('submit',async e=>{
  e.preventDefault();const btn=submit-btn;btn.disabled=true;
  const data={name:name.value.trim(),type:type.value,category:category.value,breed:breed.value,age:age.value.trim(),gender:gender.value,desc:desc.value.trim()};
  const docRef=db.collection('pets').doc();const folder=`pets_images/${docRef.id}`;const urls=[];
  for(let i=0;i<imagesArr.length;i++){btn.textContent=`ç™»éŒ„ä¸­... åœ–ç‰‡ ${i+1}/${imagesArr.length}`;const ref=storage.ref(`${folder}/${imagesArr[i].name}`);await ref.put(imagesArr[i]);urls.push(await ref.getDownloadURL());}
  await docRef.set({...data,images:urls});alert('ç™»éŒ„å®Œæˆï¼');pet-form.reset();imagesArr=[];preview.innerHTML='';btn.textContent='ç™»éŒ„';btn.disabled=false;
});

const search=document.getElementById('search'),cards=document.getElementById('cards');let timer;
search.addEventListener('input',()=>{clearTimeout(timer);timer=setTimeout(load,300);});
async function load(){const q=search.value.trim();cards.innerHTML='';if(!q)return;const snap=await db.collection('pets').where('name','>=',q).where('name','<=',q+'\uf8ff').get();
if(snap.empty){cards.innerHTML='<p class="col-span-full text-gray-400 text-center">ç„¡è³‡æ–™</p>';return;}
snap.forEach(doc=>{const d=doc.data();const card=document.createElement('div');card.className='bg-white rounded-xl shadow hover:shadow-lg p-2 cursor-pointer';card.innerHTML=`<img src="${d.images?.[0]||''}" class="w-full aspect-square object-cover rounded mb-2"><p class="text-center font-medium text-sm">${d.name}</p>`;card.onclick=()=>openModal(doc.id,d);cards.appendChild(card);});}

const modal=document.getElementById('modal');const mainImg=document.getElementById('main-img');const thumbs=document.getElementById('thumbs');
const modalName=modal-name,modalInfo=modal-info,modalDesc=modal-desc,editForm=edit-form;
let currentId=null,currentData=null;

function openModal(id,data){
  currentId=id;currentData=data;document.body.classList.add('modal-open');
  modal.classList.remove('hidden');
  mainImg.src=data.images?.[0]||'';thumbs.innerHTML='';data.images?.forEach(u=>{const i=document.createElement('img');i.src=u;i.onclick=()=>mainImg.src=u;thumbs.appendChild(i);});
  modalName.textContent=data.name;modalInfo.textContent=`${data.type==='cat'?'è²“':'ç‹—'}ï½œ${data.breed}ï½œ${data.gender}${data.age?'ï½œ'+data.age:''}`;modalDesc.textContent=data.desc;
  editForm.classList.add('hidden');adopt-upload.classList.add('hidden');adopt-btn.classList.remove('hidden');
}
close-modal.onclick=()=>{modal.classList.add('hidden');document.body.classList.remove('modal-open');};

delete-btn.onclick=async()=>{if(confirm('ç¢ºå®šåˆªé™¤æ­¤è³‡æ–™ï¼Ÿ')){await db.collection('pets').doc(currentId).delete();alert('å·²åˆªé™¤');modal.classList.add('hidden');load();}};

adopt-btn.onclick=()=>{adopt-btn.classList.add('hidden');adopt-upload.classList.remove('hidden');};
save-adopt.onclick=async()=>{
  const files=[...adopt-photos.files];const urls=[];
  for(const f of files){const ref=storage.ref(`adopted_photos/${currentId}/${f.name}`);await ref.put(f);urls.push(await ref.getDownloadURL());}
  await db.collection('adopted').doc(currentId).set({...currentData,adoptPhotos:urls});
  await db.collection('pets').doc(currentId).delete();
  alert('è¦å¹¸ç¦å–” ğŸ’•');modal.classList.add('hidden');document.body.classList.remove('modal-open');load();
};

edit-btn.onclick=()=>{editForm.classList.toggle('hidden');
  if(!editForm.classList.contains('hidden')){
    editForm.innerHTML=`<input id="edit-name" value="${currentData.name}" placeholder="åå­—">
      <input id="edit-age" value="${currentData.age}" placeholder="å¹´é½¡">
      <select id="edit-gender"><option ${currentData.gender==='ç”·ç”Ÿ'?'selected':''}>ç”·ç”Ÿ</option><option ${currentData.gender==='å¥³ç”Ÿ'?'selected':''}>å¥³ç”Ÿ</option></select>
      <textarea id="edit-desc" rows="3">${currentData.desc}</textarea>
      <button id="save-edit" class="bg-rose-500 text-white px-3 py-2 rounded">å„²å­˜ä¿®æ”¹</button>`;
    document.getElementById('save-edit').onclick=async()=>{
      await db.collection('pets').doc(currentId).update({name:edit-name.value,age:edit-age.value,gender:edit-gender.value,desc:edit-desc.value});
      alert('å·²æ›´æ–°');modal.classList.add('hidden');document.body.classList.remove('modal-open');load();
    };
  }
};
</script>
</body>
</html>
