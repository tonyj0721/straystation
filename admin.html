<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç®¡ç†å“¡å¾Œå°ï½œæµªæµªè½‰é‹ç«™ Ã— å°ä¸­ç°¡åª½åª½ç‹—åœ’</title>
  <style>
    :root { --brand:#0f766e; --danger:#b91c1c; --muted:#6b7280; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif;background:#f7fafc;color:#0f172a;margin:0}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:20px;margin:8px 0}
    .bar{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .btn{appearance:none;border:1px solid #e5e7eb;background:#fff;color:#111827;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:960px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card h2{font-size:16px;margin:0;padding:12px 16px;border-bottom:1px solid #e5e7eb}
    .card .content{padding:16px}
    .row{display:grid;grid-template-columns:140px 1fr;align-items:center;gap:8px;margin:8px 0}
    input[type=text], select, textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px}
    textarea{min-height:92px}
    .hint{color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #e5e7eb;padding:10px;text-align:left;font-size:14px}
    tr:hover{background:#f8fafc}
    .tag{display:inline-block;padding:2px 6px;border-radius:999px;background:#ecfeff;color:#155e75;font-size:12px;border:1px solid #a5f3fc}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex}
    .sheet{background:#fff;border-radius:16px;max-width:1000px;width:100%;display:grid;grid-template-columns:1fr;overflow:hidden}
    @media(min-width:960px){.sheet{grid-template-columns:1fr 1fr}}
    .sheet .media{background:#0b1020;display:flex;flex-direction:column}
    .sheet .media img{width:100%;height:360px;object-fit:cover;background:#111}
    .thumbs{display:flex;gap:6px;flex-wrap:wrap;padding:8px;background:#0b1020}
    .thumbs img{width:60px;height:60px;object-fit:cover;border-radius:6px;opacity:.75;border:2px solid transparent;cursor:pointer}
    .thumbs img.active{opacity:1;border-color:#22d3ee}
    .sheet .body{max-height:70vh;overflow:auto;padding:16px}
    .sheet header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid #e5e7eb}
    .iconbtn{border:none;background:transparent;cursor:pointer;font-size:20px}
    .right-actions{display:flex;gap:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap bar">
      <h1>ç®¡ç†å“¡å¾Œå°</h1>
      <div>
        <span id="who" class="hint"></span>
        <button id="loginBtn" class="btn">ç®¡ç†å“¡ç™»å…¥ï¼ˆGoogleï¼‰</button>
        <button id="logoutBtn" class="btn" style="display:none">ç™»å‡º</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="loginGate" class="card" style="display:none">
      <div class="content">
        <p>è«‹å…ˆä»¥ Google å¸³è™Ÿç™»å…¥ï¼Œé™ç®¡ç†å“¡ä½¿ç”¨ã€‚</p>
        <button id="loginBtn2" class="btn primary">ç®¡ç†å“¡ç™»å…¥</button>
      </div>
    </div>

    <div class="grid">
      <!-- æ–°å¢å‹•ç‰©è³‡æ–™ -->
      <section id="adminArea" class="card" style="display:none">
        <h2>æ–°å¢å‹•ç‰©è³‡æ–™</h2>
        <div class="content">
          <div class="row"><label>åå­—</label><input id="fName" type="text" placeholder="ä¾‹å¦‚ï¼šå¥ˆå¥ˆ" /></div>
          <div class="row"><label>é¡åˆ¥</label>
            <select id="fType">
              <option value="">è«‹é¸æ“‡</option>
              <option value="è²“">è²“</option>
              <option value="ç‹—">ç‹—</option>
            </select>
          </div>
          <div class="row"><label>ä¸»å“ç¨®</label>
            <select id="fBreedMain">
              <option value="">è«‹å…ˆé¸é¡åˆ¥</option>
            </select>
          </div>
          <div class="row"><label>æ¬¡å“ç¨®</label>
            <select id="fBreedSub">
              <option value="">è«‹å…ˆé¸ä¸»å“ç¨®</option>
            </select>
          </div>
          <div class="row"><label>å¹´é½¡</label><input id="fAge" type="text" placeholder="3å€‹æœˆ / 5æ­² / ä¸åˆ°1æ­²" /></div>
          <div class="row"><label>æ€§åˆ¥</label>
            <select id="fGender">
              <option value="">è«‹é¸æ“‡</option>
              <option value="ç”·ç”Ÿ">ç”·ç”Ÿ</option>
              <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
            </select>
          </div>
          <div class="row"><label>ç°¡ä»‹</label><textarea id="fDesc" placeholder="å€‹æ€§ã€ç¿’æ…£ã€æ³¨æ„äº‹é …â€¦"></textarea></div>
          <div class="row"><label>ä¸Šå‚³ç…§ç‰‡</label>
            <input id="fImages" type="file" accept="image/*" multiple />
            <div class="hint">æœ€å¤š 6 å¼µï¼Œå»ºè­° 1200Ã—900 ä»¥ä¸Šã€‚</div>
          </div>
          <div class="row">
            <div></div>
            <button id="submitBtn" class="btn primary">ç™»éŒ„</button>
          </div>
          <div id="formMsg" class="hint"></div>
        </div>
      </section>

      <!-- å·²ç™»å…¥è³‡æ–™åˆ—è¡¨ -->
      <section class="card">
        <h2>å·²ç™»éŒ„è³‡æ–™</h2>
        <div class="content">
          <table>
            <thead>
              <tr>
                <th style="width:32%">åå­—</th>
                <th style="width:18%">é¡åˆ¥</th>
                <th style="width:36%">å“ç¨®</th>
                <th style="width:14%">ç‹€æ…‹</th>
              </tr>
            </thead>
            <tbody id="listBody"></tbody>
          </table>
          <div class="hint" id="emptyHint" style="display:none">ç›®å‰æ²’æœ‰è³‡æ–™ã€‚</div>
        </div>
      </section>
    </div>
  </main>

  <!-- å‹•ç‰©å¡ç‰‡ Modal -->
  <div id="modal" class="modal">
    <div class="sheet">
      <div class="media">
        <img id="modalHero" src="" alt="" />
        <div id="modalThumbs" class="thumbs"></div>
      </div>
      <div class="body">
        <header>
          <strong id="modalTitle">â€”</strong>
          <div class="right-actions">
            <button id="editBtn" class="iconbtn" title="ç·¨è¼¯">âœï¸</button>
            <button id="deleteBtn" class="iconbtn" title="åˆªé™¤">ğŸ—‘ï¸</button>
            <button id="closeBtn" class="iconbtn" title="é—œé–‰">âœ–</button>
          </div>
        </header>
        <div style="padding:12px 16px">
          <p><span class="tag" id="modalType">â€”</span></p>
          <p id="modalBreed">â€”</p>
          <p id="modalAgeGender">â€”</p>
          <p id="modalDesc" style="white-space:pre-wrap"></p>
          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="adoptedBtn" class="btn">æ¨™è¨˜ç‚ºã€Œå·²é ˜é¤Šã€</button>
            <a id="viewOnSite" class="btn" target="_blank">å‰å¾€å‰å°é è¦½</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (modular) -->
  <script type="module">
    /***** âœ… Firebase åˆå§‹åŒ– *****/
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, doc, getDocs, orderBy, query, serverTimestamp, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL, listAll } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js';

    // âš ï¸ ä¾ç…§ä½ æä¾›çš„è¨­å®šã€‚å¦‚æœä¸Šå‚³é‡åˆ° bucket éŒ¯èª¤ï¼Œå¯æŠŠ storageBucket æ”¹æˆ `straystation.appspot.com`ã€‚
    const firebaseConfig = { 
      apiKey: "AIzaSyAoqT5ynGi7KlrCF7UZ0TrD4lbRR8T8lT0",
      authDomain: "straystation.firebaseapp.com",
      projectId: "straystation",
      storageBucket: "straystation.firebasestorage.app",
      messagingSenderId: "611366379195",
      appId: "1:611366379195:web:ef5a632e88d8bba1d6139e",
      measurementId: "G-YBC0MQBC2F"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    const adminEmails = ["tonyj0721@gmail.com", "cookiech0926@gmail.com"]; // å¯æ—¥å¾Œæ“´å……

    /***** âœ… UI å…ƒä»¶ *****/
    const who = document.getElementById('who');
    const loginBtn = document.getElementById('loginBtn');
    const loginBtn2 = document.getElementById('loginBtn2');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginGate = document.getElementById('loginGate');
    const adminArea = document.getElementById('adminArea');
    const formMsg = document.getElementById('formMsg');

    const fName = document.getElementById('fName');
    const fType = document.getElementById('fType');
    const fBreedMain = document.getElementById('fBreedMain');
    const fBreedSub = document.getElementById('fBreedSub');
    const fAge = document.getElementById('fAge');
    const fGender = document.getElementById('fGender');
    const fDesc = document.getElementById('fDesc');
    const fImages = document.getElementById('fImages');
    const submitBtn = document.getElementById('submitBtn');

    const listBody = document.getElementById('listBody');
    const emptyHint = document.getElementById('emptyHint');

    // Modal
    const modal = document.getElementById('modal');
    const modalHero = document.getElementById('modalHero');
    const modalThumbs = document.getElementById('modalThumbs');
    const modalTitle = document.getElementById('modalTitle');
    const modalType = document.getElementById('modalType');
    const modalBreed = document.getElementById('modalBreed');
    const modalAgeGender = document.getElementById('modalAgeGender');
    const modalDesc = document.getElementById('modalDesc');
    const closeBtn = document.getElementById('closeBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const editBtn = document.getElementById('editBtn');
    const adoptedBtn = document.getElementById('adoptedBtn');
    const viewOnSite = document.getElementById('viewOnSite');

    let currentDoc = null; // ç›®å‰åœ¨ modal çš„æ–‡ä»¶å¿«å–

    /***** âœ… Google ç™»å…¥æµç¨‹ *****/
    const doLogin = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        alert('ç™»å…¥å¤±æ•—ï¼š' + e.message);
      }
    };
    loginBtn.onclick = doLogin;
    if (loginBtn2) loginBtn2.onclick = doLogin;
    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      if (user && adminEmails.includes(user.email)) {
        who.textContent = `å·²ç™»å…¥ï¼š${user.displayName ?? ''} (${user.email})`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        loginGate.style.display = 'none';
        adminArea.style.display = 'block';
      } else {
        if (user && !adminEmails.includes(user.email)) {
          alert('ä½ ä¸æ˜¯ç®¡ç†å“¡ï¼Œå·²ç™»å‡º');
          signOut(auth);
        }
        who.textContent = '';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        loginGate.style.display = 'block';
        adminArea.style.display = 'none';
      }
    });

    /***** âœ… å“ç¨®é¸å–®ï¼šä¸»/æ¬¡ç´šå‹•æ…‹ *****/
    const options = {
      è²“: {
        ä¸»: ['å“ç¨®è²“', 'ç±³å…‹æ–¯'],
        æ¬¡: {
          å“ç¨®è²“: ['ç¾çŸ­','è‹±çŸ­','è—è²“','æš¹ç¾…è²“','æ³¢æ–¯è²“','å¸ƒå¶è²“','æ›¼èµ¤è‚¯'],
          ç±³å…‹æ–¯: ['æ©˜è²“','é»‘è²“','è™æ–‘è²“','ç™½åº•è™æ–‘è²“','ä¸‰èŠ±è²“','ç³ç‘è²“','ç™½è²“']
        }
      },
      ç‹—: {
        ä¸»: ['å“ç¨®çŠ¬', 'ç±³å…‹æ–¯'],
        æ¬¡: {
          å“ç¨®çŠ¬: ['åšç¾','è²´è³“','å‰å¨ƒå¨ƒ','é¦¬çˆ¾æ¿Ÿæ–¯','æŸ¯åŸº','æŸ´çŠ¬','å“ˆå£«å¥‡','é«˜å±±çŠ¬','é»ƒé‡‘çµçŠ¬'],
          ç±³å…‹æ–¯: ['é»‘è‰²','ç™½è‰²','é»ƒè‰²','æ£•è‰²','è™æ–‘','èŠ±èŠ±']
        }
      }
    };

    function fillBreedMain(){
      const type = fType.value || '';
      fBreedMain.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
      fBreedSub.innerHTML = '<option value="">è«‹å…ˆé¸ä¸»å“ç¨®</option>';
      if(!type) return;
      options[type].ä¸».forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v; fBreedMain.appendChild(opt);
      });
    }
    function fillBreedSub(){
      const type = fType.value;
      const main = fBreedMain.value;
      fBreedSub.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
      if(!type || !main) return;
      options[type].æ¬¡[main].forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v; fBreedSub.appendChild(opt);
      });
    }
    fType.addEventListener('change', fillBreedMain);
    fBreedMain.addEventListener('change', fillBreedSub);

    /***** âœ… å»ºç«‹å“ç¨®é¡¯ç¤ºå­—ä¸² *****/
    function composeBreed(main, sub){
      if (!main) return '';
      if (main === 'ç±³å…‹æ–¯' && sub) return `ç±³å…‹æ–¯/${sub}`;
      if ((main === 'å“ç¨®è²“' || main === 'å“ç¨®çŠ¬') && sub) return sub;
      return main;
    }

    /***** âœ… æ–°å¢å‹•ç‰© *****/
    submitBtn.addEventListener('click', async ()=>{
      const name = fName.value.trim();
      const type = fType.value;
      const breedMain = fBreedMain.value;
      const breedSub = fBreedSub.value;
      const age = fAge.value.trim();
      const gender = fGender.value;
      const desc = fDesc.value.trim();
      const files = Array.from(fImages.files||[]).slice(0,6);

      if(!name || !type || !breedMain || !gender){
        formMsg.textContent = 'è«‹è‡³å°‘å¡«ï¼šåå­—ã€é¡åˆ¥ã€ä¸»å“ç¨®ã€æ€§åˆ¥ã€‚';
        return;
      }
      submitBtn.disabled = true;
      formMsg.textContent = 'ä¸Šå‚³ä¸­â€¦';

      try {
        // å…ˆå»ºç«‹ doc ä»¥å–å¾— ID
        const base = {
          name, type, breedMain, breedSub, age, gender, desc,
          imageUrls: [], available: true, createdAt: serverTimestamp()
        };
        const docRef = await addDoc(collection(db,'pets'), base);

        // ä¸Šå‚³åœ–ç‰‡ï¼ˆè‹¥æœ‰ï¼‰åˆ° pets/{docId}/
        const urls = [];
        for (const f of files){
          const path = `pets/${docRef.id}/${Date.now()}_${f.name}`;
          const r = ref(storage, path);
          await uploadBytes(r, f);
          const url = await getDownloadURL(r);
          urls.push(url);
        }
        if (urls.length){
          await updateDoc(doc(db,'pets',docRef.id), { imageUrls: urls });
        }
        formMsg.textContent = 'æ–°å¢å®Œæˆï¼';
        // æ¸…è¡¨å–®
        [fName, fAge, fDesc].forEach(i=>i.value='');
        fType.value = ''; fillBreedMain(); fGender.value=''; fImages.value='';
        await loadList();
      } catch (e){
        console.error(e);
        alert('æ–°å¢å¤±æ•—ï¼š'+e.message);
      } finally {
        submitBtn.disabled = false;
      }
    });

    /***** âœ… è¼‰å…¥åˆ—è¡¨ *****/
    async function loadList(){
      listBody.innerHTML = '';
      const q = query(collection(db,'pets'), orderBy('createdAt','desc'));
      const snap = await getDocs(q);
      if (snap.empty){ emptyHint.style.display='block'; return; }
      emptyHint.style.display='none';
      snap.forEach(d=>{
        const v = d.data();
        const tr = document.createElement('tr');
        const breedText = composeBreed(v.breedMain, v.breedSub);
        tr.innerHTML = `
          <td>${v.name||''}</td>
          <td>${v.type||''}</td>
          <td>${breedText||''}</td>
          <td>${v.available===false?'<span class="tag">å·²é ˜é¤Š</span>':'â€”'}</td>
        `;
        tr.style.cursor='pointer';
        tr.addEventListener('click', ()=>openModal(d.id, v));
        listBody.appendChild(tr);
      });
    }

    /***** âœ… Modal é–‹é—œèˆ‡å…§å®¹ *****/
    function openModal(id, v){
      currentDoc = { id, data: v };
      modal.classList.add('open');
      modalTitle.textContent = v.name || 'â€”';
      modalType.textContent = v.type || '';
      modalBreed.textContent = composeBreed(v.breedMain, v.breedSub) || '';
      modalAgeGender.textContent = `${v.age? v.age+'ãƒ»':''}${v.gender||''}`;
      modalDesc.textContent = v.desc || '';
      viewOnSite.href = `./home.html#${id}`; // å¯è‡ªè¨‚å‰å°å®šä½è¦å‰‡

      const imgs = Array.isArray(v.imageUrls)? v.imageUrls: [];
      modalHero.src = imgs[0] || '';
      modalThumbs.innerHTML = '';
      imgs.forEach((u,idx)=>{
        const i = document.createElement('img'); i.src = u; if(idx===0)i.classList.add('active');
        i.onclick = ()=>{ modalHero.src=u; [...modalThumbs.children].forEach(c=>c.classList.remove('active')); i.classList.add('active'); };
        modalThumbs.appendChild(i);
      });
    }
    function closeModal(){ modal.classList.remove('open'); currentDoc=null; }
    closeBtn.onclick = closeModal;
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

    /***** âœ… ç·¨è¼¯ï¼ˆå¿«é€Ÿæ”¹ã€Œå·²é ˜é¤Šã€èˆ‡åˆªé™¤ã€ï¼‰ *****/
    adoptedBtn.onclick = async ()=>{
      if(!currentDoc) return;
      try{
        await updateDoc(doc(db,'pets',currentDoc.id), { available:false });
        alert('å·²æ¨™è¨˜ç‚ºã€Œå·²é ˜é¤Šã€ã€‚');
        closeModal();
        loadList();
      }catch(e){ alert('æ›´æ–°å¤±æ•—ï¼š'+e.message); }
    };

    deleteBtn.onclick = async ()=>{
      if(!currentDoc) return;
      if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™ï¼Ÿï¼ˆåœ–ç‰‡æª”éœ€æ–¼ Storage æ‰‹å‹•æ¸…ç†ï¼‰')) return;
      try{
        await deleteDoc(doc(db,'pets',currentDoc.id));
        alert('å·²åˆªé™¤ã€‚');
        closeModal();
        loadList();
      }catch(e){ alert('åˆªé™¤å¤±æ•—ï¼š'+e.message); }
    };

    editBtn.onclick = ()=>{
      if(!currentDoc) return;
      const v = currentDoc.data;
      // å°‡è³‡æ–™å¸¶å›è¡¨å–®ä»¥ä¾¿å¿«é€Ÿä¿®æ”¹
      fName.value = v.name||'';
      fType.value = v.type||''; fillBreedMain();
      fBreedMain.value = v.breedMain||''; fillBreedSub();
      fBreedSub.value = v.breedSub||'';
      fAge.value = v.age||'';
      fGender.value = v.gender||'';
      fDesc.value = v.desc||'';
      closeModal();
      window.scrollTo({top:0,behavior:'smooth'});
      formMsg.textContent = 'ï¼ˆå¾åˆ—è¡¨å¸¶å…¥äº†è³‡æ–™ï¼Œå¦‚éœ€è¦†è“‹è«‹ç›´æ¥é‡æ–°æäº¤å»ºç«‹æ–°ç‰ˆæœ¬ï¼Œæˆ–å¦è¡Œæ’°å¯«ã€Œè¦†è“‹æ›´æ–°ã€æµç¨‹ï¼‰';
    };

    // åˆæ¬¡è¼‰å…¥åˆ—è¡¨
    loadList();
  </script>
</body>
</html>