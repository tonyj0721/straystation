<!DOCTYPE html>
<html lang="zh-Hant">
>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>浪浪轉運站｜管理員新增動物資料</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

    // ⚠️ 替換為你的 Firebase 設定
    const firebaseConfig = {
      apiKey: "你的 API KEY",
      authDomain: "straystation.firebaseapp.com",
      projectId: "straystation",
      storageBucket: "straystation.firebasestorage.app",
      messagingSenderId: "611366379195",
      appId: "1:611366379195:web:ef5a632e88d8bba1d6139e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("addPetForm");
      const speciesSelect = document.getElementById("species");
      const breedTypeWrap = document.getElementById("breedTypeWrap");
      const breedType = document.getElementById("breedType");
      const breedWrap = document.getElementById("breedWrap");
      const breed = document.getElementById("breed");
      const photoInput = document.getElementById("photos");

      // 🐾 重置品種選單
      function resetBreed() {
        breedType.value = "";
        breed.innerHTML = "";
        breed.value = "";

        breedTypeWrap.classList.add("hidden");
        breedWrap.classList.add("hidden");
        breedType.disabled = true;
        breed.disabled = true;
      }

      // 🐾 類別選擇
      speciesSelect.addEventListener("change", () => {
        if (speciesSelect.value === "貓") {
          breedTypeWrap.classList.remove("hidden");
          breedType.disabled = false;
        } else {
          resetBreed(); // 選狗或清空時全部收回
        }
      });

      // 🐱 品種第二層
      breedType.addEventListener("change", () => {
        breed.innerHTML = `<option value="">請選擇</option>`;
        let options = [];
        if (breedType.value === "品種貓") {
          options = ["美短", "英短", "藍貓", "暹羅貓", "波斯貓", "布偶貓", "曼赤肯"];
        } else if (breedType.value === "米克斯") {
          options = ["橘貓", "黑貓", "虎斑貓", "白底虎斑貓", "三花貓", "玳瑁貓", "白貓"];
        }

        if (options.length > 0) {
          options.forEach((opt) => {
            const option = document.createElement("option");
            option.value = option.textContent = opt;
            breed.appendChild(option);
          });
          breedWrap.classList.remove("hidden");
          breed.disabled = false;
        } else {
          breedWrap.classList.add("hidden");
          breed.disabled = true;
        }
      });

      // 📸 表單送出
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // 非貓時清空貓品種欄位
        if (speciesSelect.value !== "貓") {
          breedType.value = "";
          breed.value = "";
        }

        const data = Object.fromEntries(new FormData(form).entries());
        const files = photoInput.files;
        const imageUrls = [];

        if (files.length > 5) {
          alert("最多只能上傳 5 張圖片！");
          return;
        }

        try {
          // 上傳照片
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileRef = ref(storage, `pets/${Date.now()}_${file.name}`);
            await uploadBytes(fileRef, file);
            const url = await getDownloadURL(fileRef);
            imageUrls.push(url);
          }

          data.images = imageUrls;
          data.createdAt = serverTimestamp();

          await addDoc(collection(db, "pets"), data);
          alert(`🐾 已成功新增 ${data.name}！`);
          form.reset();
          resetBreed();
        } catch (err) {
          console.error("❌ 新增失敗：", err);
          alert("上傳或新增失敗，請檢查 Console。");
        }
      });
    });
  </script>
</head>

<body class="p-6 bg-gray-50 font-sans">
  <h1 class="text-2xl font-bold mb-4">🐶 新增浪浪資料</h1>

  <form id="addPetForm" class="grid gap-4 max-w-md bg-white p-6 rounded-lg shadow">
    <label>名字
      <input name="name" class="border rounded w-full p-2" required />
    </label>

    <label>類別
      <select name="species" id="species" class="border rounded w-full p-2" required>
        <option value="">請選擇</option>
        <option value="貓">貓咪</option>
        <option value="狗">狗狗</option>
      </select>
    </label>

    <div id="breedTypeWrap" class="hidden">
      <label>品種類別
        <select id="breedType" name="breedType" class="border rounded w-full p-2" disabled>
          <option value="">請選擇</option>
          <option value="品種貓">品種貓</option>
          <option value="米克斯">米克斯</option>
        </select>
      </label>
    </div>

    <div id="breedWrap" class="hidden">
      <label>品種
        <select id="breed" name="breed" class="border rounded w-full p-2" disabled></select>
      </label>
    </div>

    <label>年齡
      <input name="age" class="border rounded w-full p-2" />
    </label>

    <label>性別
      <select name="gender" class="border rounded w-full p-2">
        <option value="">請選擇</option>
        <option value="男生">男生</option>
        <option value="女生">女生</option>
      </select>
    </label>

    <label>簡介
      <textarea name="desc" class="border rounded w-full p-2" rows="3"></textarea>
    </label>

    <label>上傳照片（最多5張）
      <input type="file" id="photos" accept="image/*" multiple class="border rounded w-full p-2" />
    </label>

    <button class="bg-brand-500 hover:bg-brand-600 text-white py-2 rounded">新增浪浪</button>
  </form>
</body>
</html>
