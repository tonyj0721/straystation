<!doctype html>
<html lang="zh-Hant-TW">

<head>
  <meta charset="utf-8" />

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YBC0MQBC2F"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    // è‹¥åœ¨æœ¬æ©Ÿé–‹ç™¼ï¼Œé–‹å•Ÿ DebugViewï¼›æ­£å¼ç«™ä¸æœƒé–‹
    gtag('config', 'G-YBC0MQBC2F', { debug_mode: location.hostname.includes('localhost') });
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="images/dogpaw-32.png" sizes="32x32" type="image/png">
  <link rel="apple-touch-icon" href="images/dogpaw-180.png">
  <title>ç®¡ç†å¾Œå°ï½œå°ä¸­ç°¡åª½åª½ç‹—åœ’</title>
  <meta name="description" content="TailwindCSS + Firebase Firestore å¾Œå°ï¼šç™»éŒ„ã€ç®¡ç†å‹•ç‰©è³‡æ–™ï¼›æ²¿ç”¨å‰å° Modal/Lightboxã€‚" />
  <meta name="theme-color" content="#fcd34d">
  <link rel="stylesheet" href="assets/tailwind.css">
  <link rel="stylesheet" href="assets/shared.css">
</head>

<body class="text-gray-800 bg-gradient-to-br from-brand-50 to-white">
  <!-- Navbar -->
  <header class="bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <a href="index.html" class="flex items-center gap-2 font-semibold text-2xl">
          <span>ç®¡ç†å¾Œå°</span>
        </a>

        <!-- æ¡Œæ©Ÿå°è¦½ -->
        <nav class="hidden md:flex items-center gap-6 ml-auto">
          <a href="index.html" class="hover:text-brand-600">é¦– é </a>
          <a href="cats.html" class="hover:text-brand-600">æˆ‘æƒ³é¤Šè²“å’ª</a>
          <a href="dogs.html" class="hover:text-brand-600">æˆ‘æƒ³é¤Šç‹—ç‹—</a>
          <a href="about.html" class="hover:text-brand-600">é—œæ–¼ç°¡åª½åª½</a>
          <a href="home.html" class="hover:text-brand-600">å¹¸ç¦çš„æ­¸å®¿</a>
        </nav>

        <!-- æ‰‹æ©Ÿæ¼¢å ¡éˆ• -->
        <div class="flex items-center gap-2">
          <button id="menuBtn"
            class="md:hidden p-2 rounded-lg border border-[#AEDDEF] bg-white/80 hover:bg-[#AEDDEF]/10" aria-label="é–‹å•Ÿé¸å–®"
            aria-haspopup="menu" aria-expanded="false" aria-controls="menuOverlay">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </header>
  <!-- é€æ˜è¦†è“‹å±¤ï¼šå°ˆé–€æ¥ã€Œé»å¤–é¢é—œé–‰ã€ -->
  <div id="menuOverlay" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
    <div id="overlayClickArea" class="absolute inset-0"></div>

    <!-- å³ä¸Šè§’å½ˆå‡ºé¸å–®ï¼šå›ºå®šä½ç½®ï¼Œä¸æ¨ç‰ˆï¼Œè¦†è“‹ hero -->
    <nav id="menuPanel" class="fixed opacity-0 scale-y-0 origin-top-right rounded-2xl shadow-xl
            bg-[#AEDDEF] w-fit max-w-[90vw] p-3 transition duration-150 ease-out">
      <!-- å°ç®­é ­ï¼ˆåŒé¢æ¿è‰²ï¼‰ -->
      <div class="absolute -top-2 right-5 w-3 h-3 rotate-45 bg-[#AEDDEF]"></div>

      <!-- æŒ‰éˆ•ç¾¤ï¼šä¿ç•™ space-y-2ã€å­—é«” 18px -->
      <ul class="space-y-2 py-1 text-[18px]" role="menu" aria-orientation="vertical" tabindex="-1">
        <li>
          <a href="index.html" role="menuitem" tabindex="-1" class="flex w-full items-center gap-3 whitespace-nowrap rounded-xl bg-white px-4 py-2
            text-slate-700 shadow hover:shadow-md hover:bg-white/95 active:scale-[0.99]
            focus:outline-none focus:ring-2 focus:ring-white/70">
            <span aria-hidden="true" class="grid size-8 place-items-center rounded-lg bg-white shadow text-xl">ğŸ§­</span>
            <span class="flex-1 text-center">é¦–&emsp;&emsp;é </span>
          </a>
        </li>

        <li>
          <a href="cats.html" role="menuitem" tabindex="-1" class="flex items-center gap-3 whitespace-nowrap rounded-xl bg-white px-4 py-2
                text-slate-700 shadow hover:shadow-md hover:bg-white/95 active:scale-[0.99]
                focus:outline-none focus:ring-2 focus:ring-white/70">
            <span aria-hidden="true" class="text-xl leading-none">ğŸ±</span>
            <span>æˆ‘æƒ³é¤Šè²“å’ª</span>
          </a>
        </li>

        <li>
          <a href="dogs.html" role="menuitem" tabindex="-1" class="flex items-center gap-3 whitespace-nowrap rounded-xl bg-white px-4 py-2
                text-slate-700 shadow hover:shadow-md hover:bg-white/95 active:scale-[0.99]
                focus:outline-none focus:ring-2 focus:ring-white/70">
            <span aria-hidden="true" class="text-xl leading-none">ğŸ¶</span>
            <span>æˆ‘æƒ³é¤Šç‹—ç‹—</span>
          </a>
        </li>

        <li>
          <a href="about.html" role="menuitem" tabindex="-1" class="flex items-center gap-3 whitespace-nowrap rounded-xl bg-white px-4 py-2
                text-slate-700 shadow hover:shadow-md hover:bg-white/95 active:scale-[0.99]
                focus:outline-none focus:ring-2 focus:ring-white/70">
            <span aria-hidden="true" class="text-xl leading-none">â„¹ï¸</span>
            <span>é—œæ–¼ç°¡åª½åª½</span>
          </a>
        </li>

        <li>
          <a href="home.html" role="menuitem" tabindex="-1" class="flex items-center gap-3 whitespace-nowrap rounded-xl bg-white px-4 py-2
            text-slate-700 shadow hover:shadow-md hover:bg-white/95 active:scale-[0.99]
            focus:outline-none focus:ring-2 focus:ring-white/70">
            <span aria-hidden="true" class="text-xl leading-none">ğŸ </span>
            <span>å¹¸ç¦çš„æ­¸å®¿</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
  <script>
    const menuBtn = document.getElementById('menuBtn');
    const overlay = document.getElementById('menuOverlay');
    const clickArea = document.getElementById('overlayClickArea');
    const panel = document.getElementById('menuPanel');

    function positionPanel() {
      const r = menuBtn.getBoundingClientRect();
      const gap = 8;
      panel.style.top = '-1000px';
      panel.style.left = '-1000px';
      const w = panel.offsetWidth;
      let left = r.right - w;
      left = Math.max(8, Math.min(left, window.innerWidth - w - 8));
      panel.style.top = (r.bottom + gap) + 'px';
      panel.style.left = left + 'px';
    }
    function openMenu() {
      overlay.classList.remove('hidden');
      positionPanel();
      requestAnimationFrame(() => {
        panel.classList.remove('opacity-0', 'scale-y-0');
        panel.classList.add('scale-y-100');
      });
      document.addEventListener('keydown', onEsc);
      menuBtn.setAttribute('aria-expanded', 'true');
      const firstItem = panel.querySelector('[role="menuitem"]');
      if (firstItem) firstItem.focus();
    }
    function closeMenu() {
      panel.classList.add('opacity-0');
      panel.classList.remove('scale-y-100');
      panel.classList.add('scale-y-0');
      menuBtn.setAttribute('aria-expanded', 'false');
      document.removeEventListener('keydown', onEsc);
      setTimeout(() => overlay.classList.add('hidden'), 150);
      menuBtn.focus();
    }
    function onEsc(e) { if (e.key === 'Escape') closeMenu(); }

    menuBtn.addEventListener('click', () => {
      const expanded = menuBtn.getAttribute('aria-expanded') === 'true';
      expanded ? closeMenu() : openMenu();
    });
    clickArea.addEventListener('click', (e) => {
      if (!panel.contains(e.target) && e.target !== menuBtn) closeMenu();
    });
    panel.addEventListener('keydown', (e) => {
      const items = Array.from(panel.querySelectorAll('[role="menuitem"]'));
      const i = items.indexOf(document.activeElement);
      if (e.key === 'ArrowDown') { e.preventDefault(); items[(i + 1 + items.length) % items.length].focus(); }
      if (e.key === 'ArrowUp') { e.preventDefault(); items[(i - 1 + items.length) % items.length].focus(); }
      if (e.key === 'Home') { e.preventDefault(); items[0].focus(); }
      if (e.key === 'End') { e.preventDefault(); items[items.length - 1].focus(); }
    });
    window.addEventListener('resize', () => {
      if (!overlay.classList.contains('hidden')) positionPanel();
    });
    // é»ä»»ä½•é¸å–®é …ç›®å¾Œå°±é—œé–‰ï¼ˆé¿å…åœç•™ï¼‰
    panel.querySelectorAll('[role="menuitem"]').forEach(el => {
      el.addEventListener('click', () => { try { closeMenu(); } catch (_) { } });
    });
  </script>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h1 class="text-xl sm:text-2xl font-bold mb-4">æ–°å¢ï¼ç®¡ç†å‹•ç‰©è³‡æ–™</h1>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- å·¦ï¼šç™»éŒ„è¡¨å–® -->
      <section class="lg:col-span-1 bg-white rounded-2xl ring-1 ring-gray-200 shadow-soft p-5">
        <h2 class="text-lg font-semibold">ç™»éŒ„è¡¨å–®</h2>
        <p class="text-sm text-gray-500 mb-4">
          ï¼Šå»ºè­°å…ˆç™»å…¥ä¸¦åœ¨ Firestore è¦å‰‡é™åˆ¶å¯«å…¥æ¬Šé™ã€‚
        </p>
        <form id="petForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">åå­— </label>
            <input id="name" class="w-full rounded-xl border border-gray-300 p-2" placeholder="ç•™ç©ºå°‡ä»¥ã€Œæœªå–åã€ä»£æ›¿" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">é¡åˆ¥ </label>
            <div class="flex gap-3">
              <label class="inline-flex items-center gap-2"><input type="radio" name="species" value="è²“"
                  class="accent-brand-600" checked /><span>è²“</span></label>
              <label class="inline-flex items-center gap-2"><input type="radio" name="species" value="ç‹—"
                  class="accent-brand-600" /><span>ç‹—</span></label>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">å“ç¨®</label>
              <select id="breedType" class="w-full rounded-xl border border-gray-300 bg-white p-2 text-sm">
                <option value="">è«‹é¸æ“‡</option>
              </select>
            </div>
            <div>
              <label id="breedLabel" class="block text-sm font-medium mb-1">å“ç¨®/æ¯›è‰²</label>
              <select id="breed" class="w-full rounded-xl border border-gray-300 bg-white p-2 text-sm" disabled>
                <option value="">è«‹å…ˆé¸æ“‡å“ç¨®</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">å¹´é½¡</label>
              <input id="age" class="w-full rounded-xl border border-gray-300 p-2" placeholder="ä¾‹ï¼š2 æ­² æˆ– 8 å€‹æœˆ" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">æ€§åˆ¥</label>
              <select id="gender" class="w-full rounded-xl border border-gray-300 p-2">
                <option value="">æœªè¨­å®š</option>
                <option value="ç”·ç”Ÿ">ç”·ç”Ÿ</option>
                <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
              </select>
            </div>
          </div>
          <!-- å¥åº· -->
          <div>
            <label class="block text-sm font-medium mb-1">å¥åº·</label>
            <div class="flex items-center gap-6">
              <label class="inline-flex items-center gap-2">
                <input id="neutered" type="checkbox" class="h-4 w-4">
                <span>çµç´®</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input id="vaccinated" type="checkbox" class="h-4 w-4">
                <span>é é˜²é‡</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ç°¡ä»‹</label>
            <textarea id="desc" rows="4" class="w-full rounded-xl border border-gray-300 p-2"
              placeholder="å€‹æ€§ã€ç¿’æ…£ã€èƒŒæ™¯æ•…äº‹ã€æ³¨æ„äº‹é …â€¦"></textarea>
          </div>
          <div>
            <input id="imgFiles" type="file" accept="image/*" multiple class="sr-only" />
            <div class="flex items-center gap-3">
              <button id="btnPick" type="button" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">
                æ–°å¢ç…§ç‰‡
              </button>
              <span id="fileCount" class="text-xs text-gray-500">å·²é¸ 0 / 5 å¼µ</span>
              <span class="text-sm text-gray-400">æœ€å¤š 5 å¼µ</span>
            </div>
            <div id="imgPreview" class="mt-3 grid grid-cols-3 gap-2"></div>
          </div>
          <div class="flex gap-3 pt-2">
            <button id="submitBtn" type="submit"
              class="px-4 py-2 rounded-xl bg-gray-900 text-white hover:bg-gray-800 flex items-center gap-2">
              <span id="submitText">ç™»éŒ„</span>
            </button>
          </div>
        </form>
      </section>

      <!-- å³ï¼šè³‡æ–™è¡¨ -->
      <section class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-2xl ring-1 ring-gray-200 shadow-soft p-5">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <h2 class="text-lg font-semibold">è³‡æ–™è¡¨</h2>
            <div class="relative w-full sm:w-72">
              <input id="searchName" class="w-full rounded-xl border border-gray-300 p-2 pl-9 text-base"
                placeholder="æœå°‹åå­—â€¦" />
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">ğŸ”</span>
            </div>
          </div>
          <div class="hidden md:block overflow-x-auto mt-4">
            <table class="min-w-[640px] w-full text-sm">
              <thead>
                <tr class="text-left text-gray-500">
                  <th class="py-2">åå­—</th>
                  <th class="py-2">é¡åˆ¥</th>
                  <th class="py-2">å“ç¨®</th>
                  <th class="py-2">æ€§åˆ¥</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
          <div class="md:hidden mt-4 grid gap-3" id="rowsMobile"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-50 border-t border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-sm text-gray-500">Â© <span id="year"></span>
      <img src="images/æµªæµªè½‰é‹ç«™ Logo.png" alt="æµªæµªè½‰é‹ç«™ Logo"
        style="display:inline-flex;width:1em;height:1em;vertical-align:-0.15em;margin:0.01em -0.25em 0.01em 0.25em;">
      æµªæµªè½‰é‹ç«™ Stray Station. ä¿ç•™æ‰€æœ‰æ¬Šåˆ©ã€‚
    </div>
  </footer>

  <!-- Pet Detail Modal -->
  <dialog id="petDialog" class="w-full max-w-2xl max-h-[90vh] rounded-2xl p-0 overflow-y-auto">
    <div class="bg-white">
      <!-- æ–°å¢ï¼šèˆ‡ä¸‹æ–¹ç¸®åœ– p-3 å°é½Š -->
      <div class="px-3 pt-2">
        <p class="text-center text-xs text-gray-500 mb-1">é»ä¸»åœ–å¯æ”¾å¤§</p>
        <div class="relative aspect-video bg-gray-100 overflow-hidden rounded-lg">
          <!-- åªæ¨¡ç³Šé€™å¼µèƒŒæ™¯åœ– -->
          <img id="dlgBg" aria-hidden="true" class="absolute inset-0 w-full h-full object-cover blur-md scale-110">

          <!-- å¯é¸ï¼šæŸ”åŒ–ä¸€ä¸‹èƒŒæ™¯ï¼Œæ²’æœ‰åŠ ä»»ä½• blur -->
          <div class="absolute inset-0 bg-white/20"></div>

          <!-- ä¸»åœ–åœ¨æœ€ä¸Šå±¤ï¼Œæ²’æœ‰ blur -->
          <img id="dlgImg" alt="æ¯›å­©ç…§ç‰‡"
            class="relative z-10 block w-full h-full object-contain cursor-pointer rounded-lg">

          <button id="dlgClose" class="absolute top-1 right-1 z-20 bg-black/60 text-white p-2 rounded-full leading-none"
            aria-label="é—œé–‰">âœ•</button>
        </div>
      </div>

      <div id="dlgThumbs" class="flex gap-2 overflow-x-auto p-3"></div>
      <div class="p-5 space-y-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <!-- æ¨™é¡Œ -->
            <h3 id="dlgName" class="text-2xl font-semibold leading-snug">â€”</h3>

            <!-- ä¸‰å€‹åœ“è§’æ¨™ç±¤ï¼šä¸æ›è¡Œã€å¯æ°´å¹³æ²å‹• -->
            <div id="dlgTags" class="mt-1 flex flex-nowrap gap-2 text-sm">
              <span id="dlgTagBreed"
                class="inline-flex items-center rounded-full ring-1 ring-gray-300 bg-orange-100 text-orange-700 px-3 py-1 whitespace-nowrap"></span>
              <span id="dlgTagAge"
                class="inline-flex items-center rounded-full ring-1 ring-gray-300 bg-orange-100 text-orange-700 px-3 py-1 whitespace-nowrap"></span>
              <span id="dlgTagGender"
                class="inline-flex items-center rounded-full ring-1 ring-gray-300 bg-orange-100 text-orange-700 px-3 py-1 whitespace-nowrap"></span>
            </div>
            <!-- ç¬¬äºŒæ’ï¼šçµç´® / é é˜²é‡ï¼ˆæ·¡è—è‰²åœ“è§’æ¨™ç±¤ï¼‰ -->
            <div id="dlgTagsHealth" class="mt-2 flex gap-2 text-sm">
              <span id="dlgTagNeutered"
                class="inline-flex items-center rounded-full ring-1 ring-sky-200 bg-sky-50 text-sky-700 px-3 py-1 whitespace-nowrap"></span>
              <span id="dlgTagVaccinated"
                class="inline-flex items-center rounded-full ring-1 ring-sky-200 bg-sky-50 text-sky-700 px-3 py-1 whitespace-nowrap"></span>
            </div>
          </div>
        </div>
        <div class="bg-orange-50 rounded-xl p-4 leading-7">
          <p id="dlgDesc" class="text-gray-700 text-sm whitespace-pre-line break-words"></p>
        </div>

        <!-- å…§åµŒç·¨è¼¯å€ -->
        <div id="editArea" class="hidden space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">åå­— <span class="text-red-500">*</span></label>
            <input id="editName" class="w-full rounded-xl border border-gray-300 p-2" />
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">é¡åˆ¥ <span class="text-red-500">*</span></label>
            <div class="flex gap-3">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="editSpecies" value="è²“" class="accent-brand-600" />
                <span>è²“</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="editSpecies" value="ç‹—" class="accent-brand-600" />
                <span>ç‹—</span>
              </label>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">å“ç¨®</label>
              <select id="editBreedType" class="w-full rounded-xl border border-gray-300 p-2">
                <option value="">è«‹é¸æ“‡</option>
              </select>
            </div>
            <div>
              <label id="editBreedLabel" class="block text-sm font-medium mb-1">å“ç¨®/æ¯›è‰²</label>
              <select id="editBreed" class="w-full rounded-xl border border-gray-300 p-2" disabled>
                <option value="">è«‹å…ˆé¸æ“‡å“ç¨®</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">å¹´é½¡</label>
              <input id="editAge" class="w-full rounded-xl border border-gray-300 p-2" placeholder="ä¾‹ï¼š2 æ­² æˆ– 8 å€‹æœˆ" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">æ€§åˆ¥</label>
              <select id="editGender" class="w-full rounded-xl border border-gray-300 p-2">
                <option value="">æœªè¨­å®š</option>
                <option value="ç”·ç”Ÿ">ç”·ç”Ÿ</option>
                <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
              </select>
            </div>
          </div>
          <!-- å¥åº·ï¼ˆç·¨è¼¯ç”¨ï¼‰ -->
          <div>
            <label class="block text-sm font-medium mb-1">å¥åº·</label>
            <div class="flex items-center gap-6">
              <label class="inline-flex items-center gap-2">
                <input id="editNeutered" type="checkbox" class="h-4 w-4">
                <span>çµç´®</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input id="editVaccinated" type="checkbox" class="h-4 w-4">
                <span>é é˜²é‡</span>
              </label>
            </div>
          </div>


          <div>
            <label class="block text-sm font-medium mb-1">ç°¡ä»‹</label>
            <textarea id="editDesc" rows="4" class="w-full rounded-xl border border-gray-300 p-2"></textarea>
          </div>

          <div>
            <input id="editFiles" type="file" accept="image/*" multiple class="sr-only" />
            <div class="flex items-center gap-3">
              <button id="btnPickEdit" type="button"
                class="px-3 py-2 rounded-lg border border-gray-300 text-sm">æ–°å¢ç…§ç‰‡</button>
              <span id="editCount" class="text-xs text-gray-500"></span>
              <span class="text-sm text-gray-400">æœ€å¤š 5 å¼µ</span>
            </div>
            <!-- å’Œæ–°å¢æ¨¡å¼ä¸€è‡´ï¼šä¸‰æ¬„ç¸®åœ– + ä¸Šæ–¹é–“è· -->
            <div id="editPreview" class="mt-3 grid grid-cols-3 gap-2"></div>
          </div>
        </div>

        <!-- å‹•ä½œåˆ— -->
        <div id="actionBar" class="pt-2 grid grid-cols-1 sm:grid-cols-4 gap-3">
          <button id="btnEdit" class="w-full px-4 py-3 rounded-xl border border-gray-300 text-sm">
            ç·¨è¼¯
          </button>
          <button id="btnAdopted" class="w-full px-4 py-3 rounded-xl bg-emerald-600 text-white text-sm">
            å·²é€é¤Š
          </button>
          <button id="btnUnadopt"
            class="w-full px-4 py-3 rounded-xl border border-amber-300 text-amber-700 text-sm hidden">
            é€€é¤Š
          </button>
          <button id="btnDelete" class="w-full px-4 py-3 rounded-xl border border-red-300 text-red-600 text-sm">
            åˆªé™¤
          </button>
        </div>
        <div id="editActionBar" class="hidden pt-2 grid grid-cols-2 gap-3">
          <button id="btnSave"
            class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white text-sm flex items-center justify-center gap-2">
            <span id="saveText">å„²å­˜</span>
          </button>
          <button id="btnCancel" class="w-full px-4 py-3 rounded-xl border border-gray-300 text-sm">
            å–æ¶ˆ
          </button>
        </div>

        <!-- å·²é ˜é¤Šåˆç…§ä¸Šå‚³ -->
        <div id="adoptedUpload" class="hidden">
          <input id="adoptedFiles" type="file" accept="image/*" multiple class="sr-only" />
          <div class="flex items-center gap-3 mb-2">
            <button id="btnPickAdopted" type="button" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">
              é¸æ“‡åˆç…§
            </button>
            <span id="adoptedCount" class="text-xs text-gray-500"></span>
            <span class="text-sm text-gray-400">æœ€å¤š 5 å¼µ</span>
          </div>
          <div id="adoptedPreview" class="mt-1 grid grid-cols-3 gap-2"></div>
          <button id="btnConfirmAdopted" class="mt-3 px-4 py-2 rounded-xl bg-gray-900 text-white text-sm">
            å„²å­˜é ˜é¤Šè³‡è¨Š
          </button>
          <button id="btnCancel" type="button" class="px-3 py-2 rounded-lg bg-gray-200 text-gray-900 hover:bg-gray-300">
            å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[9999]">
    <div id="lbWrap" class="relative inline-block">
      <img id="lbImg" class="max-h-[90vh] max-w-[90vw] object-contain rounded-lg" />
      <button id="lbClose" class="absolute top-1 right-1 z-10 bg-black/60 hover:bg-black/70 text-white rounded-full p-2
           text-2xl leading-none select-none" aria-label="é—œé–‰">âœ•</button>
    </div>
    <div id="lbThumbs"
      class="absolute bottom-20 left-0 w-full flex justify-center px-4 py-2 pb-[env(safe-area-inset-bottom)]">
      <div id="lbThumbsInner" class="flex gap-3"></div>
    </div>
    <button id="lbPrev" class="absolute text-white text-4xl select-none">â®</button>
    <button id="lbNext" class="absolute text-white text-4xl select-none">â¯</button>
  </div>

  <script src="./assets/firebase-config.js"></script>
  <script type="module">
    // å¦‚æœ withStableSearchRender æ²’å®šç¾©ï¼Œå°±é€€æˆã€Œç›´æ¥æ¸²æŸ“ã€
    const renderStable = (typeof withStableSearchRender === 'function')
      ? withStableSearchRender
      : (fn) => fn();

    // --- Set a fixed minimum height for the results area (no inner scrolling) ---
    (function setResultsFloor() {
      const rowsMobile = document.getElementById('rowsMobile');
      const rows = document.getElementById('rows');
      const host = rowsMobile ? rowsMobile.parentElement : (rows ? rows.closest('div') : null);
      if (host) {
        host.style.minHeight = '685px';
      }
    })();

    // ===============================
    // Firebase è¨­å®šèˆ‡åˆå§‹åŒ–
    // ===============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, orderBy, where,
      doc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, limit as fbLimit,
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject, listAll, } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

    const app = initializeApp(window.firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // å…¨åŸŸç‹€æ…‹
    let pets = [];            // ç›®å‰è¼‰å…¥çš„å‹•ç‰©åˆ—è¡¨ï¼ˆæœ€å¤š 15 ç­†ï¼‰
    let currentPetId = null;  // ç›®å‰åœ¨ Dialog ä¸­çš„å‹•ç‰© idï¼ˆç·¨è¼¯/é ˜é¤Šç”¨ï¼‰

    // å°å·¥å…·ï¼šé¸æ“‡å™¨
    const $ = (q) => document.querySelector(q);

    // ===============================
    // å“ç¨®è³‡æ–™èˆ‡ã€Œå“ç¨®/æ¯›è‰²ã€é€£å‹•é‚è¼¯
    // ===============================
    const BREEDS = {
      è²“: {
        å“ç¨®è²“: ["ç¾åœ‹çŸ­æ¯›è²“", "è‹±åœ‹çŸ­æ¯›è²“", "è—è²“", "æš¹ç¾…è²“", "æ³¢æ–¯è²“", "å¸ƒå¶è²“", "ç·¬å› è²“", "æ›¼èµ¤è‚¯", "é‡‘æ¼¸å±¤æ›¼èµ¤è‚¯"],
        ç±³å…‹æ–¯: ["æ©˜è²“", "æ©˜ç™½è²“", "é»‘è²“", "è³“å£«è²“", "è™æ–‘è²“", "ç™½åº•è™æ–‘è²“", "ä¸‰èŠ±è²“", "ç³ç‘è²“", "ç™½è²“"],
      },
      ç‹—: {
        å“ç¨®çŠ¬: ["åšç¾", "è²´è³“", "æ¢—çŠ¬", "å‰å¨ƒå¨ƒ", "è‡˜è…¸çŠ¬", "é¦¬çˆ¾æ¿Ÿæ–¯", "æŸ¯åŸº", "æŸ´çŠ¬", "ç‹ç‹¸çŠ¬", "å“ˆå£«å¥‡", "é«˜å±±çŠ¬", "é»ƒé‡‘çµçŠ¬", "é‚Šå¢ƒç‰§ç¾ŠçŠ¬"],
        ç±³å…‹æ–¯: ["é»‘è‰²", "ç™½è‰²", "é»‘ç™½è‰²", "é»ƒè‰²", "ç™½é»ƒè‰²", "ç±³è‰²", "æ£•è‰²", "é»‘æ£•è‰²", "è™æ–‘", "èŠ±èŠ±"],
      },
    };

    const speciesInputs = document.querySelectorAll('input[name="species"]');
    const breedTypeSel = $("#breedType");
    const breedSel = $("#breed");
    const breedLabel = $("#breedLabel");

    // è®€å–ç›®å‰å‹¾é¸çš„ç‰©ç¨®
    const getSpecies = () =>
      Array.from(speciesInputs).find((i) => i.checked)?.value || "è²“";

    // ä¾ã€Œå“ç¨®é¡å‹ã€èª¿æ•´å³å´æ¨™ç±¤æ–‡å­—
    const updateBreedLabel = () => {
      const t = breedTypeSel.value;
      breedLabel.textContent = !t ? "å“ç¨®/æ¯›è‰²" : t === "ç±³å…‹æ–¯" ? "æ¯›è‰²" : "å“ç¨®";
    };

    // é‡ç½®å³å´ä¸‹æ‹‰
    const resetBreedRight = () => {
      breedSel.disabled = true;
      breedSel.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å“ç¨®</option>';
    };

    // å·¦å´ã€Œå“ç¨®é¡å‹ã€èˆ‡å³å´ã€Œå“ç¨®/æ¯›è‰²ã€åŒæ­¥
    function syncBreedSelectors() {
      const isCat = getSpecies() === "è²“";
      breedTypeSel.innerHTML = isCat
        ? '<option value="">è«‹é¸æ“‡</option><option value="å“ç¨®è²“">å“ç¨®è²“</option><option value="ç±³å…‹æ–¯">ç±³å…‹æ–¯</option>'
        : '<option value="">è«‹é¸æ“‡</option><option value="å“ç¨®çŠ¬">å“ç¨®çŠ¬</option><option value="ç±³å…‹æ–¯">ç±³å…‹æ–¯</option>';
      resetBreedRight();
      updateBreedLabel();
    }

    // ä¾å·¦å´é¸æ“‡ï¼Œå»ºç«‹å³å´é¸é …
    function buildBreedOptions() {
      const list = (BREEDS[getSpecies()] || {})[breedTypeSel.value] || [];
      if (!breedTypeSel.value) {
        resetBreedRight();
        return;
      }
      breedSel.disabled = false;
      breedSel.innerHTML = ['<option value="">è«‹é¸æ“‡</option>']
        .concat(list.map((b) => `<option value="${b}">${b}</option>`))
        .join("");
    }

    // ç¶å®šäº‹ä»¶
    speciesInputs.forEach((i) => i.addEventListener("change", syncBreedSelectors));
    breedTypeSel.addEventListener("change", () => {
      buildBreedOptions();
      updateBreedLabel();
    });
    syncBreedSelectors(); // åˆå§‹åŒ–ä¸€æ¬¡

    // ===============================
    // æ–°å¢ï¼šåœ–ç‰‡é¸å–/é è¦½ï¼ˆæœ€å¤š 5 å¼µï¼‰
    // ===============================
    const imgFiles = $("#imgFiles");
    const btnPick = $("#btnPick");
    const fileCount = $("#fileCount");
    const imgPreview = $("#imgPreview");
    let selectedFiles = []; // æš«å­˜å¾…ä¸Šå‚³æª”æ¡ˆ

    btnPick?.addEventListener("click", () => imgFiles.click());

    // ç”¢ç”Ÿå¸¶æµ®æ°´å°çš„ Blobï¼ˆç´°å­—ã€ç„¡å¤–æ¡†ã€ç–ä¸€é»ï¼‰
    async function addWatermarkToFile(file, { text = "å°ä¸­ç°¡åª½åª½ç‹—åœ’" } = {}) {
      const url = URL.createObjectURL(file);
      try {
        // è®€åœ– & ç•«åŸåœ–
        const img = await new Promise((res, rej) => {
          const im = new Image(); im.onload = () => res(im); im.onerror = rej; im.src = url;
        });
        const W = img.naturalWidth, H = img.naturalHeight;
        const c = document.createElement("canvas");
        c.width = W; c.height = H;
        const g = c.getContext("2d");
        g.drawImage(img, 0, 0, W, H);

        // === ç´°å­—ç„¡å¤–æ¡†æ¨£å¼ï¼ˆå¯èª¿åƒæ•¸ï¼‰ ===
        const ANG = -33 * Math.PI / 180;   // æ–œè§’
        const FS = Math.round(Math.max(W, H) * 0.03);  // å­—é«˜ â‰ˆ é•·é‚Š 6%
        const OP = 0.25;                                  // é€æ˜åº¦
        const STEP_X = Math.max(Math.round(FS * 12), 360); // åŒæ–œç·šé–“è·ï¼ˆå€æ•¸è¶Šå¤§è¶Šç–ï¼‰
        const STEP_Y = Math.max(Math.round(FS * 8), 260);  // æ–œç·šèˆ‡æ–œç·šé–“è·

        const diag = Math.hypot(W, H);

        g.save();
        g.translate(W / 2, H / 2);
        g.rotate(ANG);
        g.font = `600 ${FS}px "Noto Sans TC","Microsoft JhengHei",sans-serif`;
        g.textBaseline = "middle";
        g.fillStyle = `rgba(255,255,255,${OP})`;
        // æƒ³æ›´æŸ”å’Œå¯æ‰“é–‹ä¸‹ä¸€è¡Œï¼š
        // g.globalCompositeOperation = "overlay"; // æˆ– "soft-light"

        // åªå¡«è‰²ï¼Œä¸æé‚Šï¼ˆä¸è¦ strokeText/lineWidth/strokeStyleï¼‰
        for (let x = -diag; x <= diag; x += STEP_X) {
          for (let y = -diag; y <= diag; y += STEP_Y) {
            g.fillText(text, x, y);
          }
        }
        g.restore();

        const out = await new Promise(r => c.toBlob(r, "image/jpeg", 0.85));
        return new File([out], file.name.replace(/\.[^.]+$/, ".jpg"), { type: "image/jpeg" });
      } finally {
        URL.revokeObjectURL(url);
      }
    }

    // æ¸²æŸ“é è¦½æ ¼å­ + åˆªé™¤æŒ‰éˆ•
    function renderPreviews() {
      fileCount.textContent = `å·²é¸ ${selectedFiles.length} / 5 å¼µ`;

      imgPreview.innerHTML = selectedFiles
        .map((f, i) => {
          const u = URL.createObjectURL(f);
          return `
        <div class="relative">
          <img class="w-full aspect-square object-cover rounded-lg" src="${u}" alt="é è¦½">
          <button data-idx="${i}" class="absolute top-1 right-1 bg-black/70 text-white rounded-full w-7 h-7 flex items-center justify-center">âœ•</button>
        </div>
      `;
        })
        .join("");

      // ç¶å®šåˆªé™¤å–®å¼µåœ–ç‰‡
      imgPreview.querySelectorAll("button[data-idx]").forEach((btn) =>
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const i = +btn.dataset.idx;
          selectedFiles.splice(i, 1);
          renderPreviews();
        })
      );
    }

    // æª”æ¡ˆæŒ‘é¸å¾Œï¼šåˆä½µä¸¦æˆªæ–·åˆ° 5 å¼µ
    imgFiles?.addEventListener("change", () => {
      const incoming = Array.from(imgFiles.files || []);
      const next = selectedFiles.concat(incoming);
      if (next.length > 5) {
        Swal.fire({ icon: "warning", title: "æœ€å¤š 5 å¼µç…§ç‰‡" });
      }
      selectedFiles = next.slice(0, 5);
      renderPreviews();
      imgFiles.value = ""; // æ¸…ç©º inputï¼Œé¿å…é‡è¤‡é¸å–ä¸åˆ°
    });

    // ===============================
    // å°å·¥å…·ï¼šæŒ‰éˆ•ä¸Šçš„ã€Œâ€¦ã€è·³å‹•
    // ===============================
    function startDots(span, base) {
      let i = 0;
      span.textContent = base;
      const t = setInterval(() => {
        i = (i + 1) % 4;
        span.textContent = base + ".".repeat(i);
      }, 350);
      return () => clearInterval(t); // å›å‚³åœæ­¢å‡½å¼
    }

    // ===============================
    // è¡¨å–®é€å‡ºï¼šæ–°å¢å‹•ç‰©è³‡æ–™
    // ===============================
    $("#petForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      // è®€å€¼
      const name = ($("#name")?.value || "").trim() || "æœªå–å";

      const rawBreedType = breedTypeSel.value || "";
      const rawBreed = breedSel.value || "";
      let breed = "";
      if (!rawBreedType) {
        breed = "å“ç¨®ä¸è©³";
      } else if (rawBreedType === "ç±³å…‹æ–¯") {
        breed = rawBreed ? `ç±³å…‹æ–¯/${rawBreed}` : "ç±³å…‹æ–¯";
      } else {
        breed = rawBreed || "å“ç¨®ä¸è©³";
      }

      const age = ($("#age")?.value || "").trim() || "å¹´é½¡ä¸è©³";
      const gender = $("#gender")?.value || "æ€§åˆ¥ä¸è©³";
      const desc = ($("#desc")?.value || "").trim() || "ç„¡å‚™è¨»";

      // æ–°å¢çš„åŸºæœ¬ payloadï¼ˆåœ–ç‰‡å…ˆç©ºé™£åˆ—ï¼Œç¨å¾Œè£œï¼‰
      const payload = {
        species: getSpecies(),
        name,
        nameLower: name.toLowerCase(),
        breedType: rawBreedType,
        breed,
        age,
        gender,
        desc,
        neutered: document.getElementById('neutered')?.checked || false,
        vaccinated: document.getElementById('vaccinated')?.checked || false,
        images: [],
        status: "available",
        showOnHome: false,
        showOnCats: true,
        showOnDogs: true,
        showOnIndex: true,
        createdAt: serverTimestamp(), // Firestore ä¼ºæœå™¨æ™‚é–“
      };

      // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰åŒåï¼ˆå¯é¸æ“‡ä»ç„¶æ–°å¢ï¼‰
      if (name !== "æœªå–å") {
        try {
          const dupQ = query(collection(db, "pets"), where("name", "==", name));
          const dupSnap = await getDocs(dupQ);
          if (!dupSnap.empty) {
            const r = await Swal.fire({
              icon: "question",
              title: `åå­—ã€Œ${name}ã€å·²å­˜åœ¨`,
              text: "ç¢ºå®šç¹¼çºŒç™»éŒ„ï¼Ÿ",
              showCancelButton: true,
              confirmButtonText: "ç¢ºå®š",
              cancelButtonText: "å–æ¶ˆ",
            });
            if (!r.isConfirmed) return;
          }
        } catch (err) {
          console.error("é‡è¤‡æª¢æŸ¥éŒ¯èª¤ï¼š", err);
        }
      }

      // æŒ‰éˆ•é€²åº¦ç‹€æ…‹
      const submitBtn = $("#submitBtn");
      const submitText = $("#submitText");
      submitBtn.disabled = true;
      const stopDots = startDots(submitText, "ç™»éŒ„ä¸­");

      try {
        // 1) æ–°å¢åŸºæœ¬æ–‡ä»¶
        const docRef = await addDoc(collection(db, "pets"), payload);

        // 2) é€å¼µä¸Šå‚³åœ–ç‰‡ï¼Œå–å¾— Storage URL
        const urls = [];
        for (const f of selectedFiles) {
          const wmBlob = await addWatermarkToFile(f);       // â† æ–°å¢ï¼šå…ˆåŠ æµ®æ°´å°
          const ext = wmBlob.type === 'image/png' ? 'png' : 'jpg';
          const base = f.name.replace(/\.[^.]+$/, '');
          const path = `pets/${docRef.id}/${Date.now()}_${base}.${ext}`;
          const r = sRef(storage, path);
          await uploadBytes(r, wmBlob, { contentType: wmBlob.type });
          urls.push(await getDownloadURL(r));
        }

        // 3) å›å¯« images æ¬„ä½
        if (urls.length) {
          await updateDoc(doc(db, "pets", docRef.id), { images: urls });
        }

        // UI æ”¶å°¾
        stopDots();
        submitBtn.disabled = false;
        submitText.textContent = "ç™»éŒ„";

        // â˜… æ¸…ç©ºåå­—æ¬„ä½ + æŠŠã€Œå·²è¢«ä½¿ç”¨ã€æç¤º/ç´…æ¡†ç§»é™¤
        const nameInput = document.getElementById("name");
        if (nameInput) nameInput.value = "";
        if (window.resetNameCheck) resetNameCheck();

        // â˜… ç™»éŒ„å®Œæˆ â†’ æ²åˆ°æœ€ä¸Šæ–¹
        window.scrollTo({ top: 0, behavior: "smooth" });

        // æˆåŠŸæç¤ºå¾Œç›´æ¥æ‰“é–‹è©³æƒ…
        Swal.fire({
          icon: "success",
          title: "å·²æˆåŠŸç™»éŒ„ï¼",
          showConfirmButton: false,
          timer: 1500,
        }).then(() => {
          openDialog(docRef.id);
        });

        // é‡ç½®è¡¨å–®èˆ‡é¸æ“‡åœ–ç‰‡
        e.target.reset();
        imgPreview.innerHTML = "";
        selectedFiles = [];
        fileCount.textContent = "å·²é¸ 0 / 5 å¼µ";
        syncBreedSelectors();

        // é‡æ–°è¼‰å…¥åˆ—è¡¨
        await loadPets();
      } catch (err) {
        stopDots();
        submitBtn.disabled = false;
        submitText.textContent = "ç™»éŒ„";
        Swal.fire({ icon: "error", title: "ç™»éŒ„å¤±æ•—", text: err.message });
      }
    });

    // ===============================
    // åˆ—è¡¨è¼‰å…¥ + æœå°‹ + æ¸²æŸ“ï¼ˆæ¡Œæ©Ÿ/æ‰‹æ©Ÿï¼‰
    // ===============================
    async function loadPets() {
      const q = query(collection(db, "pets"), orderBy("createdAt", "desc"), fbLimit(15));
      const snap = await getDocs(q);
      pets = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      applyFilterAndRender();
    }

    // ç”¨ nameLower / name æª¢æŸ¥æ˜¯å¦é‡è¤‡ï¼›exceptId è¡¨ç¤ºå¿½ç•¥è‡ªå·±ï¼ˆç·¨è¼¯æ™‚ç”¨ï¼‰
    async function isNameTaken(name, exceptId = null) {
      const kw = (name || "").trim().toLowerCase();
      if (!kw) return false;

      // 1) ä»¥ nameLower ç²¾æº–æŸ¥ï¼Œå–æœ€å¤š 2 ç­†ï¼Œé¿å…åªæœ‰è‡ªå·±æ™‚èª¤åˆ¤ç‚ºç„¡é‡è¤‡
      let snap = await getDocs(query(
        collection(db, "pets"),
        where("nameLower", "==", kw),
        fbLimit(2)
      ));
      if (!snap.empty && snap.docs.some((d) => d.id !== exceptId)) return true;

      // 2) èˆŠè³‡æ–™æ²’ nameLowerï¼Œå†ç”¨ name ç²¾æº–æŸ¥ä¸€æ¬¡ï¼ŒåŒæ¨£å– 2 ç­†
      snap = await getDocs(query(
        collection(db, "pets"),
        where("name", "==", name),
        fbLimit(2)
      ));
      if (!snap.empty && snap.docs.some((d) => d.id !== exceptId)) return true;

      return false;
    }

    const searchInput = $("#searchName");
    searchInput.addEventListener("input", onSearchByName);

    function applyFilterAndRender() {
      const kw = searchInput.value.trim().toLowerCase();
      const list = kw
        ? pets.filter((p) => String(p.name || "").toLowerCase().includes(kw))
        : pets;
      renderRows(list);
      renderRowsMobile(list);
    }

    // å¾Œç«¯ä¾åå­—ï¼ˆå‰ç¶´ï¼‰æŸ¥è©¢ï¼šæœ‰é—œéµå­—â†’æ‰“ Firestoreï¼›ç©ºå­—ä¸²â†’å›åˆ°é è¨­æ¸…å–®
    async function onSearchByName() {
      const kwRaw = searchInput.value.trim();
      const kw = kwRaw.toLowerCase();
      if (!kw) {
        applyFilterAndRender();
        return;
      }

      try {
        // Phase 1ï¼šå‰ç¶´ï¼ˆåŠ é€Ÿï¼‰
        let prefix = [];
        try {
          const qPrefix = query(
            collection(db, "pets"),
            orderBy("nameLower"),
            where("nameLower", ">=", kw),
            where("nameLower", "<=", kw + "\uf8ff"),
            fbLimit(100)
          );
          const snapPrefix = await getDocs(qPrefix);
          prefix = snapPrefix.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) {
          console.warn("prefix search skipped:", e);
        }

        // Phase 2ï¼šæœ€è¿‘ N ç­†åšã€Œä»»æ„ä½ç½®åŒ…å«ã€
        let recentDocs = [];
        try {
          const snapRecent = await getDocs(query(
            collection(db, "pets"),
            orderBy("createdAt", "desc"),
            fbLimit(1200)
          ));
          recentDocs = snapRecent.docs;
        } catch (e) {
          // è‹¥æ²’æœ‰ createdAt å¯æ’åºï¼Œé€€å› nameLower æ’åºæ‹¿ä¸€æ‰¹
          const snapRecent = await getDocs(query(
            collection(db, "pets"),
            orderBy("nameLower"),
            fbLimit(1200)
          ));
          recentDocs = snapRecent.docs;
        }

        const contains = recentDocs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(p => {
            const nm = String(p.name || "");
            const nmLower = String(p.nameLower || nm).toLowerCase();
            return nmLower.includes(kw) || nm.includes(kwRaw);
          });

        // åˆä½µ + å»é‡ï¼ˆæ–°è€…å„ªå…ˆï¼‰
        const byId = new Map();
        [...contains, ...prefix].forEach(p => byId.set(p.id, p));
        const list = Array.from(byId.values()).sort((a, b) => {
          const ta = (a.createdAt && a.createdAt.seconds) ? a.createdAt.seconds : 0;
          const tb = (b.createdAt && b.createdAt.seconds) ? b.createdAt.seconds : 0;
          return tb - ta;
        });

        renderStable(() => {
          renderRows(list);
          renderRowsMobile(list);
        });
      } catch (err) {
        console.error("search error", err);
        // å¾Œå‚™ï¼šç”¨ç›®å‰è¨˜æ†¶ä¸­çš„æ¸…å–®åšåŒ…å«æœå°‹
        const list = pets.filter(p => String(p.name || "").toLowerCase().includes(kw));
        renderStable(() => {
          renderRows(list);
          renderRowsMobile(list);
        });
      }
    }

    // æ¡Œæ©Ÿè¡¨æ ¼
    function renderRows(list) {
      const tb = document.getElementById("rows");
      if (!tb) return;

      tb.innerHTML = list
        .map(
          (p) => `
      <tr class="border-t hover:bg-gray-50 cursor-pointer" data-id="${p.id}">
        <td class="py-2 pr-2 font-medium">${p.name}</td>
        <td class="py-2 pr-2">${p.species}</td>
        <td class="py-2 pr-2">${p.breed}</td>
        <td class="py-2 pr-2">${p.gender}</td>
      </tr>`
        )
        .join("");

      tb.querySelectorAll("tr").forEach((tr) =>
        tr.addEventListener("click", () => {
          const data = list.find((p) => p.id === tr.dataset.id);
          if (data) openDialog(data.id);
        })
      );
    }

    // æ‰‹æ©Ÿå¡ç‰‡
    function renderRowsMobile(list) {
      const wrap = document.getElementById("rowsMobile");
      if (!wrap) return;

      wrap.innerHTML = list
        .map((p) => {
          const img = (Array.isArray(p.images) && p.images[0]) || p.image || "";
          return `
        <div class="rounded-xl ring-1 ring-gray-200 p-3 flex gap-3 items-center cursor-pointer"
             data-id="${p.id}">
          <img src="${img}" class="w-16 h-16 object-cover rounded-lg bg-gray-100">
          <div class="min-w-0 flex-1">
            <div class="font-semibold truncate">${p.name}</div>
            <div class="text-xs text-gray-600 mt-1 truncate">
              ${p.species}ãƒ»${p.breed}ãƒ»${p.gender}
            </div>
          </div>
        </div>`;
        })
        .join("");

      wrap.querySelectorAll("[data-id]").forEach((card) =>
        card.addEventListener("click", () => {
          const data = list.find((p) => p.id === card.dataset.id);
          if (data) openDialog(data.id);
        })
      );
    }

    // ===============================
    // è©³æƒ… Dialogï¼šé–‹å•Ÿ/æ¸²æŸ“/ç·¨è¼¯æ¨¡å¼
    // ===============================
    let currentDocId = null;
    let currentDoc = null;

    async function openDialog(id) {
      let p = pets.find((x) => x.id === id);
      if (!p) {
        try {
          const snap = await getDoc(doc(db, "pets", id));
          if (!snap.exists()) {
            if (typeof swalInDialog === "function") {
              await swalInDialog({ icon: "error", title: "æ‰¾ä¸åˆ°é€™ç­†è³‡æ–™" });
            }
            return;
          }
          p = { id: snap.id, ...snap.data() };
        } catch (e) {
          if (typeof swalInDialog === "function") {
            await swalInDialog({ icon: "error", title: "è®€å–è³‡æ–™å¤±æ•—", text: String(e) });
          }
          return;
        }
      }

      const dlgImg = document.getElementById("dlgImg");
      const dlgBg = document.getElementById("dlgBg");
      const dlgThumbs = document.getElementById("dlgThumbs");
      // ç¬¬äºŒæ’ï¼šå¥åº·æ¨™ç±¤
      const isNeutered = !!p.neutered;
      const isVaccinated = !!p.vaccinated;

      document.getElementById('dlgTagNeutered').textContent = isNeutered
        ? 'å·²çµç´®' : 'æœªçµç´®';

      document.getElementById('dlgTagVaccinated').textContent = isVaccinated
        ? 'å·²æ³¨å°„é é˜²é‡' : 'æœªæ³¨å°„é é˜²é‡';

      // å–æ‰€æœ‰åœ–ç‰‡ï¼ˆimages æ˜¯é™£åˆ—ï¼›å¾Œå° upload æ™‚å¿…å®šæœ‰ï¼‰
      const imgs = Array.isArray(p.images) && p.images.length > 0
        ? p.images
        : p.image ? [p.image] : [];

      // è¨­å®šä¸»åœ–
      dlgImg.src = imgs[0] || "";
      if (dlgBg) dlgBg.src = dlgImg.src;
      dlgImg.onclick = () => openLightbox(imgs, 0);  // è®“ä¸»åœ–å¯é€²å…¥ Lightbox

      // ç”Ÿæˆç¸®åœ–åˆ—
      dlgThumbs.innerHTML = "";
      imgs.forEach((url, i) => {
        const thumb = document.createElement("img");
        thumb.src = url;
        thumb.className = "dlg-thumb" + (i === 0 ? " active" : "");
        thumb.dataset.index = i;

        // é»ç¸®åœ– â†’ åˆ‡æ›ä¸»åœ– + å•Ÿå‹•å°æ‡‰çš„ Lightbox é é¢
        thumb.addEventListener("click", () => {
          dlgImg.src = url;
          if (dlgBg) dlgBg.src = url;

          // æ›´æ–° active æ¨£å¼
          document.querySelectorAll(".dlg-thumb").forEach((el) => el.classList.remove("active"));
          thumb.classList.add("active");
        });

        dlgThumbs.appendChild(thumb);
      });

      // åŸºæœ¬è³‡æ–™ï¼ˆåŸæœ¬çš„ï¼‰
      document.getElementById('dlgName').textContent = p.name;
      document.getElementById('dlgDesc').textContent = p.desc;

      currentPetId = p.id;
      history.replaceState(null, "", `?pet=${encodeURIComponent(p.id)}`);

      // ä¸‰å€‹åœ“è§’æ¨™ç±¤ï¼ˆä¸æ›è¡Œï¼Œè¶…å‡ºå¯æ©«å‘æ²å‹•ï¼‰
      document.getElementById('dlgTagBreed').textContent = p.breed;
      document.getElementById('dlgTagAge').textContent = p.age;
      document.getElementById('dlgTagGender').textContent = p.gender;

      currentDoc = p;
      currentDocId = p.id;

      // æ¸²æŸ“è¦–åœ–èˆ‡ç¶å®šå‹•ä½œ
      renderDialogView(p);

      // é–‹å•Ÿå‰é–ä½èƒŒæ™¯æ²å‹•
      lockScroll();
      dlg.showModal();
    }

    // ä»¥è³‡æ–™ç‰©ä»¶æ¸²æŸ“ Dialogï¼ˆå«ç¸®åœ–ã€ç·¨è¼¯æ¬„ä½é å¡«ï¼‰
    function renderDialogView(p) {
      const imgs = Array.isArray(p.images) && p.images.length ? p.images : p.image ? [p.image] : [];
      const first = imgs[0] || "";

      document.getElementById("dlgBg").src = first;
      document.getElementById("dlgImg").src = first;
      document.getElementById("editNeutered").checked = !!p.neutered;
      document.getElementById("editVaccinated").checked = !!p.vaccinated;

      // Lightbox åˆå§‹åŒ–ï¼ˆlbImages/lbIndex ç”± lightbox å€å¡Šä½¿ç”¨ï¼‰
      lbImages = imgs;
      lbIndex = 0;

      // æ¨™é¡Œèˆ‡æ¨™ç±¤
      document.getElementById("dlgName").textContent = p.name;
      document.getElementById("dlgTagBreed").textContent = p.breed;
      document.getElementById("dlgTagAge").textContent = p.age;
      document.getElementById("dlgTagGender").textContent = p.gender;
      document.getElementById("dlgDesc").textContent = p.desc;

      // é‡æ–°ç¹ªè£½ç¸®åœ–ï¼ˆå« activeï¼‰
      const thumbs = document.getElementById("dlgThumbs");
      thumbs.innerHTML = "";
      imgs.forEach((src, i) => {
        const im = document.createElement("img");
        im.src = src;
        im.alt = "ç¸®åœ–";
        im.className = "dlg-thumb" + (i === 0 ? " active" : "");
        im.addEventListener("click", () => {
          setMainImage(i, imgs);
          document.querySelectorAll(".dlg-thumb").forEach((el) => el.classList.remove("active"));
          im.classList.add("active");
        });
        thumbs.appendChild(im);
      });

      // ç·¨è¼¯å€é å¡«
      document.getElementById("editName").value = p.name;
      document.getElementById("editAge").value = p.age;
      document.getElementById("editGender").value = p.gender;
      document.getElementById("editDesc").value = p.desc;
      setEditSpecies(p.species || 'è²“');
      syncEditBreedSelectors();
      if (p.breedType) {
        document.getElementById("editBreedType").value = p.breedType;
        buildEditBreedOptions();
        updateEditBreedLabel();
        if (p.breed) {
          document.getElementById("editBreed").disabled = false;
          document.getElementById("editBreed").value = p.breed;
        }
      }
      renderEditImages(imgs);

      // é è¨­é¡¯ç¤ºä¸€èˆ¬æ¨¡å¼ï¼ˆéç·¨è¼¯ï¼‰
      setEditMode(false);

      // ç¶å®šæŒ‰éˆ•å‹•ä½œ
      bindDialogActions();

      // é€é¤Š/æ’¤å›æŒ‰éˆ•åˆ‡æ›
      const isAdopted = p.status === "adopted";
      const btnAdopted = document.getElementById("btnAdopted");
      const btnUnadopt = document.getElementById("btnUnadopt");
      if (btnAdopted) btnAdopted.classList.toggle("hidden", isAdopted);
      if (btnUnadopt) {
        btnUnadopt.classList.toggle("hidden", !isAdopted);
        btnUnadopt.onclick = onUnadopt;
      }

      // æ¯æ¬¡æ‰“é–‹è©³æƒ…ï¼Œå…ˆæ”¶èµ·ã€Œå·²é ˜é¤Šåˆç…§ã€å€
      document.getElementById("adoptedUpload").classList.add("hidden");
    }

    // åˆ‡ä¸»åœ–
    function setMainImage(i, imgs) {
      const src = imgs[i];
      document.getElementById("dlgImg").src = src;
      document.getElementById("dlgBg").src = src;
      lbIndex = i;
    }

    // é—œé–‰ Dialog
    document.getElementById("dlgClose").addEventListener("click", () => {
      if (dlg.open) dlg.close();
      document.documentElement.style.overflow = oldHtmlOverflow;
    });

    // ç¶å®š Dialog å…§å„ç¨®æŒ‰éˆ•è¡Œç‚º
    function bindDialogActions() {
      document.getElementById("btnDelete").onclick = onDelete;
      document.getElementById("btnEdit").onclick = () => setEditMode(true);

      document.getElementById("btnAdopted").onclick = () => {
        const up = document.getElementById("adoptedUpload");
        up.classList.remove("hidden");
        document.getElementById("btnPickAdopted")?.focus();
        up.scrollIntoView({ behavior: "smooth", block: "start" });
      };

      document.getElementById("btnPickAdopted").onclick = () =>
        document.getElementById("adoptedFiles").click();

      document.getElementById("btnConfirmAdopted").onclick = onConfirmAdopted;
      document.getElementById("btnSave").onclick = saveEdit;

      document.getElementById("btnCancel").onclick = () => {
        // å–æ¶ˆç·¨è¼¯ â†’ å›å¾©é¡¯ç¤ºæœ€æ–°è³‡æ–™
        renderDialogView(currentDoc);
        resetAdoptedSelection();
      };
    }

    // åˆªé™¤ç›®å‰é€™ç­†
    async function onDelete() {
      const wasOpen = dlg.open;
      if (wasOpen) dlg.close();

      const ok = await Swal.fire({
        icon: "warning",
        title: "ç¢ºå®šåˆªé™¤æ­¤ç­†å‹•ç‰©è³‡æ–™ï¼Ÿ",
        showCancelButton: true,
        confirmButtonText: "ç¢ºå®š",
        cancelButtonText: "å–æ¶ˆ",
      });
      if (!ok.isConfirmed) {
        if (wasOpen) dlg.showModal();
        return;
      }

      try {
        // åˆªæ‰é€™ç­†çš„æ‰€æœ‰åœ–ç‰‡èˆ‡åˆç…§è³‡æ–™å¤¾
        await deleteAllUnder(`pets/${currentDocId}`);
        await deleteAllUnder(`adopted/${currentDocId}`);
        // æœ€å¾Œåˆª Firestore æ–‡ä»¶
        await deleteDoc(doc(db, "pets", currentDocId));
        await loadPets();
        await Swal.fire({ icon: "success", title: "åˆªé™¤æˆåŠŸ", showConfirmButton: false, timer: 1500, });
      } catch (err) {
        await Swal.fire({ icon: "error", title: "åˆªé™¤å¤±æ•—", text: err.message });
        if (wasOpen) dlg.showModal();
      }
    }

    // åˆ‡æ›ç·¨è¼¯æ¨¡å¼
    function setEditMode(on) {
      document.getElementById("editArea").classList.toggle("hidden", !on);
      document.getElementById("actionBar").classList.toggle("hidden", on);
      document.getElementById("editActionBar").classList.toggle("hidden", !on);
      if (on) {
        document.getElementById("adoptedUpload").classList.add("hidden");
      }
    }

    // ===============================
    // ç·¨è¼¯æ¨¡å¼ï¼šå„²å­˜è³‡æ–™èˆ‡åœ–ç‰‡åŒæ­¥ï¼ˆå¢/åˆª/ä¿ç•™ï¼‰
    // ===============================
    async function saveEdit() {
      const btn = document.getElementById("btnSave");
      const txt = document.getElementById("saveText");
      const dlg = document.getElementById("petDialog");

      // è’é›†æ¬„ä½
      const name = (document.getElementById("editName").value || "").trim() || "æœªå–å";

      const rawBreedType = document.getElementById("editBreedType").value || "";
      const rawBreed = document.getElementById("editBreed").value || "";
      let breed = "";
      if (!rawBreedType) {
        breed = "å“ç¨®ä¸è©³";
      } else if (rawBreedType === "ç±³å…‹æ–¯") {
        breed = rawBreed ? `ç±³å…‹æ–¯/${rawBreed}` : "ç±³å…‹æ–¯";
      } else {
        breed = rawBreed || "å“ç¨®ä¸è©³";
      }

      const age = (document.getElementById("editAge").value || "").trim() || "å¹´é½¡ä¸è©³";
      const gender = document.getElementById("editGender").value || "æ€§åˆ¥ä¸è©³";
      const desc = (document.getElementById("editDesc").value || "").trim() || "ç„¡å‚™è¨»";

      const newData = {
        species: getEditSpecies(),
        name,
        nameLower: name.toLowerCase(),
        breedType: rawBreedType,
        breed,
        age,
        gender,
        desc,
        neutered: document.getElementById("editNeutered").checked,
        vaccinated: document.getElementById("editVaccinated").checked,
      };

      // â‘  é€å‡ºå‰ï¼šåå­—é‡è¤‡ â†’ å…ˆè©¢å•æ˜¯å¦ä»è¦å„²å­˜ï¼ˆæ­¤æ™‚ä¸è¦å•Ÿå‹•ã€Œå„²å­˜ä¸­ã€ï¼‰
      const newName = newData.name;
      if (newName && newName !== "æœªå–å") {
        const taken = await isNameTaken(newName, currentDocId);
        if (taken) {
          const { isConfirmed } = await (typeof swalInDialog === "function" ? swalInDialog : Swal.fire)({
            icon: "warning",
            title: `ã€Œ${newName}ã€å·²å­˜åœ¨`,
            text: "ç¢ºå®šç¹¼çºŒå„²å­˜ï¼Ÿ",
            showCancelButton: true,
            confirmButtonText: "ç¢ºå®š",
            cancelButtonText: "å–æ¶ˆ",
          });
          if (!isConfirmed) {
            // ä½¿ç”¨è€…å–æ¶ˆ â†’ ç›´æ¥çµæŸï¼ŒæŒ‰éˆ•ç¶­æŒå¯æŒ‰ã€æ–‡å­—ç¶­æŒã€Œå„²å­˜ã€
            return;
          }
        }
        // åŒæ­¥å°å¯«æ¬„ä½ï¼Œé¿å…ä¹‹å¾Œæœå°‹ä¸åˆ°
        newData.nameLower = newName.toLowerCase();
      }

      // â‘¡ ç¢ºèªå¾Œæ‰é–‹å§‹ã€Œå„²å­˜ä¸­â€¦ã€èˆ‡é–å®šæŒ‰éˆ•
      btn.disabled = true;
      const stopDots = startDots(txt, "å„²å­˜ä¸­");

      try {
        // ä¾ç…§ç‹€æ…‹è¨ˆç®—å‡ºæœ€çµ‚ imagesï¼šå…ˆä¿ç•™ keepï¼Œå†æŠŠ add ä¸Šå‚³ï¼Œæœ€å¾Œåˆªæ‰ remove çš„ Storage ç‰©ä»¶
        const { keep, add, remove } = editImagesState;
        const newUrls = [...keep];

        // ä¸Šå‚³æ–°å¢æª”æ¡ˆ
        for (const f of add) {
          const wmBlob = await addWatermarkToFile(f);       // â† æ–°å¢ï¼šå…ˆåŠ æµ®æ°´å°
          const ext = wmBlob.type === 'image/png' ? 'png' : 'jpg';
          const base = f.name.replace(/\.[^.]+$/, '');
          const path = `pets/${currentDocId}/${Date.now()}_${base}.${ext}`;
          const r = sRef(storage, path);
          await uploadBytes(r, wmBlob, { contentType: wmBlob.type });
          newUrls.push(await getDownloadURL(r));
        }

        // åˆªé™¤ç§»é™¤çš„æª”æ¡ˆï¼ˆå¿½ç•¥åˆªå¤±æ•—ï¼‰
        for (const url of remove) {
          try {
            const path = url.split("/o/")[1].split("?")[0];
            await deleteObject(sRef(storage, decodeURIComponent(path)));
          } catch (e) {
            // éœé»˜å¿½ç•¥
          }
        }

        newData.images = newUrls;

        // â‘¢ å¯«å› Firestore
        await updateDoc(doc(db, "pets", currentDocId), newData);

        // â‘£ é‡è¼‰åˆ—è¡¨ä¸¦åŒæ­¥ç•¶å‰ç‰©ä»¶
        await loadPets();
        currentDoc = { ...currentDoc, ...newData };

        // â‘¤ UI æ”¶å°¾ï¼ˆç„¡è«–å½ˆçª—ç‹€æ…‹ï¼ŒæˆåŠŸæç¤ºä¸€ä¸‹ï¼‰
        stopDots();
        btn.disabled = false;
        txt.textContent = "å„²å­˜";

        const wasOpen = dlg.open;
        if (wasOpen) dlg.close();
        await Swal.fire({ icon: "success", title: "å·²å„²å­˜", showConfirmButton: false, timer: 1500 });
        if (wasOpen) dlg.showModal();

        setEditMode(false);
        renderDialogView(currentDoc);

      } catch (err) {
        // å¤±æ•—ä¹Ÿè¦ç¢ºä¿ UI å¾©åŸ
        stopDots();
        btn.disabled = false;
        txt.textContent = "å„²å­˜";
        await Swal.fire({ icon: "error", title: "æ›´æ–°å¤±æ•—", text: err.message });
      }
    }

    function getEditSpecies() {
      return document.querySelector('input[name="editSpecies"]:checked')?.value || 'è²“';
    }
    function setEditSpecies(v) {
      const t = v === 'ç‹—' ? 'ç‹—' : 'è²“';
      const el = document.querySelector(`input[name="editSpecies"][value="${t}"]`);
      if (el) el.checked = true;
    }

    // ===============================
    // ç·¨è¼¯æ¨¡å¼ï¼šå“ç¨®é€£å‹•ï¼ˆå³å´ï¼‰
    // ===============================
    const editBreedTypeSel = $("#editBreedType");
    const editBreedSel = $("#editBreed");
    const editBreedLabel = $("#editBreedLabel");

    function updateEditBreedLabel() {
      const t = editBreedTypeSel.value;
      editBreedLabel.textContent = !t ? "å“ç¨®/æ¯›è‰²" : t === "ç±³å…‹æ–¯" ? "æ¯›è‰²" : "å“ç¨®";
    }
    function resetEditBreedRight() {
      editBreedSel.disabled = true;
      editBreedSel.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å“ç¨®</option>';
    }
    function syncEditBreedSelectors() {
      const isCat = getEditSpecies() === 'è²“';
      editBreedTypeSel.innerHTML = isCat
        ? '<option value="">è«‹é¸æ“‡</option><option value="å“ç¨®è²“">å“ç¨®è²“</option><option value="ç±³å…‹æ–¯">ç±³å…‹æ–¯</option>'
        : '<option value="">è«‹é¸æ“‡</option><option value="å“ç¨®çŠ¬">å“ç¨®çŠ¬</option><option value="ç±³å…‹æ–¯">ç±³å…‹æ–¯</option>';
      resetEditBreedRight();
      updateEditBreedLabel();
    }
    function buildEditBreedOptions() {
      const list = (BREEDS[getEditSpecies()] || {})[editBreedTypeSel.value] || [];
      if (!editBreedTypeSel.value) { resetEditBreedRight(); return; }
      editBreedSel.disabled = false;
      editBreedSel.innerHTML = ['<option value="">è«‹é¸æ“‡</option>']
        .concat(list.map(b => `<option value="${b}">${b}</option>`)).join('');
    }

    document.querySelectorAll('input[name="editSpecies"]').forEach(el => {
      el.addEventListener('change', syncEditBreedSelectors);
    });
    editBreedTypeSel.addEventListener("change", () => {
      buildEditBreedOptions();
      updateEditBreedLabel();
    });

    // ===============================
    // ç·¨è¼¯æ¨¡å¼ï¼šåœ–ç‰‡ç®¡ç†ï¼ˆé è¦½ + å¢åˆªï¼‰
    // ===============================
    const editFiles = $("#editFiles");
    const btnPickEdit = $("#btnPickEdit");
    const editPreview = $("#editPreview");
    const editCount = $("#editCount");

    // ç‹€æ…‹ï¼šç¾å­˜ä¿ç•™ keepã€æ–°å¢ addã€è¦åˆª remove
    let editImagesState = { keep: [], add: [], remove: [] };

    btnPickEdit.addEventListener("click", () => editFiles.click());

    // åˆå§‹åŒ–ç·¨è¼¯åœ–ç‰‡åˆ—è¡¨
    function renderEditImages(urls) {
      editImagesState.keep = [...urls];
      editImagesState.add = [];
      editImagesState.remove = [];
      paintEditPreview();
    }

    // ä¾ç‹€æ…‹é‡æ–°ç•«ç¸®åœ–
    function paintEditPreview() {
      const total = editImagesState.keep.length + editImagesState.add.length;
      editCount.textContent = `å·²é¸ ${total} / 5 å¼µ`;

      const current = [
        ...editImagesState.keep.map((u, i) => ({ type: "keep", url: u, idx: i })),
        ...editImagesState.add.map((f, i) => ({ type: "add", file: f, idx: i })),
      ];

      editPreview.innerHTML = current
        .map((item) => {
          const src = item.type === "keep" ? item.url : URL.createObjectURL(item.file);
          const data = item.type === "keep" ? `data-keep="${item.idx}"` : `data-add="${item.idx}"`;
          return `
        <div class="relative">
          <img class="w-full aspect-square object-cover rounded-lg" src="${src}"/>
          <button ${data} class="absolute top-1 right-1 bg-black/70 text-white rounded-full w-7 h-7 flex items-center justify-center">âœ•</button>
        </div>`;
        })
        .join("");

      // ç§»é™¤ keep â†’ æ”¾å…¥ remove
      editPreview.querySelectorAll("button[data-keep]").forEach((btn) =>
        btn.addEventListener("click", () => {
          const i = +btn.getAttribute("data-keep");
          editImagesState.remove.push(editImagesState.keep[i]);
          editImagesState.keep.splice(i, 1);
          paintEditPreview();
        })
      );

      // ç§»é™¤ add â†’ ç›´æ¥å¾ add é™£åˆ—åˆªé™¤
      editPreview.querySelectorAll("button[data-add]").forEach((btn) =>
        btn.addEventListener("click", () => {
          const i = +btn.getAttribute("data-add");
          editImagesState.add.splice(i, 1);
          paintEditPreview();
        })
      );
    }

    // æ–°å¢åœ–ç‰‡ï¼ˆå°Šå®ˆä¸Šé™ 5ï¼‰
    editFiles.addEventListener("change", () => {
      const incoming = Array.from(editFiles.files || []);
      const total = editImagesState.keep.length + editImagesState.add.length + incoming.length;
      if (total > 5) {
        swalInDialog({ icon: "warning", title: "æœ€å¤š 5 å¼µç…§ç‰‡" });
      }
      const room = 5 - (editImagesState.keep.length + editImagesState.add.length);
      editImagesState.add = editImagesState.add.concat(incoming.slice(0, Math.max(0, room)));
      paintEditPreview();
      editFiles.value = "";
    });

    // ===============================
    // é€é¤Šæµç¨‹ï¼šä¸Šå‚³åˆç…§ / æ¨™è¨˜ / æ’¤å›
    // ===============================

    // ç‹€æ…‹ï¼šå·²é¸æ“‡çš„åˆç…§ï¼ˆå¯å¤šæ¬¡ç–ŠåŠ ï¼‰
    let adoptedSelected = [];

    const adoptedFilesInput = document.getElementById("adoptedFiles");
    const btnPickAdopted = document.getElementById("btnPickAdopted");
    const adoptedCount = document.getElementById("adoptedCount");
    const adoptedPreview = document.getElementById("adoptedPreview");

    // æ‰“é–‹æª”æ¡ˆæŒ‘é¸
    btnPickAdopted.onclick = () => adoptedFilesInput.click();

    // æ¸²æŸ“ç¸®åœ–ï¼ˆå³ä¸Šè§’åˆªé™¤éˆ•ï¼‰
    function renderAdoptedPreviews() {
      adoptedCount.textContent = `å·²é¸ ${adoptedSelected.length} / 5 å¼µ`;
      adoptedPreview.innerHTML = adoptedSelected
        .map((f, i) => {
          const u = URL.createObjectURL(f);
          return `
        <div class="relative">
          <img class="w-full aspect-square object-cover rounded-lg" src="${u}" alt="é è¦½">
          <button data-idx="${i}"
                  class="absolute top-1 right-1 bg-black/60 text-white rounded-full w-7 h-7 flex items-center justify-center"
                  aria-label="åˆªé™¤é€™å¼µ">âœ•</button>
        </div>
      `;
        })
        .join("");

      adoptedPreview.querySelectorAll("button[data-idx]").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const i = +btn.dataset.idx;
          adoptedSelected.splice(i, 1);
          renderAdoptedPreviews();
        });
      });
    }

    renderAdoptedPreviews();

    // æª”æ¡ˆè®Šæ›´ï¼šç–ŠåŠ ä¸¦é™åˆ¶æœ€å¤š 5 å¼µ
    adoptedFilesInput.addEventListener("change", () => {
      const incoming = Array.from(adoptedFilesInput.files || []);
      const next = adoptedSelected.concat(incoming);
      if (next.length > 5) {
        swalInDialog({ icon: "warning", title: "æœ€å¤š 5 å¼µç…§ç‰‡" });
      }
      adoptedSelected = next.slice(0, 5);
      renderAdoptedPreviews();
      adoptedFilesInput.value = ""; // æ¸…ç©ºï¼Œå…è¨±å†æ¬¡é¸åŒä¸€æª”
    });

    // æ¸…ç©ºï¼ˆæˆåŠŸ/å–æ¶ˆå¾Œå‘¼å«ï¼‰
    function resetAdoptedSelection() {
      adoptedSelected = [];
      adoptedPreview.innerHTML = "";
      adoptedCount.textContent = "å·²é¸ 0 / 5 å¼µ";
      adoptedFilesInput.value = "";
    }

    // ç¢ºèªæ¨™è¨˜ç‚ºå·²é ˜é¤Šï¼šä¸Šå‚³åˆç…§åˆ° Storageï¼Œæ›´æ–°ç‹€æ…‹èˆ‡é¡¯ç¤ºé é¢é¸é …
    async function onConfirmAdopted() {
      const btn = document.getElementById("btnConfirmAdopted");

      // å‹•æ…‹é»é»ï¼ˆæ²¿ç”¨ä½ æª”æ¡ˆå…§çš„ startDotsï¼‰
      btn.disabled = true;
      btn.setAttribute("aria-busy", "true");
      const stopDots = startDots(btn, "å„²å­˜ä¸­");

      const files = adoptedSelected.slice(0, 5);
      const urls = [];
      try {
        for (const f of files) {
          const wmBlob = await addWatermarkToFile(f);       // â† æ–°å¢ï¼šå…ˆåŠ æµ®æ°´å°
          const ext = wmBlob.type === 'image/png' ? 'png' : 'jpg';
          const base = f.name.replace(/\.[^.]+$/, '');
          const path = `adopted/${currentDocId}/${Date.now()}_${base}.${ext}`;
          const r = sRef(storage, path);
          await uploadBytes(r, wmBlob, { contentType: wmBlob.type });
          urls.push(await getDownloadURL(r));
        }

        await updateDoc(doc(db, "pets", currentDocId), {
          status: "adopted",
          adoptedPhotos: urls,
          showOnHome: true,
          showOnCats: false,
          showOnDogs: false,
          showOnIndex: false,
        });

        await loadPets();

        // å…ˆé—œé–‰ modal
        const dlg = document.getElementById("petDialog");
        if (dlg?.open) dlg.close();

        // ç”¨å…¨åŸŸ Swalï¼ˆä¸åœ¨ dialog è£¡ï¼‰ï¼Œæ‰€ä»¥é—œæ‰ modal ä¹Ÿçœ‹å¾—åˆ°
        await Swal.fire({
          icon: "success",
          title: "å·²æ¨™è¨˜ç‚ºã€Œå·²é€é¤Šã€",
          showConfirmButton: false,
          timer: 1500,
        });

        // æ¸…ç©ºå·²é ˜é¤Šé¸å–ï¼ˆä¿éšªèµ·è¦‹ï¼Œé—œé–‰æ™‚é€šå¸¸ä¹Ÿæœƒæ¸…ï¼‰
        resetAdoptedSelection();
      } catch (err) {
        await swalInDialog({ icon: "error", title: "å·²é€é¤Šæ¨™è¨˜å¤±æ•—", text: err.message });
      } finally {
        stopDots();
        btn.disabled = false;
        btn.removeAttribute("aria-busy");
        btn.textContent = "å„²å­˜é ˜é¤Šè³‡è¨Š";
      }
    }

    // é€€é¤Š â†’ é‚„åŸç‹€æ…‹èˆ‡é¡¯ç¤ºé é¢é¸é …
    async function onUnadopt() {
      const wasOpen = dlg.open;
      if (wasOpen) dlg.close();

      // å…ˆç¢ºèªæ˜¯å¦æ’¤å›
      const { isConfirmed } = await Swal.fire({
        icon: "warning",
        title: "ç¢ºå®šè¦é€€é¤Šå—ï¼Ÿ",
        showCancelButton: true,
        confirmButtonText: "ç¢ºå®š",
        cancelButtonText: "å–æ¶ˆ",
      });

      if (!isConfirmed) {
        if (wasOpen) dlg.showModal();
        return;
      }

      try {
        await deleteAllUnder(`adopted/${currentDocId}`); // æ¸…æ‰åˆç…§
        await updateDoc(doc(db, "pets", currentDocId), {
          status: "available",
          adoptedPhotos: [],
          showOnHome: false,
          showOnCats: true,
          showOnDogs: true,
          showOnIndex: true,
        });

        await loadPets();
        await Swal.fire({ icon: "success", title: "å·²æ’¤å›ã€Œå·²é€é¤Šã€æ¨™è¨˜", showConfirmButton: false, timer: 1500, });
      } catch (err) {
        await Swal.fire({ icon: "error", title: "æ’¤å›å¤±æ•—", text: err.message });
      } finally {
        if (wasOpen) dlg.showModal();
        // é‡æ–°æ¸²æŸ“è®“æŒ‰éˆ•ç‹€æ…‹å³æ™‚åˆ‡æ›
        const p = pets.find((x) => x.id === currentDocId);
        if (p) renderDialogView(p);
      }
    }

    // è®“ SweetAlert2 å‡ºç¾åœ¨ <dialog id="petDialog"> è£¡ï¼Œé¿å…è¢«è¦†è“‹
    function swalInDialog(opts) {
      const dlg = document.getElementById("petDialog");
      return Swal.fire({
        target: dlg || document.body, // æœ‰ dialog å°±æ›åœ¨ dialog è£¡
        backdrop: !!dlg,              // æ›åœ¨ dialog æ™‚å¯ä¿ç•™ backdrop
        ...opts,
      });
    }

    // ä¿éšªï¼šæŠŠ Swal çš„ z-index æ‹‰é«˜ï¼ˆå°±ç®—ä¸æ˜¯æ›åœ¨ dialog ä¹Ÿä¸æœƒè¢«é®ï¼‰
    (() => {
      if (!document.getElementById("swalZFix")) {
        const s = document.createElement("style");
        s.id = "swalZFix";
        s.textContent = `.swal2-container{z-index:2147483647 !important;}`;
        document.head.appendChild(s);
      }
    })();

    // --- é—œé–‰å°è©±æ¡†æ™‚è‡ªå‹•æ¸…ç©ºã€Œå·²é ˜é¤Šåˆç…§ã€é¸å– ---
    // é€™æ®µæœƒåœ¨ï¼šæŒ‰å³ä¸Šè§’é—œé–‰ã€é» backdropã€æŒ‰ Escã€ç¨‹å¼å‘¼å« close()ã€ç”šè‡³æ‰‹å‹•ç§»é™¤ open å±¬æ€§æ™‚ï¼Œéƒ½æ¸…ä¹¾æ·¨ã€‚
    (function setupDialogCleanup() {
      const dlg = document.getElementById("petDialog");
      if (!dlg || dlg.dataset.cleanupBound) return;

      // ç¢ºä¿æœ‰æ¸…ç©ºå‡½å¼ï¼ˆå¦‚æœä½ å‰é¢å·²å®šç¾© resetAdoptedSelection å°±ä¸æœƒè·‘é€™æ®µï¼‰
      if (typeof window.resetAdoptedSelection !== "function") {
        window.resetAdoptedSelection = function () {
          try {
            window.adoptedSelected = [];
            const adoptedPreview = document.getElementById("adoptedPreview");
            const adoptedCount = document.getElementById("adoptedCount");
            const adoptedFilesInput = document.getElementById("adoptedFiles");
            if (adoptedPreview) adoptedPreview.innerHTML = "";
            if (adoptedCount) adoptedCount.textContent = "å·²é¸ 0 / 5 å¼µ";
            if (adoptedFilesInput) adoptedFilesInput.value = "";
          } catch { }
        };
      }

      // 1) æ¨™æº–ï¼šdialog é—œé–‰äº‹ä»¶ï¼ˆæŒ‰ Xã€é»é®ç½©ã€å‘¼å« close() éƒ½æœƒè§¸ç™¼ï¼‰
      dlg.addEventListener("close", () => {
        resetAdoptedSelection();
      });

      // 2) å–æ¶ˆäº‹ä»¶ï¼ˆæŒ‰ Escï¼‰
      dlg.addEventListener("cancel", () => {
        resetAdoptedSelection();
        // ä¸é˜»æ­¢é è¨­ï¼Œè®“å®ƒç…§å¸¸é—œé–‰
      });

      // 3) è‹¥ä½ çš„ç¨‹å¼æ˜¯ç”¨ç§»é™¤ open / åˆ‡ aria-hidden ä¾†é—œé–‰ï¼Œä¹Ÿä¸€ä½µåµæ¸¬
      const mo = new MutationObserver(() => {
        if (!dlg.open) {
          resetAdoptedSelection();
        }
      });
      mo.observe(dlg, { attributes: true, attributeFilter: ["open", "aria-hidden"] });

      // 4) å¦‚æœä½ æœ‰è‡ªè¨‚å³ä¸Šè§’é—œé–‰éµï¼ˆ#dlgCloseï¼‰ï¼Œä¹Ÿè£œä¸€ä¸‹
      document.getElementById("dlgClose")?.addEventListener("click", () => {
        // é€™è£¡ä¸ç›´æ¥æ¸…ç©ºï¼Œäº¤çµ¦ close äº‹ä»¶çµ±ä¸€è™•ç†ï¼›è‹¥ä½ çš„æŒ‰éˆ•ä¸æ˜¯å‘¼å« close()ï¼Œå¯æ‰‹å‹•åŠ ï¼š
        // resetAdoptedSelection();
      });

      dlg.dataset.cleanupBound = "1";
    })();

    // === å–æ¶ˆï¼šäº‹ä»¶å§”æ´¾ï¼Œé¿å…å‹•æ…‹é‡ç¹ªå°è‡´æ²’ç¶åˆ° ===
    document.addEventListener("click", (e) => {
      const cancelBtn = e.target.closest?.("#btnCancel");
      if (!cancelBtn) return;

      e.preventDefault();

      // æ¸…ç©ºå·²é ˜é¤Šé¸å–ï¼ˆè‹¥å°ˆæ¡ˆå…§å·²æœ‰è‡ªè¨‚ç‰ˆæœ¬æœƒæ²¿ç”¨ï¼‰
      try {
        if (typeof resetAdoptedSelection === "function") resetAdoptedSelection();
        else {
          // ç°¡æ˜“å¾Œæ´ï¼šç¢ºä¿æ¸…ä¹¾æ·¨
          if (window.adoptedSelected) window.adoptedSelected.length = 0;
          const adoptedPreview = document.getElementById("adoptedPreview");
          const adoptedCount = document.getElementById("adoptedCount");
          const adoptedFilesInput = document.getElementById("adoptedFiles");
          if (adoptedPreview) adoptedPreview.innerHTML = "";
          if (adoptedCount) adoptedCount.textContent = "å·²é¸ 0 / 5 å¼µ";
          if (adoptedFilesInput) adoptedFilesInput.value = "";
        }
      } catch { }

      // é—œé–‰ <dialog>
      try {
        const dlg = document.getElementById("petDialog");
        if (dlg?.open) dlg.close();
        // è‹¥ä½ ä¸æ˜¯ç”¨ close() é—œ dialogï¼Œè€Œæ˜¯åˆ‡ aria-hidden/openï¼Œä¹Ÿèƒ½é…åˆé€™æ®µï¼š
        // dlg?.removeAttribute?.("open");
        // dlg?.setAttribute?.("aria-hidden", "true");
      } catch { }
    });

    // ===============================
    // é‡æ–°æ•´ç†æŒ‰éˆ•èˆ‡å•Ÿå‹•è¼‰å…¥
    // ===============================
    document.getElementById("btnRefreshSm")?.addEventListener("click", loadPets);
    document.getElementById("btnRefresh")?.addEventListener("click", loadPets);

    (async () => {
      try {
        await loadPets();
      } catch (e) {
        console.error("loadPets failed", e);
      }
    })();

    async function deleteAllUnder(path) {
      const folderRef = sRef(storage, path);
      const { items, prefixes } = await listAll(folderRef);
      await Promise.all(items.map((it) => deleteObject(it)));
      // å¦‚æœæœ‰å­è³‡æ–™å¤¾ï¼Œéè¿´åˆªé™¤
      for (const p of prefixes) {
        await deleteAllUnder(p.fullPath);
      }
    }

    // === åå­—è¼¸å…¥ï¼šå³æ™‚é‡è¤‡æª¢æŸ¥ï¼ˆå»ºç«‹æ™‚ç”¨ï¼‰ ===
    (() => {
      const input = document.getElementById("name");
      if (!input) return;

      // å»ºä¸€å€‹æç¤ºå…ƒç´ ï¼ˆé¡¯ç¤º æª¢æŸ¥ä¸­ / å¯ç”¨ / å·²è¢«ä½¿ç”¨ï¼‰
      let hint = document.getElementById("nameHint");
      if (!hint) {
        hint = document.createElement("div");
        hint.id = "nameHint";
        hint.setAttribute("aria-live", "polite");
        // ç›´æ¥ç”¨å…§è¯æ¨£å¼ï¼Œé¿å… Tailwind purge
        hint.style.minHeight = "20px";   // é ç•™ 1 è¡Œé«˜åº¦
        hint.style.lineHeight = "20px";  // è®“æ–‡å­—ç½®ä¸­è©²è¡Œ
        hint.style.whiteSpace = "nowrap";
        hint.style.marginTop = "4px";
        hint.style.fontSize = "0.875rem"; // ç´„ç­‰æ–¼ text-sm
        hint.style.color = "#6b7280";     // ç´„ç­‰æ–¼ text-gray-500
        // æ”¾åœ¨åå­—è¼¸å…¥æ¡†çš„æ­£å¾Œæ–¹
        document.getElementById("name").insertAdjacentElement("afterend", hint);
      }

      // ç°¡å–®é˜²æŠ–ï¼Œé¿å…æ¯å€‹å­—éƒ½æ‰“ API
      const debounce = (fn, d = 350) => {
        let t;
        return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), d); };
      };

      // é¿å…å›æ‡‰äº‚åºï¼šåªè™•ç†æœ€å¾Œä¸€æ¬¡æŸ¥è©¢
      let lastVer = 0;
      const setState = (status, text) => {
        // é‚Šæ¡†ï¼šåªæœ‰ bad ç”¨ç´…æ¡†ï¼Œå…¶é¤˜æ¢å¾©åŸæ¨£
        if (!input.dataset._origClass) input.dataset._origClass = input.className;
        if (status === "bad") {
          input.className = `${input.dataset._origClass} border-red-500 focus:outline-none`;
        } else {
          input.className = input.dataset._origClass;
        }

        // æç¤ºï¼šåªæœ‰ bad é¡¯ç¤ºæ–‡å­—ï¼Œå…¶é¤˜æ¸…ç©º
        hint.textContent = (status === "bad") ? (text || "") : "";

        // é¡è‰²ï¼šåªæœ‰ bad é¡¯ç¤ºç´…è‰²
        hint.style.color = (status === "bad") ? "#dc2626" /* red-600 */ : "#6b7280" /* gray-500 */;
      };

      const runCheck = debounce(async () => {
        const ver = ++lastVer;
        const name = (input.value || "").trim();
        if (!name) { setState("idle", ""); return; }

        hint.textContent = "";

        const kw = name.toLowerCase();

        try {
          // å…ˆç”¨ nameLower ç²¾æº–æ¯”å°ï¼ˆä½ å·²åœ¨æ–°å¢/ç·¨è¼¯æœƒå¯«å…¥ nameLowerï¼‰
          const q1 = query(
            collection(db, "pets"),
            where("nameLower", "==", kw),
            fbLimit(1)
          );
          const s1 = await getDocs(q1);
          if (ver !== lastVer) return; // åªè™•ç†æœ€æ–°ä¸€æ¬¡

          // è‹¥èˆŠè³‡æ–™æ²’ nameLowerï¼Œè£œåšä¸€æ¬¡ name ç²¾æº–æ¯”å°ï¼ˆè¼ƒæ…¢ï¼Œä½†åªæŸ¥ 1 ç­†ï¼‰
          let duplicated = !s1.empty;
          if (!duplicated) {
            const q2 = query(
              collection(db, "pets"),
              where("name", "==", name),
              fbLimit(1)
            );
            const s2 = await getDocs(q2);
            duplicated = !s2.empty;
            if (ver !== lastVer) return;
          }

          if (duplicated) {
            setState("bad", `ã€Œ${name}ã€å·²è¢«ä½¿ç”¨`);
          } else {
            setState("idle", ""); // ä¸é¡¯ç¤ºã€Œå¯ä»¥ä½¿ç”¨ã€
          }
        } catch (e) {
          // å¤±æ•—æ™‚ä¸è¦å¡ç´…æ¡†ï¼Œåªé¡¯ç¤ºè¨Šæ¯
          setState("idle", "æª¢æŸ¥å¤±æ•—ï¼Œç¨å¾Œå†è©¦");
          console.error("name check error:", e);
        } finally {
          input.removeAttribute("aria-busy");
        }
      }, 100);

      input.addEventListener("input", runCheck);

      // è®“å¤–éƒ¨å¯åœ¨ã€Œç™»éŒ„æˆåŠŸã€å¾Œé‡ç½®æç¤ºèˆ‡æ¨£å¼
      window.resetNameCheck = () => {
        // æŠŠæœ€æ–°æª¢æŸ¥ç‰ˆæœ¬å¾€å‰æ¨ï¼Œé¿å…èˆŠè«‹æ±‚å›ä¾†è¦†è“‹
        lastVer++;
        // æ¸…é™¤æç¤ºèˆ‡ç´…æ¡†
        setState("idle", "");
        input.removeAttribute("aria-busy");
      };
    })();

    // === ç·¨è¼¯ï¼šåå­—å³æ™‚æª¢æŸ¥ï¼ˆåªåœ¨é‡è¤‡æ™‚é¡¯ç¤ºï¼‰ ===
    (() => {
      const dlg = document.getElementById("petDialog");
      if (!dlg) return;

      let hint, input, _origClass = "";

      function ensureHint() {
        if (!input) return;
        if (!hint) {
          hint = document.createElement("div");
          hint.id = "editNameHint";
          // å›ºå®šé«˜åº¦ï¼Œé¿å…ç‰ˆé¢è·³å‹•
          hint.style.minHeight = "20px";
          hint.style.lineHeight = "20px";
          hint.style.whiteSpace = "nowrap";
          hint.style.marginTop = "4px";
          hint.style.fontSize = "0.875rem";
          hint.style.color = "#6b7280"; // gray-500
          input.insertAdjacentElement("afterend", hint);
        }
      }

      function setBad(msg) {
        if (!_origClass) _origClass = input.className;
        input.className = `${_origClass} border-red-500 focus:outline-none`;
        hint.textContent = msg || "";
        hint.style.color = "#dc2626"; // red-600
      }
      function clearState() {
        if (_origClass) input.className = _origClass;
        if (hint) { hint.textContent = ""; hint.style.color = "#6b7280"; }
      }

      // æ¯æ¬¡ dialog é–‹å•Ÿå¾ŒæŠ“åˆ°ç•¶å‰çš„ #editName
      dlg.addEventListener("close", clearState);
      dlg.addEventListener("cancel", clearState);

      document.addEventListener("input", async (e) => {
        const el = e.target;
        if (el.id !== "editName") return;
        input = el; ensureHint();

        const name = (input.value || "").trim();
        if (!name) { clearState(); return; }

        // åªåœ¨ã€Œé‡è¤‡ã€æ™‚é¡¯ç¤ºç´…å­—ï¼ç´…æ¡†ï¼Œå…¶ä»–ä¿æŒéœé»˜
        const dup = await isNameTaken(name, window.currentDocId || window.currentDoc?.id || null);
        if (dup) setBad(`ã€Œ${name}ã€å·²è¢«ä½¿ç”¨`);
        else clearState();
      });
    })();

    // å†å‘¼å«ä¸€æ¬¡ï¼ˆèˆ‡ IIFE ç­‰åƒ¹ï¼Œä¿éšªï¼‰
    loadPets();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="assets/shared.js"></script>
</body>

</html>