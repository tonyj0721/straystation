<!doctype html>
<html lang="zh-Hant" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç®¡ç†å¾Œå°ï½œæµªæµªè½‰é‹ç«™</title>
  <meta name="description" content="TailwindCSS + Firebase Firestore å¾Œå°ï¼šç™»éŒ„ã€ç®¡ç†å‹•ç‰©è³‡æ–™ï¼›æ²¿ç”¨å‰å° Modal/Lightboxã€‚" />
  <link rel="icon" type="image/png" href="favicon.png" sizes="16x16 32x32 64x64" />
  <link rel="apple-touch-icon" href="favicon.png" />
  <meta name="theme-color" content="#fcd34d" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#fff1f2',
              100: '#ffe4e6',
              200: '#fecdd3',
              300: '#fda4af',
              400: '#fb7185',
              500: '#f43f5e',
              600: '#e11d48',
              700: '#be123c',
              800: '#9f1239',
              900: '#881337'
            }
          },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,.08)' }
        }
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    dialog::backdrop { background: rgba(0,0,0,.5) }
    .dlg-thumb{ width:70px; height:70px; object-fit:cover; background:#f3f4f6; border-radius:6px; cursor:pointer; opacity:.8; transition:.2s }
    .dlg-thumb.active{ outline:3px solid #ff6900; opacity:1 }
    /* Lightbox ç¸®åœ–ï¼šèˆ‡ cats.html ä¸€è‡´ */
    #lbThumbs img{
      width: 60px;
      height: 60px;
      object-fit: contain;
      border-radius: 6px;
      opacity: .5;
      cursor: pointer;
      background: #444;
    }
    #lbThumbs img.active{
      opacity: 1;
      border: 2px solid #fff;
    }
    .swal2-container{ z-index:2147483647 !important }
  </style>
</head>
<body class="bg-gradient-to-br from-brand-50 to-white text-gray-800">
  <header class="bg-white/80 backdrop-blur border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <a href="index.html" class="flex items-center gap-2 font-semibold text-lg">
          <img src="æµªæµªè½‰é‹ç«™Logo.png" alt="æµªæµªè½‰é‹ç«™ Logo" class="h-8 w-8 object-contain" />
          <span>æµªæµªè½‰é‹ç«™ï½œç®¡ç†å¾Œå°</span>
        </a>
        <button id="btnMenu" class="md:hidden inline-flex items-center justify-center h-10 w-10 rounded-xl border border-gray-300" aria-label="é–‹å•Ÿé¸å–®">â˜°</button>
        <nav class="hidden md:flex items-center gap-6">
          <a href="cats.html" class="hover:text-brand-600">æˆ‘æƒ³é¤Šè²“å’ª</a>
          <a href="dogs.html" class="hover:text-brand-600">æˆ‘æƒ³é¤Šç‹—ç‹—</a>
          <a href="about.html" class="hover:text-brand-600">é—œæ–¼ç°¡åª½åª½</a>
          <a href="admin.html" class="text-brand-600 font-semibold">ç®¡ç†å“¡</a>
        </nav>
        <div class="flex items-center gap-2">
          <button id="btnRefresh" class="hidden md:inline-flex px-3 py-2 rounded-xl border border-gray-300 text-sm">é‡æ–°è¼‰å…¥</button>
        </div>
      </div>
      <div id="mobileNav" class="md:hidden hidden pb-4">
        <div class="mt-2 grid gap-2 text-base">
          <a href="cats.html" class="block px-2 py-2 rounded-lg hover:bg-gray-100">æˆ‘æƒ³é¤Šè²“å’ª</a>
          <a href="dogs.html" class="block px-2 py-2 rounded-lg hover:bg-gray-100">æˆ‘æƒ³é¤Šç‹—ç‹—</a>
          <a href="about.html" class="block px-2 py-2 rounded-lg hover:bg-gray-100">é—œæ–¼ç°¡åª½åª½</a>
          <a href="admin.html" class="block px-2 py-2 rounded-lg bg-gray-100 text-brand-700 font-semibold">ç®¡ç†å“¡</a>
          <button id="btnRefreshSm" class="mt-2 px-3 py-2 rounded-xl border border-gray-300 text-sm w-full">é‡æ–°è¼‰å…¥</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
    <h1 class="text-xl sm:text-2xl font-bold mb-4">æ–°å¢ï¼ç®¡ç†å‹•ç‰©è³‡æ–™</h1>

    <div class="grid lg:grid-cols-3 gap-6">
      <!-- å·¦ï¼šç™»éŒ„è¡¨å–® -->
      <section class="lg:col-span-1 bg-white rounded-2xl ring-1 ring-gray-200 shadow-soft p-5">
        <h2 class="text-lg font-semibold">ç™»éŒ„è¡¨å–®</h2>
        <p class="text-sm text-gray-500 mb-4">ï¼Šå»ºè­°å…ˆç™»å…¥ä¸¦åœ¨ Firestore è¦å‰‡é™åˆ¶å¯«å…¥æ¬Šé™ã€‚</p>
        <form id="petForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">åå­— <span class="text-red-500">*</span></label>
            <input id="name" class="w-full rounded-xl border border-gray-300 p-2" placeholder="ä¾‹ï¼šæ©˜å­" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">é¡åˆ¥ <span class="text-red-500">*</span></label>
            <div class="flex gap-3">
              <label class="inline-flex items-center gap-2"><input type="radio" name="species" value="è²“" class="accent-brand-600" checked><span>è²“</span></label>
              <label class="inline-flex items-center gap-2"><input type="radio" name="species" value="ç‹—" class="accent-brand-600"><span>ç‹—</span></label>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">å“ç¨®</label>
              <select id="breedType" class="w-full rounded-xl border border-gray-300 bg-white p-2 text-sm">
                <option value="">è«‹é¸æ“‡</option>
              </select>
            </div>
            <div>
              <label id="breedLabel" class="block text-sm font-medium mb-1">å“ç¨®/æ¯›è‰²</label>
              <select id="breed" class="w-full rounded-xl border border-gray-300 bg-white p-2 text-sm" disabled>
                <option value="">è«‹å…ˆé¸æ“‡å“ç¨®</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">å¹´é½¡</label>
              <input id="age" class="w-full rounded-xl border border-gray-300 p-2" placeholder="ä¾‹ï¼š2 æ­² æˆ– 8 å€‹æœˆ" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">æ€§åˆ¥</label>
              <select id="gender" class="w-full rounded-xl border border-gray-300 p-2">
                <option value="">æœªè¨­å®š</option>
                <option value="ç”·ç”Ÿ">ç”·ç”Ÿ</option>
                <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ç°¡ä»‹</label>
            <textarea id="desc" rows="4" class="w-full rounded-xl border border-gray-300 p-2" placeholder="å€‹æ€§ã€æ•‘æ´èƒŒæ™¯ã€æ³¨æ„äº‹é …â€¦"></textarea>
          </div>
          <div>
            <div class="flex items-center justify-between mb-1">
              <label class="block text-sm font-medium">åœ–ç‰‡</label>
              <span id="fileCount" class="text-xs text-gray-500">å·²é¸ 0 / 5 å¼µ</span>
            </div>
            <input id="imgFiles" type="file" accept="image/*" multiple class="sr-only" />
            <div class="flex items-center gap-3">
              <button id="btnPick" type="button" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">é¸æ“‡æª”æ¡ˆ</button>
              <span class="text-sm text-gray-400">å¯å¤šæ¬¡é¸å–ç›´è‡³ 5 å¼µ</span>
            </div>
            <div id="imgPreview" class="mt-3 grid grid-cols-3 gap-2"></div>
          </div>
          <div class="flex gap-3 pt-2">
            <button id="submitBtn" type="submit" class="px-4 py-2 rounded-xl bg-gray-900 text-white hover:bg-gray-800 flex items-center gap-2">
              <span id="submitText">ç™»éŒ„</span>
            </button>
          </div>
        </form>
      </section>

      <!-- å³ï¼šè³‡æ–™è¡¨ -->
      <section class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-2xl ring-1 ring-gray-200 shadow-soft p-5">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <h2 class="text-lg font-semibold">è³‡æ–™è¡¨</h2>
            <div class="relative w-full sm:w-72">
              <input id="searchName" class="w-full rounded-xl border border-gray-300 p-2 pl-9 text-sm" placeholder="æœå°‹åå­—â€¦" />
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">ğŸ”</span>
            </div>
          </div>
          <div class="hidden md:block overflow-x-auto mt-4">
            <table class="min-w-[640px] w-full text-sm">
              <thead>
                <tr class="text-left text-gray-500">
                  <th class="py-2">åå­—</th>
                  <th class="py-2">é¡åˆ¥</th>
                  <th class="py-2">å“ç¨®</th>
                  <th class="py-2">æ€§åˆ¥</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
          <div class="md:hidden mt-4 grid gap-3" id="rowsMobile"></div>
        </div>
      </section>
    </div>
  </main>

  <footer class="bg-gray-50 border-t border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-sm text-gray-500">
      Â© <span id="year"></span> æµªæµªè½‰é‹ç«™ StrayStation. ä¿ç•™æ‰€æœ‰æ¬Šåˆ©ã€‚
    </div>
  </footer>

  <!-- è©³ç´°è³‡æ–™ Modal -->
  <dialog id="petDialog" class="w-full max-w-2xl max-h-[90vh] rounded-2xl p-0 overflow-y-auto">
    <div class="bg-white">
      <div class="px-3 pt-3">
        <div class="relative aspect-video bg-gray-100 overflow-hidden rounded-lg">
          <img id="dlgBg" aria-hidden="true" class="absolute inset-0 w-full h-full object-cover blur-md scale-110">
          <div class="absolute inset-0 bg-white/20"></div>
          <img id="dlgImg" alt="æ¯›å­©ç…§ç‰‡" class="relative z-10 block w-full h-full object-contain cursor-pointer rounded-lg">
          <button id="dlgClose" class="absolute top-3 right-3 z-20 bg-black/60 text-white p-2 rounded-full" aria-label="é—œé–‰">âœ•</button>
        </div>
      </div>

      <div id="dlgThumbs" class="flex gap-2 overflow-x-auto p-3"></div>
      <div class="p-5 space-y-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="flex items-end justify-between gap-2">
              <h3 id="dlgName" class="text-2xl font-semibold leading-snug">â€”</h3>
              <span id="dlgSpeciesPill" class="shrink-0 rounded-full text-sm px-2 py-1 bg-emerald-50 text-emerald-700">è²“å’ª</span>
            </div>
            <div id="dlgTags" class="mt-1 flex flex-nowrap gap-2 text-sm">
              <span id="dlgTagBreed" class="inline-flex items-center rounded-full ring-1 ring-gray-300 bg-orange-100 text-orange-700 px-3 py-1 whitespace-nowrap"></span>
              <span id="dlgTagAge" class="inline-flex items-center rounded-full ring-1 ring-gray-300 bg-orange-100 text-orange-700 px-3 py-1 whitespace-nowrap"></span>
              <span id="dlgTagGender" class="inline-flex items-center rounded-full ring-1 ring-gray-300 bg-orange-100 text-orange-700 px-3 py-1 whitespace-nowrap"></span>
            </div>
          </div>
        </div>
        <div class="bg-orange-50 rounded-xl p-4 leading-7">
          <p id="dlgDesc" class="text-gray-700 text-sm whitespace-pre-line break-words"></p>
        </div>

        <!-- å…§åµŒç·¨è¼¯å€ -->
        <div id="editArea" class="hidden space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">åå­—</label>
              <input id="editName" class="w-full rounded-xl border border-gray-300 p-2" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">å¹´é½¡</label>
              <input id="editAge" class="w-full rounded-xl border border-gray-300 p-2" />
            </div>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">é¡åˆ¥</label>
              <select id="editSpecies" class="w-full rounded-xl border border-gray-300 p-2">
                <option value="è²“">è²“</option>
                <option value="ç‹—">ç‹—</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">å“ç¨®</label>
              <select id="editBreedType" class="w-full rounded-xl border border-gray-300 p-2">
                <option value="">è«‹é¸æ“‡</option>
              </select>
            </div>
            <div>
              <label id="editBreedLabel" class="block text-sm font-medium mb-1">å“ç¨®/æ¯›è‰²</label>
              <select id="editBreed" class="w-full rounded-xl border border-gray-300 p-2" disabled>
                <option value="">è«‹å…ˆé¸æ“‡å“ç¨®</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium mb-1">æ€§åˆ¥</label>
              <select id="editGender" class="w-full rounded-xl border border-gray-300 p-2">
                <option value="">æœªè¨­å®š</option>
                <option value="ç”·ç”Ÿ">ç”·ç”Ÿ</option>
                <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">â€”</label>
              <div class="text-sm text-gray-400">&nbsp;</div>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ç°¡ä»‹</label>
            <textarea id="editDesc" rows="4" class="w-full rounded-xl border border-gray-300 p-2"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">åœ–ç‰‡ï¼ˆå¯å¢åˆªï¼Œæœ€å¤š 5 å¼µï¼‰</label>
            <input id="editFiles" type="file" accept="image/*" multiple class="sr-only" />
            <div class="flex items-center gap-3 mb-2">
              <button id="btnPickEdit" type="button" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">æ–°å¢åœ–ç‰‡</button>
              <span id="editCount" class="text-xs text-gray-500"></span>
            </div>
            <div id="editPreview" class="grid grid-cols-4 gap-2"></div>
          </div>
        </div>

        <!-- å‹•ä½œåˆ— -->
        <div id="actionBar" class="pt-2 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <button id="btnEdit" class="w-full px-4 py-3 rounded-xl border border-gray-300 text-sm">ç·¨è¼¯</button>
          <button id="btnAdopted" class="w-full px-4 py-3 rounded-xl bg-emerald-600 text-white text-sm">å·²é ˜é¤Š</button>
          <button id="btnDelete" class="w-full px-4 py-3 rounded-xl border border-red-300 text-red-600 text-sm">åˆªé™¤</button>
        </div>
        <div id="editActionBar" class="hidden pt-2 grid grid-cols-2 gap-3">
          <button id="btnSave" class="w-full px-4 py-3 rounded-xl bg-gray-900 text-white text-sm flex items-center justify-center gap-2">
            <span id="saveText">å„²å­˜</span>
          </button>
          <button id="btnCancel" class="w-full px-4 py-3 rounded-xl border border-gray-300 text-sm">å–æ¶ˆ</button>
        </div>

        <!-- å·²é ˜é¤Šåˆç…§ä¸Šå‚³ -->
        <div id="adoptedUpload" class="hidden">
          <label class="block text-sm font-medium mb-1">ä¸Šå‚³é ˜é¤Šåˆç…§ï¼ˆæœ€å¤š 5 å¼µï¼‰</label>
          <input id="adoptedFiles" type="file" accept="image/*" multiple class="sr-only" />
          <div class="flex items-center gap-3 mb-2">
            <button id="btnPickAdopted" type="button" class="px-3 py-2 rounded-lg border border-gray-300 text-sm">é¸æ“‡åˆç…§</button>
            <span id="adoptedCount" class="text-xs text-gray-500"></span>
          </div>
          <div id="adoptedPreview" class="mt-1 grid grid-cols-3 gap-2"></div>
          <button id="btnConfirmAdopted" class="mt-3 px-4 py-2 rounded-xl bg-gray-900 text-white text-sm">å„²å­˜é ˜é¤Šè³‡è¨Š</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 z-[99999] bg-black/90 hidden items-center justify-center">
  <div id="lbBackdrop" class="absolute inset-0"></div>
    <button id="lbPrev"
          class="absolute left-3 md:left-10 text-white text-4xl select-none z-[100002]">â®</button>
    <img id="lbImg"
       class="relative z-[100001] max-h-[90vh] max-w-[90vw] object-contain rounded-lg" />
    <div id="lbThumbs"
       class="absolute bottom-4 left-0 w-full z-[100003] pointer-events-auto">
      <div id="lbThumbsInner"
         class="mx-auto w-max flex gap-3 overflow-x-auto px-4 py-2
                bg-black/30 backdrop-blur-sm rounded-xl"></div>
    </div>
    <button id="lbNext"
          class="absolute right-3 md:right-10 text-white text-4xl select-none z-[100002]">â¯</button>

  </div>

  <script type="module">
    history.scrollRestoration = 'manual';
    window.scrollTo(0, 0);
    const y = document.getElementById('year'); if (y) y.textContent = new Date().getFullYear();

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, deleteDoc, doc, updateDoc, limit as fbLimit, where } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js';

    const firebaseConfig = { apiKey: 'AIzaSyC4NT2KOm_Cw2OEdaaOimxI0ruoNv_u_9g', authDomain: 'straystation.firebaseapp.com', projectId: 'straystation', storageBucket: 'straystation.firebasestorage.app', messagingSenderId: '611366379195', appId: '1:611366379195:web:ef5a632e88d8bba1d6139e' };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const $ = (q) => document.querySelector(q);
    const BREEDS = {
      è²“: { 'å“ç¨®è²“': ['ç¾çŸ­','è‹±çŸ­','è—è²“','æš¹ç¾…è²“','æ³¢æ–¯è²“','å¸ƒå¶è²“','æ›¼èµ¤è‚¯'], ç±³å…‹æ–¯: ['æ©˜è²“','é»‘è²“','è™æ–‘è²“','ç™½åº•è™æ–‘è²“','ä¸‰èŠ±è²“','è³“å£«è²“','ç³ç‘è²“','ç™½è²“'] },
      ç‹—: { 'å“ç¨®çŠ¬': ['åšç¾','è²´è³“','å‰å¨ƒå¨ƒ','é¦¬çˆ¾æ¿Ÿæ–¯','æŸ¯åŸº','æŸ´çŠ¬','å“ˆå£«å¥‡','é«˜å±±çŠ¬','é»ƒé‡‘çµçŠ¬'], ç±³å…‹æ–¯: ['é»‘è‰²','é»‘ç™½è‰²','ç™½è‰²','ç™½é»ƒè‰²','é»ƒè‰²','æ£•è‰²','è™æ–‘','èŠ±èŠ±'] }
    };

    // === é¡åˆ¥/å“ç¨®é€£å‹• ===
    const speciesInputs = document.querySelectorAll('input[name="species"]');
    const breedTypeSel = $('#breedType');
    const breedSel = $('#breed');
    const breedLabel = $('#breedLabel');
    const getSpecies = () => (Array.from(speciesInputs).find(i=>i.checked)?.value || 'è²“');
    const updateBreedLabel = () => { const t = breedTypeSel.value; breedLabel.textContent = !t ? 'å“ç¨®/æ¯›è‰²' : (t==='ç±³å…‹æ–¯'?'æ¯›è‰²':'å“ç¨®'); };
    const resetBreedRight = () => { breedSel.disabled = true; breedSel.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡å“ç¨®</option>'; };
    // é˜²æ­¢ç€è¦½å™¨è‡ªå‹•å¸¶å€¼æˆ– bfcache è®“ select åœåœ¨éç©º
    window.addEventListener('DOMContentLoaded', () => {
      // è‹¥ä½ è¡¨å–® id ç‚º petFormï¼Œå¯å…ˆ reset ä¸€æ¬¡é¿å…è‡ªå‹•å¸¶å€¼
      document.getElementById('petForm')?.reset();

      // é‡æ–°å»ºç½®ä¸¦å¼·åˆ¶å›ç©º
      syncBreedSelectors();

      // å†ä¿éšªä¸€æ¬¡ï¼šç¢ºä¿å·¦é‚Šç‚ºç©ºã€å³é‚Šé—œé–‰ä¸”æ–‡å­—æ­£ç¢º
      breedTypeSel.value = '';
      resetBreedRight();         // å³ï¼š<option value="">è«‹å…ˆé¸æ“‡å“ç¨®</option> + disabled
      updateBreedLabel();        // æ¨™ç±¤é¡¯ç¤ºã€Œå“ç¨®/æ¯›è‰²ã€
    });

    // é‡å°è¿”å›ä¸Šä¸€é çš„ bfcache ä¹Ÿåšä¸€æ¬¡
    window.addEventListener('pageshow', (e) => {
      if (e.persisted) {
        syncBreedSelectors();
        breedTypeSel.value = '';
        resetBreedRight();
        updateBreedLabel();
      }
    });
    function syncBreedSelectors(){
      const isCat = getSpecies()==='è²“';
      breedTypeSel.innerHTML = isCat
        ? '<option value="">è«‹é¸æ“‡</option><option value="å“ç¨®è²“">å“ç¨®è²“</option><option value="ç±³å…‹æ–¯">ç±³å…‹æ–¯</option>'
        : '<option value="">è«‹é¸æ“‡</option><option value="å“ç¨®çŠ¬">å“ç¨®çŠ¬</option><option value="ç±³å…‹æ–¯">ç±³å…‹æ–¯</option>';
      // å¼·åˆ¶å›åˆ°ç©ºå€¼
      breedTypeSel.value = '';
      resetBreedRight();
      updateBreedLabel();
    }
    function buildBreedOptions(){ const list=(BREEDS[getSpecies()]||{})[breedTypeSel.value]||[]; if(!breedTypeSel.value){ resetBreedRight(); return;} breedSel.disabled=false; breedSel.innerHTML=['<option value="">è«‹é¸æ“‡</option>'].concat(list.map(b=>`<option value="${b}">${b}</option>`)).join(''); }
    speciesInputs.forEach(i=>i.addEventListener('change',syncBreedSelectors));
    breedTypeSel.addEventListener('change',()=>{ buildBreedOptions(); updateBreedLabel(); });
    syncBreedSelectors();

    // === åœ–ç‰‡é¸å–/é è¦½ï¼ˆ<=5ï¼‰ ===
    const imgFiles=$('#imgFiles'), btnPick=$('#btnPick'), fileCount=$('#fileCount'), imgPreview=$('#imgPreview');
    let selectedFiles=[]; btnPick?.addEventListener('click',()=>imgFiles.click());
    function renderPreviews(){ fileCount.textContent=`å·²é¸ ${selectedFiles.length} / 5 å¼µ`; imgPreview.innerHTML=selectedFiles.map((f,i)=>{ const u=URL.createObjectURL(f); return `<div class="relative"><img class="w-full aspect-square object-cover rounded-lg" src="${u}" alt="é è¦½"><button data-idx="${i}" class="absolute top-1 right-1 bg-black/70 text-white rounded-full w-7 h-7 flex items-center justify-center">âœ•</button></div>`;}).join(''); imgPreview.querySelectorAll('button[data-idx]').forEach(btn=>btn.addEventListener('click',e=>{ e.preventDefault();e.stopPropagation(); const i=+btn.dataset.idx; selectedFiles.splice(i,1); renderPreviews(); })); }
    imgFiles?.addEventListener('change',()=>{ const incoming=Array.from(imgFiles.files||[]); const next=selectedFiles.concat(incoming); if(next.length>5){ Swal.fire({icon:'warning',title:'æœ€å¤šé¸å– 5 å¼µ'});} selectedFiles=next.slice(0,5); renderPreviews(); imgFiles.value=''; });

    // === é»é»é€²åº¦ ===
    function startDots(span, base){ let i=0; span.textContent=base; const t=setInterval(()=>{ i=(i+1)%4; span.textContent=base+'.'.repeat(i); },350); return ()=>clearInterval(t); }

    // === ç™»éŒ„ ===
$('#petForm').addEventListener('submit', async (e)=>{
  e.preventDefault();

  const name = ($('#name')?.value || '').trim();
  if (!name) {
    await Swal.fire({icon:'error', title:'è«‹å¡«åå­—'});
    return;
  }

  const payload = {
    species: getSpecies(),
    name,
    breedType: breedTypeSel.value || '',
    breed: breedSel.value || '',
    age: ($('#age')?.value || '').trim(),
    gender: $('#gender')?.value || '',
    desc: ($('#desc')?.value || '').trim(),
    images: [],
    status: 'available',
    showOnHome:false, showOnCats:true, showOnDogs:true, showOnIndex:true,
    createdAt: serverTimestamp()
  };

  // åç¨±é‡è¤‡ç¢ºèªï¼ˆä¿ç•™ä½ çš„éœ€æ±‚ï¼‰
  try {
    const dupQ = query(collection(db,'pets'), where('name','==', name));
    const dupSnap = await getDocs(dupQ);
    if (!dupSnap.empty) {
      const r = await Swal.fire({
        icon:'question',
        title:`åå­—ã€Œ${name}ã€å·²å­˜åœ¨ï¼Œä»è¦æ–°å¢å—ï¼Ÿ`,
        showCancelButton:true, confirmButtonText:'ç¹¼çºŒæ–°å¢', cancelButtonText:'å–æ¶ˆ'
      });
      if (!r.isConfirmed) return;
    }
  } catch(_) {}

  const submitBtn = $('#submitBtn');
  const submitText = $('#submitText');
  submitBtn.disabled = true;
  const stopDots = startDots(submitText, 'ç™»éŒ„ä¸­');

  try {
    // æ–°å¢æ–‡ä»¶
    const docRef = await addDoc(collection(db,'pets'), payload);

    // ä¸Šå‚³åœ–ç‰‡ä¸¦å›å¯« URLs
    const urls = [];
    for (const f of selectedFiles) {
      const path = `pets/${docRef.id}/${Date.now()}_${f.name}`;
      const r = sRef(storage, path);
      await uploadBytes(r, f);
      urls.push(await getDownloadURL(r));
    }
    if (urls.length) {
      await updateDoc(doc(db,'pets', docRef.id), { images: urls });
    }

    // UI å¾©ä½
    stopDots();
    submitBtn.disabled = false;
    submitText.textContent = 'ç™»éŒ„';

    // ç«‹åˆ»é–‹ modal æª¢è¦–æ–°è³‡æ–™
    const newPet = { id: docRef.id, ...payload, images: urls };
    openDialog(newPet);

    // æ¸…è¡¨å–®
    e.target.reset();
    imgPreview.innerHTML = '';
    selectedFiles = [];
    fileCount.textContent = 'å·²é¸ 0 / 5 å¼µ';
    syncBreedSelectors();          // å›åˆ°ã€Œè«‹é¸æ“‡ã€

    await loadPets();
    await Swal.fire({icon:'success', title:'å·²ç™»éŒ„æˆåŠŸï¼'});
  } catch (err) {
    stopDots();
    submitBtn.disabled = false;
    submitText.textContent = 'ç™»éŒ„';
    await Swal.fire({icon:'error', title:'ç™»éŒ„å¤±æ•—', text: err.message});
  }
});

    // === è³‡æ–™è¡¨ + æœå°‹ ===
    let allList=[]; async function loadPets(){ const snap=await getDocs(query(collection(db,'pets'), orderBy('createdAt','desc'), fbLimit(15))); allList=snap.docs.map(d=>({id:d.id,...d.data()})); applyFilterAndRender(); }
    const searchInput=$('#searchName'); searchInput.addEventListener('input',()=>applyFilterAndRender());
    const displayBreed=p=> ( (p.breedType==='å“ç¨®çŠ¬'||p.breedType==='å“ç¨®è²“') && p.breed ) ? p.breed : (p.breedType==='ç±³å…‹æ–¯' ? (p.breed?`ç±³å…‹æ–¯/${p.breed}`:'ç±³å…‹æ–¯') : (p.breed||'â€”') );
    function applyFilterAndRender(){ const kw=searchInput.value.trim().toLowerCase(); const list=kw?allList.filter(p=>String(p.name||'').toLowerCase().includes(kw)):allList; renderRows(list); renderRowsMobile(list); }
    function renderRows(list){ const tb=document.getElementById('rows'); if(!tb) return; tb.innerHTML=list.map(p=>`<tr class="border-t hover:bg-gray-50 cursor-pointer" data-id="${p.id}"><td class="py-2 pr-2 font-medium">${p.name||'â€”'}</td><td class="py-2 pr-2">${p.species||'â€”'}</td><td class="py-2 pr-2">${displayBreed(p)}</td><td class="py-2 pr-2">${p.gender||'â€”'}</td></tr>`).join(''); tb.querySelectorAll('tr').forEach(tr=>tr.addEventListener('click',()=>{ const id=tr.dataset.id; const data=list.find(p=>p.id===id); if(data) openDialog(data);})); }
    function renderRowsMobile(list){ const wrap=document.getElementById('rowsMobile'); if(!wrap) return; wrap.innerHTML=list.map(p=>{ const img=(Array.isArray(p.images)&&p.images[0])||p.image||''; return `<div class="rounded-xl ring-1 ring-gray-200 p-3 flex gap-3 items-center cursor-pointer" data-id="${p.id}"><img src="${img}" class="w-16 h-16 object-cover rounded-lg bg-gray-100"><div class="min-w-0 flex-1"><div class="font-semibold truncate">${p.name||'æœªå‘½å'}</div><div class="text-xs text-gray-600 mt-1 truncate">${p.species||'â€”'}ãƒ»${displayBreed(p)}ãƒ»${p.gender||'â€”'}</div></div></div>`; }).join(''); wrap.querySelectorAll('[data-id]').forEach(card=>card.addEventListener('click',()=>{ const id=card.dataset.id; const data=list.find(p=>p.id===id); if(data) openDialog(data);})); }

    // === Modal / Lightbox ===
    const dlg=document.getElementById('petDialog');
    const lb=document.getElementById('lightbox');
    const lbImg=document.getElementById('lbImg');
    const lbPrev=document.getElementById('lbPrev');
    const lbNext=document.getElementById('lbNext');
    const lbBackdrop=document.getElementById('lbBackdrop');
    const lbThumbsEl=document.getElementById('lbThumbs');

    let lbImages=[], lbIndex=0, oldHtmlOverflow='', currentDocId=null, currentDoc=null, dlgWasOpenForLb=false, closingForLightbox=false;

    function openDialog(p){
      currentDoc=p; currentDocId=p.id;
      renderDialogView(p);
      if(typeof dlg.showModal==='function') dlg.showModal(); else dlg.setAttribute('open','');
      oldHtmlOverflow=document.documentElement.style.overflow;
      document.documentElement.style.overflow='hidden';
    }

    function renderDialogView(p){
      const imgs=Array.isArray(p.images)&&p.images.length?p.images:(p.image?[p.image]:[]);
      const first=imgs[0]||'';
      document.getElementById('dlgBg').src=first;
      document.getElementById('dlgImg').src=first;
      lbImages=imgs; lbIndex=0;
      document.getElementById('dlgName').textContent=p.name||'æœªå‘½å';
      document.getElementById('dlgSpeciesPill').textContent=/(ç‹—|çŠ¬)/.test(String(p.species||''))?'ç‹—ç‹—':'è²“å’ª';
      document.getElementById('dlgTagBreed').textContent=displayBreed(p);
      document.getElementById('dlgTagAge').textContent=(p.age&&p.age.trim()!=='')?p.age:'å¹´é½¡ä¸è©³';
      document.getElementById('dlgTagGender').textContent=p.gender||'â€”';
      document.getElementById('dlgDesc').textContent=p.desc||p.description||'';
      const thumbs=document.getElementById('dlgThumbs'); thumbs.innerHTML='';
      imgs.forEach((src,i)=>{ const im=document.createElement('img'); im.src=src; im.alt='ç¸®åœ–'; im.className='dlg-thumb'+(i===0?' active':''); im.addEventListener('click',()=>setMainImage(i,imgs)); thumbs.appendChild(im); });
      highlightDlgThumb(0);

      // ç·¨è¼¯å€åŒæ­¥
      document.getElementById('editName').value=p.name||'';
      document.getElementById('editAge').value=p.age||'';
      document.getElementById('editGender').value=p.gender||'';
      document.getElementById('editDesc').value=p.desc||'';
      document.getElementById('editSpecies').value=p.species||'è²“';
      syncEditBreedSelectors();
      if(p.breedType){
        document.getElementById('editBreedType').value=p.breedType;
        buildEditBreedOptions();
        updateEditBreedLabel();
        if(p.breed){ document.getElementById('editBreed').disabled=false; document.getElementById('editBreed').value=p.breed; }
      }
      renderEditImages(imgs);
      setEditMode(false);
      bindDialogActions();
    }

    document.getElementById('dlgClose').addEventListener('click',()=>{
      if (dlg.open) dlg.close();
      document.documentElement.style.overflow=oldHtmlOverflow;
    });
    if (dlg) {
      dlg.addEventListener('close',()=>{
        if (!closingForLightbox) {
          document.documentElement.style.overflow=oldHtmlOverflow;
        }
      });
    }

    // é–‹å¤§åœ–
    document.getElementById('dlgImg').addEventListener('click',()=>{
      // è¨˜ä½ï¼šç•¶å‰æ˜¯å¦ç‚ºç”± dialog é€²å…¥ lightbox
      dlgWasOpenForLb = !!dlg.open;
      if(dlg.open) { closingForLightbox = true; dlg.close(); closingForLightbox = false; }
      openLightbox(lbIndex);
    });

    function openLightbox(startIndex = 0){
      lb.classList.remove('hidden');
      lb.style.display = 'flex';
      lbShow(startIndex);
    }
    function closeLightbox(){
      lb.classList.add('hidden');
      lb.style.display='none';
      // åªæœ‰å¾ dialog é€²ä¾†æ™‚æ‰å›åˆ° dialog
      if (dlgWasOpenForLb && typeof dlg.showModal === 'function') {
        dlg.showModal();
      }
      dlgWasOpenForLb = false;
    }

    function lbShow(idx){ if(!lbImages.length) return; lbIndex=(idx+lbImages.length)%lbImages.length; lbImg.src=lbImages[lbIndex]; const thumbs=document.getElementById('lbThumbsInner'); thumbs.innerHTML=lbImages.map((src,i)=>`<img src="${src}" class="${i===lbIndex?'active':''}">`).join(''); thumbs.querySelectorAll('img').forEach((im,i)=>im.addEventListener('click',(e)=>{ e.stopPropagation(); lbShow(i); })); }
    lbPrev.addEventListener('click',(e)=>{ e.stopPropagation(); lbShow(lbIndex-1); }); lbNext.addEventListener('click',(e)=>{ e.stopPropagation(); lbShow(lbIndex+1); });

    // é—œé–‰æ¢ä»¶ï¼šé»èƒŒæ™¯ã€é»å®¹å™¨ç©ºç™½ã€Esc
    lbBackdrop.addEventListener('click', closeLightbox);
    lb.addEventListener('click', (e) => {
      const clickOnImage  = e.target === lbImg;
      const clickOnArrow  = e.target === lbPrev || e.target === lbNext;
      if (e.target === lb) { closeLightbox(); }
      else if (!clickOnImage && !clickOnArrow) {
        // ä¸æ˜¯é»å¤§åœ–/ç®­é ­ï¼ˆä¾‹å¦‚ç©ºç™½å€ï¼‰ï¼Œæ‰é—œé–‰
        if (!lbThumbsEl.contains(e.target)) closeLightbox();
      }
    });
    // é˜²æ­¢é»ç¸®åœ–å€è¢«çˆ¶å±¤æŠ“åˆ°è€Œé—œé–‰
    lbThumbsEl.addEventListener('click', (e)=>{ e.stopPropagation(); });

    window.addEventListener('keydown',(e)=>{ if(lb.classList.contains('hidden')) return; if(e.key==='Escape') closeLightbox(); if(e.key==='ArrowLeft') lbShow(lbIndex-1); if(e.key==='ArrowRight') lbShow(lbIndex+1); });
    let touchX=null; lb.addEventListener('touchstart',e=>{ touchX=e.changedTouches[0].clientX; },{passive:true}); lb.addEventListener('touchend',e=>{ if(touchX===null) return; const dx=e.changedTouches[0].clientX-touchX; if(Math.abs(dx)>50){ if(dx<0) lbShow(lbIndex+1); else lbShow(lbIndex-1);} touchX=null; });

    function bindDialogActions(){ document.getElementById('btnDelete').onclick=onDelete; document.getElementById('btnEdit').onclick=()=>setEditMode(true); document.getElementById('btnAdopted').onclick=()=>{ document.getElementById('adoptedUpload').classList.remove('hidden'); }; document.getElementById('btnPickAdopted').onclick=()=>document.getElementById('adoptedFiles').click(); document.getElementById('btnConfirmAdopted').onclick=onConfirmAdopted; document.getElementById('btnSave').onclick=saveEdit; document.getElementById('btnCancel').onclick=()=>{ renderDialogView(currentDoc); }; }

    async function onDelete(){ const wasOpen=dlg.open; if(wasOpen) dlg.close(); const ok=await Swal.fire({icon:'warning',title:'ç¢ºèªåˆªé™¤æ­¤ç­†ï¼Ÿ',showCancelButton:true,confirmButtonText:'åˆªé™¤',cancelButtonText:'å–æ¶ˆ'}); if(!ok.isConfirmed){ if(wasOpen) dlg.showModal(); return; } try{ await deleteDoc(doc(db,'pets',currentDocId)); await loadPets(); await Swal.fire({icon:'success',title:'åˆªé™¤æˆåŠŸ',timer:1000,showConfirmButton:false}); }catch(err){ await Swal.fire({icon:'error',title:'åˆªé™¤å¤±æ•—',text:err.message}); if(wasOpen) dlg.showModal(); } }

    function setEditMode(on){ document.getElementById('editArea').classList.toggle('hidden',!on); document.getElementById('actionBar').classList.toggle('hidden',on); document.getElementById('editActionBar').classList.toggle('hidden',!on); if(on){ document.getElementById('adoptedUpload').classList.add('hidden'); } }

    async function saveEdit(){
      const btn=document.getElementById('btnSave'), txt=document.getElementById('saveText');
      btn.disabled=true; const stopDots=startDots(txt,'å„²å­˜ä¸­');
      const newData={ name:document.getElementById('editName').value.trim(), age:document.getElementById('editAge').value.trim(), gender:document.getElementById('editGender').value, desc:document.getElementById('editDesc').value.trim(), species:document.getElementById('editSpecies').value, breedType:document.getElementById('editBreedType').value||'', breed:document.getElementById('editBreed').value||'' };
      try{
        const {keep,add,remove}=editImagesState; const newUrls=[...keep];
        for(const f of add){ const path=`pets/${currentDocId}/${Date.now()}_${f.name}`; const r=sRef(storage,path); await uploadBytes(r,f); newUrls.push(await getDownloadURL(r)); }
        for(const url of remove){ try{ const path=url.split('/o/')[1].split('?')[0]; await deleteObject(sRef(storage, decodeURIComponent(path))); }catch(e){} }
        newData.images=newUrls;
        await updateDoc(doc(db,'pets',currentDocId), newData);
        await loadPets();
        currentDoc={...currentDoc,...newData};
        stopDots(); btn.disabled=false; txt.textContent='å„²å­˜';
        const wasOpen=dlg.open; if(wasOpen) dlg.close();
        await Swal.fire({icon:'success',title:'å·²å„²å­˜'});
        if(wasOpen) dlg.showModal();
        setEditMode(false); renderDialogView(currentDoc);
      }catch(err){
        stopDots(); btn.disabled=false; txt.textContent='å„²å­˜';
        await Swal.fire({icon:'error',title:'æ›´æ–°å¤±æ•—',text:err.message});
      }
    }

    // ç·¨è¼¯æ¨¡å¼ï¼šå“ç¨®é€£å‹•
    const editSpeciesSel=$('#editSpecies'), editBreedTypeSel=$('#editBreedType'), editBreedSel=$('#editBreed'), editBreedLabel=$('#editBreedLabel');
    function updateEditBreedLabel(){ const t=editBreedTypeSel.value; editBreedLabel.textContent=!t?'å“ç¨®/æ¯›è‰²':(t==='ç±³å…‹æ–¯'?'æ¯›è‰²':'å“ç¨®'); }
    function resetEditBreedRight(){ editBreedSel.disabled=true; editBreedSel.innerHTML='<option value="">è«‹å…ˆé¸æ“‡å“ç¨®</option>'; }
    function syncEditBreedSelectors(){ const isCat=(editSpeciesSel.value==='è²“'); editBreedTypeSel.innerHTML=isCat?'<option value="">è«‹é¸æ“‡</option><option value="å“ç¨®è²“">å“ç¨®è²“</option><option value="ç±³å…‹æ–¯">ç±³å…‹æ–¯</option>':'<option value="">è«‹é¸æ“‡</option><option value="å“ç¨®çŠ¬">å“ç¨®çŠ¬</option><option value="ç±³å…‹æ–¯">ç±³å…‹æ–¯</option>'; resetEditBreedRight(); updateEditBreedLabel(); }
    function buildEditBreedOptions(){ const list=(BREEDS[editSpeciesSel.value]||{})[editBreedTypeSel.value]||[]; if(!editBreedTypeSel.value){ resetEditBreedRight(); return; } editBreedSel.disabled=false; editBreedSel.innerHTML=['<option value="">è«‹é¸æ“‡</option>'].concat(list.map(b=>`<option value="${b}">${b}</option>`)).join(''); }
    editSpeciesSel.addEventListener('change',syncEditBreedSelectors); editBreedTypeSel.addEventListener('change',()=>{ buildEditBreedOptions(); updateEditBreedLabel(); });

    // å…§åµŒç·¨è¼¯ï¼šåœ–ç‰‡ç®¡ç†
    const editFiles=$('#editFiles'), btnPickEdit=$('#btnPickEdit'), editPreview=$('#editPreview'), editCount=$('#editCount');
    let editImagesState={keep:[], add:[], remove:[]}; btnPickEdit.addEventListener('click',()=>editFiles.click());
    function renderEditImages(urls){ editImagesState.keep=[...urls]; editImagesState.add=[]; editImagesState.remove=[]; paintEditPreview(); }
    function paintEditPreview(){
      const total=editImagesState.keep.length+editImagesState.add.length; editCount.textContent=`å…± ${total} / 5 å¼µï¼ˆå«æ–°å¢ï¼‰`;
      const current=[...editImagesState.keep.map((u,i)=>({type:'keep',url:u,idx:i})), ...editImagesState.add.map((f,i)=>({type:'add',file:f,idx:i}))];
      editPreview.innerHTML=current.map(item=>{
        const src=item.type==='keep'?item.url:URL.createObjectURL(item.file);
        const data=item.type==='keep'?`data-keep="${item.idx}"`:`data-add="${item.idx}"`;
        return `<div class="relative"><img class="w-full aspect-square object-cover rounded-lg" src="${src}"/><button ${data} class="absolute top-1 right-1 bg-black/70 text-white rounded-full w-7 h-7 flex items-center justify-center">âœ•</button></div>`;
      }).join('');
      editPreview.querySelectorAll('button[data-keep]').forEach(btn=>btn.addEventListener('click',()=>{ const i=+btn.getAttribute('data-keep'); editImagesState.remove.push(editImagesState.keep[i]); editImagesState.keep.splice(i,1); paintEditPreview(); }));
      editPreview.querySelectorAll('button[data-add]').forEach(btn=>btn.addEventListener('click',()=>{ const i=+btn.getAttribute('data-add'); editImagesState.add.splice(i,1); paintEditPreview(); }));
    }
    editFiles.addEventListener('change',()=>{
      const incoming = Array.from(editFiles.files || []);
      const used = editImagesState.keep.length + editImagesState.add.length;
      if (used >= 5) {
        Swal.fire({icon:'warning', title:'æœ€å¤š 5 å¼µåœ–ç‰‡'});
        editFiles.value = '';
        return;
      }
      const room = 5 - used;
      if (incoming.length > room) {
        Swal.fire({icon:'warning', title:`æœ€å¤š 5 å¼µåœ–ç‰‡ï¼ˆæœ¬æ¬¡åªèƒ½å†é¸ ${room} å¼µï¼‰`});
      }
      editImagesState.add = editImagesState.add.concat(incoming.slice(0, Math.max(0, room)));
      paintEditPreview();
      editFiles.value = '';
    });

    // å·²é ˜é¤Šåˆç…§
    function updateAdoptedPreview(files){ const wrap=document.getElementById('adoptedPreview'); wrap.innerHTML=files.map(f=>`<img class="w-full aspect-square object-cover rounded-lg" src="${URL.createObjectURL(f)}"/>`).join(''); document.getElementById('adoptedCount').textContent=`å·²é¸ ${files.length} å¼µ`; }
    document.getElementById('adoptedFiles').addEventListener('change',()=>{ const fs=Array.from(document.getElementById('adoptedFiles').files||[]).slice(0,5); updateAdoptedPreview(fs); });
    async function onConfirmAdopted(){ const files=Array.from(document.getElementById('adoptedFiles').files||[]).slice(0,5); const urls=[]; try{ for(const f of files){ const path=`adopted/${currentDocId}/${Date.now()}_${f.name}`; const r=sRef(storage,path); await uploadBytes(r,f); urls.push(await getDownloadURL(r)); } await updateDoc(doc(db,'pets',currentDocId),{ status:'adopted', adoptedPhotos:urls, showOnHome:true, showOnCats:false, showOnDogs:false, showOnIndex:false }); Swal.fire({icon:'success',title:'å·²æ¨™è¨˜ç‚ºå·²é ˜é¤Š'}); await loadPets(); }catch(err){ Swal.fire({icon:'error',title:'é ˜é¤Šæ¨™è¨˜å¤±æ•—',text:err.message}); } }

    document.getElementById('btnRefreshSm')?.addEventListener('click',loadPets);
    document.getElementById('btnRefresh')?.addEventListener('click',loadPets);
    (async()=>{ try{ await loadPets(); }catch(e){ console.error('loadPets failed', e); } })();

    function highlightDlgThumb(i){
      const thumbs = document.querySelectorAll('#dlgThumbs .dlg-thumb');
      thumbs.forEach((el, idx) => {
        el.classList.toggle('active', idx === i);
      });
    }
    function setMainImage(i, imgs){
      const src = imgs[i];
      document.getElementById('dlgImg').src = src;
      document.getElementById('dlgBg').src = src;
      lbIndex = i;
      highlightDlgThumb(i);          // <== æ–°å¢ï¼šåŒæ­¥é«˜äº®
    }

    // ---- æ¸¬è©¦ ----
    (function selfTest(){
      const must=['rows','rowsMobile','petDialog','dlgImg','dlgBg','dlgName','dlgSpeciesPill','lightbox','lbBackdrop','dlgDesc'];
      const miss=must.filter(id=>!document.getElementById(id));
      console.assert(miss.length===0,'ç¼ºå°‘å¿…è¦ç¯€é»ï¼š',miss);
      console.assert(typeof closeLightbox==='function','closeLightbox æœªå®šç¾©');
      try { lbShow(0); } catch(err){ console.error('lbShow smoke test failed:', err); }
    })();

    (function extraTests(){
      try{
        const bt = document.getElementById('breedType');
        const bl = document.getElementById('breedLabel');
        bt.value = '';
        updateBreedLabel();
        console.assert(bl.textContent==='å“ç¨®/æ¯›è‰²','breedLabel é è¨­æ‡‰ç‚º å“ç¨®/æ¯›è‰²');
        bt.value = 'ç±³å…‹æ–¯';
        updateBreedLabel();
        console.assert(bl.textContent==='æ¯›è‰²','breedLabel ç±³å…‹æ–¯â†’ æ¯›è‰²');
        bt.value = 'å“ç¨®è²“';
        updateBreedLabel();
        console.assert(bl.textContent==='å“ç¨®','breedLabel å“ç¨®è²“â†’ å“ç¨®');
      }catch(e){ console.warn('extraTests skipped:', e?.message||e); }
    })();
  </script>
</body>
</html>
