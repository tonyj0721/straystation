<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æµªæµªè½‰é‹ç«™ï½œç®¡ç†å“¡æ–°å¢å‹•ç‰©è³‡æ–™</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

    // âš ï¸ æ›¿æ›ç‚ºä½ çš„ Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "ä½ çš„ API KEY",
      authDomain: "straystation.firebaseapp.com",
      projectId: "straystation",
      storageBucket: "straystation.firebasestorage.app",
      messagingSenderId: "611366379195",
      appId: "1:611366379195:web:ef5a632e88d8bba1d6139e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("addPetForm");
      const speciesSelect = document.getElementById("species");
      const breedTypeWrap = document.getElementById("breedTypeWrap");
      const breedType = document.getElementById("breedType");
      const breedWrap = document.getElementById("breedWrap");
      const breed = document.getElementById("breed");
      const photoInput = document.getElementById("photos");
      const preview = document.getElementById("preview");

      // ğŸ§¹ é‡ç½®å“ç¨®
      function resetBreed() {
        breedType.value = "";
        breed.innerHTML = "";
        breed.value = "";
        breedTypeWrap.classList.add("hidden");
        breedWrap.classList.add("hidden");
        breedType.disabled = true;
        breed.disabled = true;
      }

      // ğŸ¾ é¡åˆ¥é¸æ“‡
      speciesSelect.addEventListener("change", () => {
        if (speciesSelect.value === "è²“") {
          breedTypeWrap.classList.remove("hidden");
          breedType.disabled = false;
        } else {
          resetBreed();
        }
      });

      // ğŸ± å“ç¨®ç¬¬äºŒå±¤
      breedType.addEventListener("change", () => {
        breed.innerHTML = `<option value="">è«‹é¸æ“‡</option>`;
        let options = [];
        if (breedType.value === "å“ç¨®è²“") {
          options = ["ç¾çŸ­", "è‹±çŸ­", "è—è²“", "æš¹ç¾…è²“", "æ³¢æ–¯è²“", "å¸ƒå¶è²“", "æ›¼èµ¤è‚¯"];
        } else if (breedType.value === "ç±³å…‹æ–¯") {
          options = ["æ©˜è²“", "é»‘è²“", "è™æ–‘è²“", "ç™½åº•è™æ–‘è²“", "ä¸‰èŠ±è²“", "ç³ç‘è²“", "ç™½è²“"];
        }

        if (options.length > 0) {
          options.forEach((opt) => {
            const option = document.createElement("option");
            option.value = option.textContent = opt;
            breed.appendChild(option);
          });
          breedWrap.classList.remove("hidden");
          breed.disabled = false;
        } else {
          breedWrap.classList.add("hidden");
          breed.disabled = true;
        }
      });

      // ğŸ“¸ åœ–ç‰‡é è¦½
      photoInput.addEventListener("change", () => {
        preview.innerHTML = "";
        const files = Array.from(photoInput.files);

        if (files.length > 5) {
          alert("æœ€å¤šåªèƒ½ä¸Šå‚³ 5 å¼µåœ–ç‰‡ï¼");
          photoInput.value = "";
          return;
        }

        files.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const div = document.createElement("div");
            div.className = "relative inline-block m-1";
            div.innerHTML = `
              <img src="${e.target.result}" class="w-24 h-24 object-cover rounded border" />
              <button type="button" data-index="${index}" class="absolute top-0 right-0 bg-red-600 text-white text-xs px-1 rounded">âœ•</button>
            `;
            preview.appendChild(div);
          };
          reader.readAsDataURL(file);
        });
      });

      // ğŸ—‘ï¸ åˆªé™¤å–®å¼µé è¦½
      preview.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
          const index = parseInt(e.target.dataset.index);
          const files = Array.from(photoInput.files);
          files.splice(index, 1);

          // é‡æ–°å»ºä¸€å€‹ FileList
          const dt = new DataTransfer();
          files.forEach((f) => dt.items.add(f));
          photoInput.files = dt.files;

          // é‡æ–°è§¸ç™¼é è¦½æ›´æ–°
          const event = new Event("change");
          photoInput.dispatchEvent(event);
        }
      });

      // ğŸš€ é€å‡ºè¡¨å–®
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (speciesSelect.value !== "è²“") {
          breedType.value = "";
          breed.value = "";
        }

        const data = Object.fromEntries(new FormData(form).entries());
        const files = photoInput.files;
        const imageUrls = [];

        if (files.length > 5) {
          alert("æœ€å¤šåªèƒ½ä¸Šå‚³ 5 å¼µåœ–ç‰‡ï¼");
          return;
        }

        try {
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileRef = ref(storage, `pets/${Date.now()}_${file.name}`);
            await uploadBytes(fileRef, file);
            const url = await getDownloadURL(fileRef);
            imageUrls.push(url);
          }

          data.images = imageUrls;
          data.createdAt = serverTimestamp();

          await addDoc(collection(db, "pets"), data);
          alert(`ğŸ¾ å·²æˆåŠŸæ–°å¢ ${data.name}ï¼`);
          form.reset();
          preview.innerHTML = "";
          resetBreed();
        } catch (err) {
          console.error("âŒ æ–°å¢å¤±æ•—ï¼š", err);
          alert("ä¸Šå‚³æˆ–æ–°å¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Consoleã€‚");
        }
      });
    });
  </script>
</head>

<body class="p-6 bg-gray-50 font-sans">
  <h1 class="text-2xl font-bold mb-4">ğŸ¶ æ–°å¢æµªæµªè³‡æ–™</h1>

  <form id="addPetForm" class="grid gap-4 max-w-md bg-white p-6 rounded-lg shadow">
    <label>åå­—
      <input name="name" class="border rounded w-full p-2" required />
    </label>

    <label>é¡åˆ¥
      <select name="species" id="species" class="border rounded w-full p-2" required>
        <option value="">è«‹é¸æ“‡</option>
        <option value="è²“">è²“å’ª</option>
        <option value="ç‹—">ç‹—ç‹—</option>
      </select>
    </label>

    <div id="breedTypeWrap" class="hidden">
      <label>å“ç¨®é¡åˆ¥
        <select id="breedType" name="breedType" class="border rounded w-full p-2" disabled>
          <option value="">è«‹é¸æ“‡</option>
          <option value="å“ç¨®è²“">å“ç¨®è²“</option>
          <option value="ç±³å…‹æ–¯">ç±³å…‹æ–¯</option>
        </select>
      </label>
    </div>

    <div id="breedWrap" class="hidden">
      <label>å“ç¨®
        <select id="breed" name="breed" class="border rounded w-full p-2" disabled></select>
      </label>
    </div>

    <label>å¹´é½¡
      <input name="age" class="border rounded w-full p-2" />
    </label>

    <label>æ€§åˆ¥
      <select name="gender" class="border rounded w-full p-2">
        <option value="">è«‹é¸æ“‡</option>
        <option value="ç”·ç”Ÿ">ç”·ç”Ÿ</option>
        <option value="å¥³ç”Ÿ">å¥³ç”Ÿ</option>
      </select>
    </label>

    <label>ç°¡ä»‹
      <textarea name="desc" class="border rounded w-full p-2" rows="3"></textarea>
    </label>

    <label>ä¸Šå‚³ç…§ç‰‡ï¼ˆæœ€å¤š5å¼µï¼‰
      <input type="file" id="photos" accept="image/*" multiple class="border rounded w-full p-2" />
    </label>

    <!-- ç…§ç‰‡é è¦½å€ -->
    <div id="preview" class="flex flex-wrap mt-2"></div>

    <button class="bg-brand-500 hover:bg-brand-600 text-white py-2 rounded">æ–°å¢æµªæµª</button>
  </form>
</body>
</html>
