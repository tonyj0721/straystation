name: Deploy Firebase (Hosting + Functions)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # functions 相依：第一次沒有 lock 檔就用 install
      - name: Install Functions deps
        run: |
          cd functions
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # （可選）PR 預覽：不用 SA，也可以用 token 走 hosting channel
      - name: Hosting Preview (PR)
        if: github.event_name == 'pull_request'
        uses: w9jds/firebase-action@v15.2.1
        with:
          args: hosting:channel:deploy pr-${{ github.event.number }} --project ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

      # 正式部署（main）：Hosting + Functions
      - name: Deploy to Prod (main)
        if: github.event_name == 'push'
        uses: w9jds/firebase-action@v15.2.1
        with:
          args: deploy --only hosting,functions --project ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
