name: Deploy Firebase (Hosting + Functions)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # 安裝 functions 相依
      - name: Install Functions deps
        run: |
          cd functions
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      # PR：只做 Hosting Preview（不動 Functions）
      - name: Hosting Preview (PR)
        if: github.event_name == 'pull_request'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: pr-${{ github.event.number }}
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}

      # main：正式部署 Hosting + Functions
      - name: Deploy to Prod (main)
        if: github.event_name == 'push'
        uses: w9jds/firebase-action@v15.2.1   # 或至少用 v15
        with:
          args: deploy --only hosting,functions --project ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          # 建議用服務帳戶金鑰（JSON）而不是舊的 FIREBASE_TOKEN
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}

